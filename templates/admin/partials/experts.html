<!-- templates/admin/partials/experts.html -->
<div class="space-y-6">

    <!-- TIÊU ĐỀ + TAB CHUYỂN ĐỔI -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white p-4 rounded-xl shadow-sm">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-user-md mr-2 text-purple-600"></i>
                Quản lý Chuyên gia
            </h3>
            <p class="text-gray-500 text-sm mt-1">Phê duyệt yêu cầu và quản lý đội ngũ chuyên gia hiện có</p>
        </div>

        <!-- Tab Buttons -->
        <div class="flex bg-gray-100 rounded-lg p-1">
            <button onclick="switchTab('requests')" id="tab-requests"
                class="px-6 py-2 rounded-md text-sm font-semibold transition-all duration-300 flex items-center gap-2 bg-white text-purple-700 shadow-sm">
                <i class="fas fa-inbox"></i>
                Yêu cầu chờ duyệt
                {% if expert_requests %}
                <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">{{ expert_requests | length
                    }}</span>
                {% endif %}
            </button>
            <button onclick="switchTab('experts')" id="tab-experts"
                class="px-6 py-2 rounded-md text-sm font-semibold transition-all duration-300 flex items-center gap-2 text-gray-600 hover:text-gray-900">
                <i class="fas fa-users-cog"></i>
                Chuyên gia đã duyệt
                {% if verified_experts %}
                <span class="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded-full">{{ verified_experts |
                    length }}</span>
                {% endif %}
            </button>
        </div>
    </div>

    <!-- CONTENT AREA: TAB 1 - YÊU CẦU CHỜ DUYỆT -->
    <div id="content-requests" class="space-y-6">
        <div class="overflow-x-auto bg-white rounded-xl shadow">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-purple-50 to-pink-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Người dùng
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Lĩnh vực
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Thống kê
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Bằng cấp
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Ngày gửi
                        </th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Hành động
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for req in expert_requests_json %}
                    {% set total_posts = req.total_posts %}
                    {% set total_comments = req.total_comments %}
                    {% set avg_likes = req.avg_likes %}

                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <img class="h-12 w-12 rounded-full ring-2 ring-purple-200"
                                    src="{{ url_for('static', filename=req.user.avatar or 'images/default-avatar.png') }}"
                                    alt="{{ req.user.name }}">
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900">{{ req.user.name }}</div>
                                    <div class="text-sm text-gray-500">{{ req.user.email }}</div>
                                    <div class="text-xs text-purple-600 font-semibold mt-1">
                                        <i class="fas fa-star"></i> {{ req.user.points }} điểm
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                         {% if req.category == 'dinh_duong' %}bg-green-100 text-green-800
                                         {% elif req.category == 'suc_khoe' %}bg-blue-100 text-blue-800
                                         {% elif req.category == 'tam_ly' %}bg-purple-100 text-purple-800
                                         {% elif req.category == 'giao_duc' %}bg-yellow-100 text-yellow-800
                                         {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ req.category | replace('_', ' ') | title }}
                            </span>
                        </td>

                        <td class="px-6 py-4">
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Điểm:</span>
                                    <span class="font-semibold text-gray-700">{{ req.user.points }}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Nội dung:</span>
                                    <span
                                        class="font-bold {% if (total_posts + total_comments) >= 50 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ total_posts + total_comments }}
                                        {% if (total_posts + total_comments) >= 50 %}
                                        <i class="fas fa-check-circle ml-1"></i>
                                        {% else %}
                                        <i class="fas fa-times-circle ml-1"></i>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">TB like:</span>
                                    <span
                                        class="font-bold {% if avg_likes >= 5 %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ "%.1f"|format(avg_likes) }}
                                        {% if avg_likes >= 5 %}
                                        <i class="fas fa-check-circle ml-1"></i>
                                        {% else %}
                                        <i class="fas fa-times-circle ml-1"></i>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 text-center">
                            {% if req.certificate %}
                            <button
                                onclick="viewCertificate('{{ url_for('static', filename=req.certificate) }}', '{{ req.user.name }}')"
                                class="inline-flex items-center px-3 py-2 border border-blue-300 rounded-lg text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition">
                                <i class="fas fa-file-image mr-2"></i>
                                Xem bằng cấp
                            </button>
                            {% else %}
                            <span class="text-gray-400 text-sm italic">Không có</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <i class="far fa-calendar-alt mr-1"></i>
                            {{ req.created_at }}
                            <div class="text-xs text-gray-400 mt-1">{{ req.created_at_time }}</div>
                        </td>

                        <td class="px-6 py-4 text-center">
                            <div class="flex flex-col gap-2">
                                <button onclick="viewRequestDetail({{ req.id }})"
                                    class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition text-sm font-medium">
                                    <i class="fas fa-eye mr-1"></i> Xem chi tiết
                                </button>
                                <button onclick="viewOCRInfo({{ req.id }})"
                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium">
                                    <i class="fas fa-robot mr-1"></i> Thông tin tự động (OCR)
                                </button>
                                <div class="flex gap-2">
                                    <button onclick="approveExpert({{ req.id }}, '{{ req.user.name }}')"
                                        class="flex-1 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-medium">
                                        <i class="fas fa-check"></i> Duyệt
                                    </button>
                                    <button onclick="rejectExpert({{ req.id }}, '{{ req.user.name }}')"
                                        class="flex-1 px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-medium">
                                        <i class="fas fa-times"></i> Từ chối
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not expert_requests %}
        <div class="text-center py-16 bg-gray-50 rounded-xl">
            <i class="fas fa-clipboard-check text-6xl text-green-300 mb-4"></i>
            <p class="text-gray-500 text-lg font-medium">Không có yêu cầu nào đang chờ duyệt</p>
        </div>
        {% endif %}
    </div>

    <!-- CONTENT AREA: TAB 2 - DANH SÁCH CHUYÊN GIA ĐÃ DUYỆT -->
    <div id="content-experts" class="hidden space-y-6">
        <div class="overflow-x-auto bg-white rounded-xl shadow">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gradient-to-r from-green-50 to-teal-50">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Chuyên gia
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Lĩnh vực
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Hoạt động chuyên môn
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Bằng cấp
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Ngày tham gia
                        </th>
                        <th class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">
                            Hành động
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for expert_data in verified_experts_data %}
                    {% set expert = expert_data.expert %}
                    {% set expert_posts_count = expert_data.expert_posts_count %}
                    {% set total_views = expert_data.total_views %}
                    {% set expert_cert = expert_data.certificate %}


                    <!-- ✅ LOGIC XỬ LÝ TÊN VÀ MÀU SẮC LĨNH VỰC -->
                    {% set expert_cat = expert.expert_category or 'other' %}
                    {% set expert_cat_name = 'Khác' %}
                    {% set expert_cat_color = 'bg-gray-100 text-gray-800' %}

                    {% if expert_cat == 'dinh_duong' %}
                    {% set expert_cat_name = 'Dinh dưỡng' %}
                    {% set expert_cat_color = 'bg-green-100 text-green-800' %}
                    {% elif expert_cat == 'suc_khoe' %}
                    {% set expert_cat_name = 'Sức khỏe' %}
                    {% set expert_cat_color = 'bg-blue-100 text-blue-800' %}
                    {% elif expert_cat == 'tam_ly' %}
                    {% set expert_cat_name = 'Tâm lý trẻ em' %}
                    {% set expert_cat_color = 'bg-purple-100 text-purple-800' %}
                    {% elif expert_cat == 'giao_duc' %}
                    {% set expert_cat_name = 'Giáo dục sớm' %}
                    {% set expert_cat_color = 'bg-yellow-100 text-yellow-800' %}
                    {% elif expert_cat %}
                    {% set expert_cat_name = expert_cat | replace('_', ' ') | title %}
                    {% endif %}

                    <!-- ✅ LẤY ẢNH BẰNG CẤP TỪ MAP GỬI TỪ APP.PY -->
                    {% set expert_cert = expert_cert_map.get(expert.id) %}

                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <img class="h-12 w-12 rounded-full ring-2 ring-green-400"
                                    src="{{ url_for('static', filename=expert.avatar or 'images/default-avatar.png') }}"
                                    alt="{{ expert.name }}">
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900">{{ expert.name }}</div>
                                    <div class="text-sm text-gray-500">{{ expert.email }}</div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span
                                            class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                            <i class="fas fa-check-circle mr-1"></i> Đã xác minh
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4">
                            <!-- ✅ SỬ DỤNG BIẾN ĐÃ CẤU HÌNH -->
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {{ expert_cat_color }}">
                                {{ expert_cat_name }}
                            </span>
                        </td>

                        <td class="px-6 py-4">
                            <div class="space-y-1 text-sm">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Bài viết chuyên môn:</span>
                                    <span class="font-bold text-green-600">
                                        {{ expert_posts_count }}
                                    </span>
                                </div>

                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Lượt xem:</span>
                                    <span class="font-semibold text-gray-700">
                                        {{ total_views }}
                                    </span>
                                </div>

                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">Điểm uy tín:</span>
                                    <span class="font-semibold text-purple-600">
                                        {{ expert.points }} pts
                                    </span>
                                </div>
                            </div>
                        </td>


                        <!-- ✅ CỘT BẰNG CẤP (MỚI THÊM) -->
                        <td class="px-6 py-4 text-center">
                            {% if expert_cert %}
                            <button
                                onclick="viewCertificate('{{ url_for('static', filename=expert_cert) }}', '{{ expert.name }}')"
                                class="inline-flex items-center px-3 py-2 border border-blue-300 rounded-lg text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 transition">
                                <i class="fas fa-file-image mr-2"></i>
                                Xem bằng cấp
                            </button>
                            {% else %}
                            <span class="text-gray-400 text-sm italic">Không có file</span>
                            {% endif %}
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <i class="far fa-calendar-alt mr-1"></i>
                            {{ expert.created_at.strftime('%d/%m/%Y') }}
                            <div class="text-xs text-gray-400 mt-1">
                                Ngày tham gia
                            </div>
                        </td>

                        <td class="px-6 py-4 text-center">
                            <div class="flex flex-col gap-2">
                                <a href="{{ url_for('user_profile', user_id=expert.id) }}" target="_blank"
                                    class="px-3 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition text-sm font-medium border border-blue-200">
                                    <i class="fas fa-external-link-alt mr-1"></i> Xem hồ sơ
                                </a>
                                <button onclick="revokeExpert({{ expert.id }}, '{{ expert.name }}')"
                                    class="px-3 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition text-sm font-medium border border-red-200">
                                    <i class="fas fa-user-minus mr-1"></i> Hủy tư cách
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if not verified_experts %}
        <div class="text-center py-16 bg-gray-50 rounded-xl">
            <i class="fas fa-user-md text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg font-medium">Chưa có chuyên gia nào trong hệ thống</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal xem chi tiết yêu cầu (Tab 1) -->
<div id="requestDetailModal"
    class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div
            class="sticky top-0 bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6 rounded-t-2xl flex items-center justify-between">
            <h3 class="text-xl font-bold">
                <i class="fas fa-user-graduate mr-2"></i>
                Chi tiết yêu cầu chuyên gia
            </h3>
            <button onclick="closeRequestDetailModal()" class="text-white hover:text-gray-200 transition">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="requestDetailContent" class="p-6">
            <!-- Nội dung được load bằng JavaScript -->
        </div>
    </div>
</div>

<!-- Modal xem bằng cấp (Tab 1 & Tab 2 dùng chung) -->
<div id="certificateModal"
    class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div
            class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 rounded-t-2xl flex items-center justify-between">
            <h3 class="text-lg font-bold" id="certificateTitle">
                <i class="fas fa-certificate mr-2"></i>
                Bằng cấp / Chứng chỉ
            </h3>
            <button onclick="closeCertificateModal()" class="text-white hover:text-gray-200 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-6">
            <img id="certificateImage" src="" alt="Certificate" class="w-full h-auto rounded-lg shadow-lg">
            <div class="mt-4 flex gap-3">
                <a id="certificateDownload" href="" download
                    class="flex-1 text-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-download mr-2"></i> Tải xuống
                </a>
                <a id="certificateOpen" href="" target="_blank"
                    class="flex-1 text-center px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">
                    <i class="fas fa-external-link-alt mr-2"></i> Mở tab mới
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Dữ liệu yêu cầu (cho Tab 1)
    const expertRequests = {{ expert_requests_json | tojson | safe }};

    // --- XỬ LÝ TAB ---
    function switchTab(tabName) {
        const reqTab = document.getElementById('tab-requests');
        const expTab = document.getElementById('tab-experts');
        const reqContent = document.getElementById('content-requests');
        const expContent = document.getElementById('content-experts');

        if (tabName === 'requests') {
            // Active Tab 1
            reqTab.classList.add('bg-white', 'text-purple-700', 'shadow-sm');
            reqTab.classList.remove('text-gray-600');

            expTab.classList.remove('bg-white', 'text-purple-700', 'shadow-sm');
            expTab.classList.add('text-gray-600');

            reqContent.classList.remove('hidden');
            expContent.classList.add('hidden');
        } else {
            // Active Tab 2
            expTab.classList.add('bg-white', 'text-purple-700', 'shadow-sm');
            expTab.classList.remove('text-gray-600');

            reqTab.classList.remove('bg-white', 'text-purple-700', 'shadow-sm');
            reqTab.classList.add('text-gray-600');

            expContent.classList.remove('hidden');
            reqContent.classList.add('hidden');
        }
    }

    // --- XỬ LÝ YÊU CẦU CHUYÊN GIA (TAB 1) ---
    function viewRequestDetail(reqId) {
        const req = expertRequests.find(r => r.id === reqId);
        if (!req) return;

        const totalPosts = req.total_posts || 0;
        const totalComments = req.total_comments || 0;
        const avgLikes = req.avg_likes || 0;

        let certificateHtml = '';
        if (req.certificate) {
            certificateHtml = `
            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-certificate mr-2 text-blue-600"></i>
                    Bằng cấp / Chứng chỉ
                </h4>
                <img src="{{ url_for('static', filename='') }}${req.certificate}" 
                     alt="Certificate" 
                     class="w-full rounded-lg shadow-md cursor-pointer hover:shadow-xl transition"
                     onclick="viewCertificate('{{ url_for('static', filename='') }}${req.certificate}', '${req.user.name}')">
            </div>
        `;
        } else {
            certificateHtml = `
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <i class="fas fa-file-excel text-gray-300 text-3xl mb-2"></i>
                <p class="text-gray-500 text-sm">Không có bằng cấp đính kèm</p>
            </div>
        `;
        }

        document.getElementById('requestDetailContent').innerHTML = `
        <div class="space-y-6">
            <!-- Thông tin người dùng -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-6">
                <h4 class="font-bold text-gray-800 mb-4 text-lg flex items-center">
                    <i class="fas fa-user mr-2 text-purple-600"></i>
                    Thông tin người dùng
                </h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Tên:</p>
                        <p class="font-semibold text-gray-900">${req.user.name}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Email:</p>
                        <p class="font-semibold text-gray-900">${req.user.email}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Điểm tích lũy:</p>
                        <p class="font-semibold text-purple-600">${req.user.points} điểm</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Lĩnh vực:</p>
                        <p class="font-semibold text-gray-900">${req.category}</p>
                    </div>
                </div>
            </div>
            
            <!-- Thống kê hoạt động -->
            <div class="bg-green-50 rounded-lg p-6">
                <h4 class="font-bold text-gray-800 mb-4 text-lg flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                    Thống kê hoạt động
                </h4>
                <div class="grid grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                        <div class="text-3xl font-bold text-blue-600">${totalPosts}</div>
                        <div class="text-sm text-gray-600 mt-1">Bài viết</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                        <div class="text-3xl font-bold text-purple-600">${totalComments}</div>
                        <div class="text-sm text-gray-600 mt-1">Bình luận</div>
                    </div>
                    <div class="text-center p-4 bg-white rounded-lg shadow">
                        <div class="text-3xl font-bold text-green-600">${totalPosts + totalComments}</div>
                        <div class="text-sm text-gray-600 mt-1">Tổng nội dung</div>
                    </div>
                </div>
            </div>
            
            <!-- Lý do và kinh nghiệm -->
            <div class="bg-yellow-50 rounded-lg p-6">
                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-comment-dots mr-2 text-yellow-600"></i>
                    Lý do & Kinh nghiệm
                </h4>
                <p class="text-gray-700 leading-relaxed whitespace-pre-line">${req.reason}</p>
            </div>
            
            <!-- Bằng cấp -->
            ${certificateHtml}
            
            <!-- Thông tin gửi -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="flex items-center justify-between text-sm text-gray-600">
                    <span><i class="far fa-calendar mr-2"></i>Ngày gửi: <strong>${new Date(req.created_at).toLocaleString('vi-VN')}</strong></span>
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full font-semibold">Chờ duyệt</span>
                </div>
            </div>
            
            <!-- Nút hành động -->
            <div class="flex gap-3 pt-4 border-t">
                <button onclick="approveExpert(${req.id}, '${req.user.name}')"
                        class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-semibold">
                    <i class="fas fa-check mr-2"></i> Phê duyệt
                </button>
                <button onclick="rejectExpert(${req.id}, '${req.user.name}')"
                        class="flex-1 px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i> Từ chối
                </button>
            </div>
        </div>
        `;

        document.getElementById('requestDetailModal').classList.remove('hidden');
    }

    function closeRequestDetailModal() {
        document.getElementById('requestDetailModal').classList.add('hidden');
    }

    function viewCertificate(url, userName) {
        document.getElementById('certificateTitle').innerHTML = `
        <i class="fas fa-certificate mr-2"></i>
        Bằng cấp của ${userName}
    `;
        document.getElementById('certificateImage').src = url;
        document.getElementById('certificateDownload').href = url;
        document.getElementById('certificateOpen').href = url;
        document.getElementById('certificateModal').classList.remove('hidden');
    }

    function closeCertificateModal() {
        document.getElementById('certificateModal').classList.add('hidden');
    }

    function approveExpert(reqId, userName) {
        const note = prompt(`✅ PHÊ DUYỆT CHUYÊN GIA: ${userName}\n\nGhi chú cho user (không bắt buộc):`);
        if (note === null) return;

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/expert/${reqId}/approve`;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'note';
        input.value = note || 'Chúc mừng bạn đã trở thành chuyên gia!';
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    }

    function rejectExpert(reqId, userName) {
        const note = prompt(`❌ TỪ CHỐI YÊU CẦU: ${userName}\n\nLý do từ chối (BẮT BUỘC):`);
        if (note === null) return;

        if (!note || note.trim() === '') {
            alert('⚠️ Vui lòng nhập lý do từ chối!');
            return rejectExpert(reqId, userName);
        }

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/expert/${reqId}/reject`;

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'note';
        input.value = note;
        form.appendChild(input);

        document.body.appendChild(form);
        form.submit();
    }

    // --- XỬ LÝ HỦY TƯ CÁNG CHUYÊN GIA (TAB 2) ---
    function revokeExpert(userId, userName) {
        const reason = prompt(`❌ HỦY TƯ CÁNG CHUYÊN GIA: ${userName}\n\nLý do hủy bỏ (BẮT BUỘC):`);

        if (reason === null) return;

        if (!reason || reason.trim() === '') {
            alert('⚠️ Vui lòng nhập lý do để hủy tư cách chuyên gia!');
            return revokeExpert(userId, userName);
        }

        if (confirm(`Bạn có chắc chắn muốn hủy tư cách chuyên gia của ${userName}? Hành động này không thể hoàn tác.`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/expert/${userId}/revoke`;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'reason';
            input.value = reason;
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }

    // Đóng modal khi click outside
    document.getElementById('requestDetailModal')?.addEventListener('click', function (e) {
        if (e.target === this) closeRequestDetailModal();
    });
    document.getElementById('certificateModal')?.addEventListener('click', function (e) {
        if (e.target === this) closeCertificateModal();
    });
</script>

<style>
    #requestDetailModal,
    #certificateModal {
        animation: fadeIn 0.2s ease-in-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    tbody tr {
        transition: all 0.2s ease;
    }

    tbody tr:hover {
        transform: translateX(4px);
    }
</style>