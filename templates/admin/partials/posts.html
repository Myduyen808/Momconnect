<div class="mb-4">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">
        Quản lý Bài viết & Bình luận
    </h2>

    <div class="flex justify-between mb-4">
        <input type="text" id="searchPost"
               placeholder="Tìm theo tiêu đề hoặc tác giả..."
               class="px-4 py-2 border rounded-lg w-96"
               onkeyup="filterPosts()">
        <span class="text-gray-600">
            Tổng: <strong>{{ posts|length }}</strong> bài viết
        </span>
    </div>
</div>

<div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Tiêu đề
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Tác giả
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Ngày đăng
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Bình luận
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Trạng thái
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Hành động
                </th>
            </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-200" id="postsTable">
            {% for post in posts %}
            <tr class="hover:bg-gray-50">

                <!-- TIÊU ĐỀ -->
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    <a href="{{ url_for('post_detail', post_id=post.id) }}"
                       target="_blank"
                       class="text-pink-600 hover:underline font-medium">
                        {{ post.title[:60] }}{% if post.title|length > 60 %}...{% endif %}
                        <i class="fas fa-external-link-alt text-xs ml-1 opacity-60"></i>
                    </a>
                </td>

                <!-- TÁC GIẢ -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {{ post.author.name }}
                </td>

                <!-- NGÀY ĐĂNG -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {{ post.created_at.strftime('%d/%m %H:%M') }}
                </td>

                <!-- BÌNH LUẬN -->
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600">
                    {{ post.comments_count }}
                </td>

                <!-- TRẠNG THÁI -->
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="{% if post.is_locked %}text-red-600 font-bold{% else %}text-green-600{% endif %}">
                        {% if post.is_locked %}Đã khóa{% else %}Bình thường{% endif %}
                    </span>
                </td>

                <!-- HÀNH ĐỘNG -->
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3">

                    {% if not post.is_helpful %}
                    <button onclick="markHelpful({{ post.id }})"
                            class="text-yellow-600 hover:text-yellow-800">
                        <i class="fas fa-award mr-1"></i> Hữu ích
                    </button>
                    {% else %}
                    <span class="text-yellow-600 font-bold">
                        <i class="fas fa-award mr-1"></i> Đã đánh dấu
                    </span>
                    {% endif %}

                    <button onclick="toggleLock({{ post.id }}, {{ post.is_locked|lower }})"
                            class="text-yellow-600 hover:text-yellow-800">
                        {% if post.is_locked %}Mở khóa{% else %}Khóa{% endif %}
                    </button>

                    <button onclick="deletePost({{ post.id }})"
                            class="text-red-600 hover:text-red-800">
                        Xóa
                    </button>
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- MODAL CHI TIẾT BÀI VIẾT -->
<div id="postDetailModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto p-6">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold" id="modal_title"></h3>
            <button onclick="closePostModal()"
                    class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
        </div>

        <p class="text-gray-600 mb-2">
            Tác giả: <span id="modal_author"></span> |
            Ngày đăng: <span id="modal_date"></span>
        </p>

        <p class="text-gray-600 mb-4">
            Bình luận:
            <span id="modal_comment_count"
                  class="font-bold text-blue-600">0</span>
        </p>

        <div class="border-t pt-4 mb-6">
            <div id="modal_content"
                 class="prose max-w-none whitespace-pre-wrap"></div>
        </div>

        <h4 class="font-bold text-lg mb-3">Bình luận</h4>
        <div id="comments_list" class="space-y-3"></div>

        <div class="mt-6 flex justify-end">
            <button onclick="closePostModal()"
                    class="px-6 py-3 bg-gray-300 rounded-lg hover:bg-gray-400">
                Đóng
            </button>
        </div>
    </div>
</div>

<script>
function filterPosts() {
    const query = document.getElementById('searchPost').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#postsTable tr');

    rows.forEach(row => {
        const title = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase() || '';
        const author = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
        row.style.display = (title.includes(query) || author.includes(query)) ? '' : 'none';
    });
}

function markHelpful(postId) {
    if (!confirm('Đánh dấu bài này là hữu ích? Tác giả sẽ nhận +50 điểm')) return;

    fetch(`/admin/post/${postId}/mark_helpful`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert(data.error || 'Có lỗi xảy ra');
    })
    .catch(() => alert('Không thể kết nối máy chủ'));
}
</script>
