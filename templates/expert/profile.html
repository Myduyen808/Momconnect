{% extends "expert/base_expert.html" %}

{% block title %}H·ªì s∆° Chuy√™n gia{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">H·ªì s∆° Chuy√™n gia</h1>

    <!-- ‚úÖ CH·ªà C√ì 1 FORM DUY NH·∫§T -->
    <form method="POST" action="{{ url_for('expert_profile') }}" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- LEFT SIDEBAR - AVATAR & QUICK INFO -->
        <div class="lg:col-span-1 space-y-6">
            <!-- AVATAR CARD -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-center">
                    <div class="relative inline-block">
                        <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                            alt="{{ current_user.name }}" id="avatarPreview"
                            class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-xl mx-auto">
                        <label for="avatarInput"
                            class="absolute bottom-0 right-0 bg-white text-purple-600 p-2 rounded-full cursor-pointer hover:bg-purple-50 transition shadow-lg">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="avatarInput" name="avatarInput" accept="image/*" class="hidden" onchange="previewAvatar(this)">
                    </div>
                    <h3 class="text-white text-xl font-bold mt-4">{{ current_user.name }}</h3>
                    <p class="text-purple-100 text-sm">{{ current_user.email }}</p>
                </div>

                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-gray-100">
                        <span class="text-gray-600 flex items-center gap-2">
                            <i class="fas fa-certificate text-purple-500"></i>
                            Tr·∫°ng th√°i
                        </span>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                            ƒê√£ x√°c minh
                        </span>
                    </div>

                    <div class="flex items-center justify-between py-3 border-b border-gray-100">
                        <span class="text-gray-600 flex items-center gap-2">
                            <i class="fas fa-star text-yellow-500"></i>
                            ƒêi·ªÉm uy t√≠n
                        </span>
                        <span class="font-bold text-gray-800">{{ current_user.credibility_score or 0 }}</span>
                    </div>

                    <div class="flex items-center justify-between py-3">
                        <span class="text-gray-600 flex items-center gap-2">
                            <i class="fas fa-users text-blue-500"></i>
                            Ng∆∞·ªùi theo d√µi
                        </span>
                        <span class="font-bold text-gray-800">{{ current_user.followers.count() }}</span>
                    </div>
                </div>
            </div>

            <!-- QUICK ACTIONS - CH·ªà GI·ªÆ 1 B·∫¢N -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-bolt text-yellow-500"></i>
                    Thao t√°c nhanh
                </h3>
                <div class="space-y-3">
                    <!-- ‚úÖ N√öT SCAN CH·ª®NG CH·ªà -->
                    <button type="button" onclick="document.getElementById('certScanInput').click()"
                        class="w-full flex items-center gap-3 p-3 bg-gradient-to-r from-green-500 to-teal-600 text-white rounded-lg hover:shadow-lg transition">
                        <i class="fas fa-robot text-xl"></i>
                        <span class="font-medium">Scan ch·ª©ng ch·ªâ t·ª± ƒë·ªông</span>
                    </button>
                    <input type="file" id="certScanInput" accept="image/*,.pdf" class="hidden" onchange="scanCertificate(this)">

                    <button type="button" onclick="changePassword()"
                        class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-purple-50 rounded-lg transition">
                        <i class="fas fa-key text-purple-600"></i>
                        <span class="font-medium">ƒê·ªïi m·∫≠t kh·∫©u</span>
                    </button>
                    <button type="button" onclick="viewPublicProfile()"
                        class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-blue-50 rounded-lg transition">
                        <i class="fas fa-eye text-blue-600"></i>
                        <span class="font-medium">Xem trang c√¥ng khai</span>
                    </button>
                    <button type="button" onclick="downloadCertificate()"
                        class="w-full flex items-center gap-3 p-3 bg-gray-50 hover:bg-green-50 rounded-lg transition">
                        <i class="fas fa-download text-green-600"></i>
                        <span class="font-medium">T·∫£i ch·ª©ng ch·ªâ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT MAIN CONTENT - FORMS -->
        <div class="lg:col-span-2 space-y-6">
            
            <!-- TH√îNG TIN ƒêƒÇNG K√ù (C√Å NH√ÇN) -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-user-circle"></i>
                        Th√¥ng tin ƒëƒÉng k√Ω
                    </h2>
                </div>

                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-user mr-2"></i>H·ªç v√† t√™n *
                            </label>
                            <input type="text" name="name" value="{{ current_user.name }}" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-envelope mr-2"></i>Email (kh√¥ng th·ªÉ s·ª≠a)
                            </label>
                            <input type="email" value="{{ current_user.email }}" disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 cursor-not-allowed">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-phone mr-2"></i>S·ªë ƒëi·ªán tho·∫°i
                            </label>
                            <input type="text" name="phone" value="{{ current_user.phone or '' }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="VD: 0123456789">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-child mr-2"></i>S·ªë con
                            </label>
                            <input type="number" name="children_count" value="{{ current_user.children_count or 0 }}" min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-birthday-cake mr-2"></i>ƒê·ªô tu·ªïi con (c√°ch nhau b·ªüi d·∫•u ph·∫©y)
                        </label>
                        <input type="text" name="children_ages" value="{{ current_user.children_ages or '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="VD: 3,5,8">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-align-left mr-2"></i>Gi·ªõi thi·ªáu
                        </label>
                        <textarea name="bio" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="Vi·∫øt v√†i d√≤ng gi·ªõi thi·ªáu v·ªÅ b·∫£n th√¢n...">{{ current_user.bio or '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- TH√îNG TIN CHUY√äN M√îN - CH·ªà GI·ªÆ 1 B·∫¢N -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-briefcase"></i>
                        Th√¥ng tin chuy√™n m√¥n
                    </h2>
                </div>

                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-stethoscope mr-2"></i>Chuy√™n m√¥n *
                            </label>
                            <input type="text" id="specialty" name="specialty" value="{{ current_user.specialty or '' }}" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="VD: Nhi khoa">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-briefcase mr-2"></i>Kinh nghi·ªám (nƒÉm)
                            </label>
                            <input type="number" id="experience_years" name="experience_years" value="{{ current_user.experience_years or 0 }}" min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-hospital mr-2"></i>N∆°i l√†m vi·ªác
                        </label>
                        <input type="text" id="workplace" name="workplace" value="{{ current_user.workplace or '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="VD: B·ªánh vi·ªán Nhi ƒê·ªìng 1">
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-id-card mr-2"></i>S·ªë ch·ª©ng ch·ªâ h√†nh ngh·ªÅ
                        </label>
                        <input type="text" id="license_number" name="license_number" value="{{ current_user.license_number or '' }}"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            placeholder="VD: 12345/BYT">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="far fa-calendar mr-2"></i>Ng√†y h·∫øt h·∫°n ch·ª©ng ch·ªâ
                            </label>
                            <input type="date" id="license_expiry" name="license_expiry"
                                value="{{ current_user.license_expiry.strftime('%Y-%m-%d') if current_user.license_expiry else '' }}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fas fa-dollar-sign mr-2"></i>Ph√≠ t∆∞ v·∫•n (VNƒê/bu·ªïi)
                            </label>
                            <input type="number" id="consultation_fee" name="consultation_fee" value="{{ current_user.consultation_fee or 0 }}" min="0"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                placeholder="0 = Mi·ªÖn ph√≠">
                        </div>
                    </div>
                </div>
            </div>

            <!-- H·ªåC V·∫§N & CH·ª®NG CH·ªà -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-green-500 to-teal-600 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-graduation-cap"></i>
                        H·ªçc v·∫•n & Ch·ª©ng ch·ªâ
                    </h2>
                </div>

                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-university mr-2"></i>Tr√¨nh ƒë·ªô h·ªçc v·∫•n
                        </label>
                        <textarea name="education" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Li·ªát k√™ c√°c b·∫±ng c·∫•p, tr∆∞·ªùng h·ªçc...">{{ current_user.education or '' }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-certificate mr-2"></i>Ch·ª©ng ch·ªâ chuy√™n m√¥n
                        </label>
                        <textarea name="certifications" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Li·ªát k√™ c√°c ch·ª©ng ch·ªâ, kh√≥a ƒë√†o t·∫°o...">{{ current_user.certifications or '' }}</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-upload mr-2"></i>T·∫£i l√™n ch·ª©ng ch·ªâ m·ªõi (·∫£nh/PDF)
                        </label>
                        <input type="file" name="certificate_upload" accept="image/*,.pdf" multiple
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-2">Ch·∫•p nh·∫≠n: JPG, PNG, PDF (t·ªëi ƒëa 5MB)</p>
                    </div>
                </div>
            </div>

            <!-- TR·∫†NG TH√ÅI HO·∫†T ƒê·ªòNG -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-clock"></i>
                        Tr·∫°ng th√°i ho·∫°t ƒë·ªông
                    </h2>
                </div>

                <div class="p-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <i class="fas fa-signal mr-2"></i>Tr·∫°ng th√°i
                    </label>
                    <select name="availability"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="available" {{ 'selected' if current_user.availability=='available' else '' }}>
                            S·∫µn s√†ng t∆∞ v·∫•n
                        </option>
                        <option value="busy" {{ 'selected' if current_user.availability=='busy' else '' }}>
                            B·∫≠n
                        </option>
                        <option value="offline" {{ 'selected' if current_user.availability=='offline' else '' }}>
                            Offline
                        </option>
                    </select>
                </div>
            </div>

            <!-- SUBMIT -->
            <div class="flex gap-4">
                <button type="submit"
                    class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-xl font-bold hover:shadow-xl transition transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-save"></i>
                    L∆∞u thay ƒë·ªïi
                </button>
                <button type="reset"
                    class="px-8 py-4 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition">
                    <i class="fas fa-undo mr-2"></i>
                    ƒê·∫∑t l·∫°i
                </button>
            </div>
        </div>
    </form>
</div>

<script>
// Preview Avatar
function previewAvatar(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById('avatarPreview').src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// ‚úÖ H√ÄM SCAN CH·ª®NG CH·ªà V√Ä T·ª∞ ƒê·ªòNG ƒêI·ªÄN
async function scanCertificate(input) {
    if (!input.files || !input.files[0]) return;

    const file = input.files[0];
    const formData = new FormData();
    formData.append('certificate', file);

    // Hi·ªÉn th·ªã loading
    const loadingToast = showToast('ü§ñ ƒêang qu√©t ch·ª©ng ch·ªâ...', 'info', 0);

    try {
        const response = await fetch('/api/scan-certificate', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            const info = data.parsed_info;

            // ‚úÖ T·ª∞ ƒê·ªòNG ƒêI·ªÄN V√ÄO FORM
            if (info.specialty) document.getElementById('specialty').value = info.specialty;
            if (info.cert_number) document.getElementById('license_number').value = info.cert_number;
            if (info.expiry_date) document.getElementById('license_expiry').value = info.expiry_date;
            if (info.issue_org) document.getElementById('workplace').value = info.issue_org;

            // ƒê√≥ng loading
            loadingToast.remove();

            // Hi·ªÉn th·ªã k·∫øt qu·∫£
            showToast('‚úÖ ƒê√£ ƒëi·ªÅn t·ª± ƒë·ªông t·ª´ ch·ª©ng ch·ªâ!', 'success');

            // Hi·ªÉn th·ªã chi ti·∫øt
            showOCRResult(data.raw_text, info);
        } else {
            loadingToast.remove();
            showToast('‚ùå ' + (data.error || 'Kh√¥ng th·ªÉ ƒë·ªçc ch·ª©ng ch·ªâ'), 'error');
        }
    } catch (error) {
        loadingToast.remove();
        showToast('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message, 'error');
    }
}

// ‚úÖ HI·ªÇN TH·ªä K·∫æT QU·∫¢ OCR
function showOCRResult(rawText, parsedInfo) {
    const html = `
        <div class="space-y-4">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                <h4 class="font-bold text-green-800 mb-3">ü§ñ Th√¥ng tin ƒë√£ ƒë·ªçc ƒë∆∞·ª£c:</h4>
                <ul class="space-y-2 text-sm">
                    <li><strong>Chuy√™n m√¥n:</strong> <span class="text-green-700">${parsedInfo.specialty || 'Kh√¥ng ph√°t hi·ªán'}</span></li>
                    <li><strong>S·ªë ch·ª©ng ch·ªâ:</strong> <span class="text-green-700">${parsedInfo.cert_number || 'Kh√¥ng ph√°t hi·ªán'}</span></li>
                    <li><strong>C∆° quan c·∫•p:</strong> <span class="text-green-700">${parsedInfo.issue_org || 'Kh√¥ng ph√°t hi·ªán'}</span></li>
                    <li><strong>Ng√†y h·∫øt h·∫°n:</strong> <span class="text-green-700">${parsedInfo.expiry_date || 'Kh√¥ng ph√°t hi·ªán'}</span></li>
                </ul>
            </div>
            
            <details class="bg-gray-50 p-4 rounded">
                <summary class="cursor-pointer font-bold text-gray-700 hover:text-purple-600">
                    <i class="fas fa-code mr-2"></i>Xem text g·ªëc
                </summary>
                <pre class="mt-3 p-3 bg-white rounded text-xs overflow-auto max-h-48 border">${rawText}</pre>
            </details>
            
            <p class="text-sm text-gray-600">
                üí° <strong>L∆∞u √Ω:</strong> Vui l√≤ng ki·ªÉm tra v√† ch·ªânh s·ª≠a th√¥ng tin n·∫øu c·∫ßn tr∆∞·ªõc khi l∆∞u!
            </p>
        </div>
    `;
    
    showModal('K·∫øt qu·∫£ qu√©t ch·ª©ng ch·ªâ', html);
}

// ‚úÖ H√ÄM HI·ªÇN TH·ªä TOAST
function showToast(message, type = 'info', duration = 3000) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-yellow-500'
    };

    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 transform transition-all`;
    toast.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} text-xl"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;

    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add('opacity-100'), 10);

    if (duration > 0) {
        setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => toast.remove(), 300);
        }, duration);
    }

    return toast;
}

// ‚úÖ H√ÄM HI·ªÇN TH·ªä MODAL
function showModal(title, content) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-t-2xl flex justify-between items-center">
                <h3 class="text-2xl font-bold">${title}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-3xl hover:text-gray-200 transition">&times;</button>
            </div>
            <div class="p-6">${content}</div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Quick Actions
function changePassword() {
    alert('Ch·ª©c nƒÉng ƒë·ªïi m·∫≠t kh·∫©u ƒëang ph√°t tri·ªÉn!');
}

function viewPublicProfile() {
    window.open("/user/{{ current_user.id }}", "_blank");
}

function downloadCertificate() {
    alert('Ch·ª©c nƒÉng t·∫£i ch·ª©ng ch·ªâ ƒëang ph√°t tri·ªÉn!');
}

// Form Validation
document.querySelector('form')?.addEventListener('submit', function (e) {
    const specialty = document.querySelector('[name="specialty"]').value.trim();
    if (!specialty) {
        e.preventDefault();
        alert('Vui l√≤ng nh·∫≠p chuy√™n m√¥n!');
    }
});
</script>

<style>
input[type="file"]::-webkit-file-upload-button {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    font-weight: 600;
    margin-right: 1rem;
}

input[type="file"]::-webkit-file-upload-button:hover {
    background: linear-gradient(135deg, #764ba2, #667eea);
}
</style>
{% endblock %}