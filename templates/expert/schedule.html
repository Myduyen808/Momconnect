{% extends "expert/base_expert.html" %}

{% block title %}Quản lý lịch tư vấn{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- HEADER -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Quản lý lịch tư vấn</h1>
            <p class="text-gray-600">Tạo và quản lý khung giờ tư vấn của bạn</p>
        </div>
        <button onclick="openCreateModal()"
            class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105 flex items-center gap-2">
            <i class="fas fa-plus"></i>
            Tạo khung giờ mới
        </button>
    </div>

    <!-- DANH SÁCH KHUNG GIỜ -->
    {% if time_slots and time_slots|length > 0 %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for slot in time_slots %}
        <div
            class="bg-white rounded-xl shadow-md overflow-hidden border-l-4 {{ 'border-green-500' if slot.status == 'available' else 'border-orange-500' if slot.status == 'booked' else 'border-gray-400' }}">
            <div class="p-6">
                <!-- STATUS BADGE -->
                <div class="flex justify-between items-start mb-4">
                    {% if slot.status == 'available' %}
                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-check-circle mr-1"></i>Còn trống
                    </span>
                    {% elif slot.status == 'booked' %}
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-user-check mr-1"></i>Đã đặt
                    </span>
                    {% else %}
                    <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm font-medium">
                        <i class="fas fa-ban mr-1"></i>Đã hủy
                    </span>
                    {% endif %}

                    <button onclick="deleteSlot({{ slot.id }})" class="text-red-500 hover:text-red-700 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <!-- DATE & TIME -->
                <div class="text-center mb-4">
                    <div class="text-4xl font-bold text-purple-600 mb-1">
                        {{ slot.start_time.strftime('%d') }}
                    </div>
                    <div class="text-sm text-gray-600">
                        Tháng {{ slot.start_time.strftime('%m/%Y') }}
                    </div>
                </div>

                <div class="text-center mb-4">
                    <div class="text-2xl font-bold text-gray-800">
                        {{ slot.start_time.strftime('%H:%M') }} - {{ slot.end_time.strftime('%H:%M') }}
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ ((slot.end_time - slot.start_time).total_seconds() / 60)|int }} phút
                    </div>
                </div>

                <!-- BOOKING INFO -->
                {% if slot.booking %}
                <div class="bg-blue-50 rounded-lg p-3 mb-4">
                    <div class="flex items-center gap-3">
                        <img src="{{ url_for('static', filename=slot.booking.user.avatar or 'images/default-avatar.png') }}"
                            alt="{{ slot.booking.user.name }}" class="w-10 h-10 rounded-full object-cover">
                        <div>
                            <h4 class="font-bold text-gray-800">{{ slot.booking.user.name }}</h4>
                            <p class="text-sm text-gray-600">Đã đặt lịch</p>
                        </div>
                    </div>
                    {% if slot.booking.notes %}
                    <p class="text-sm text-gray-700 mt-2 border-t pt-2">
                        <i class="fas fa-comment mr-1"></i>{{ slot.booking.notes[:50] }}...
                    </p>
                    {% endif %}
                </div>
                {% endif %}

                {% if slot.notes %}
                <div class="text-sm text-gray-600 mb-4">
                    <i class="fas fa-info-circle mr-1"></i>
                    {{ slot.notes[:50] }}...
                </div>
                {% endif %}

                <!-- ACTIONS -->
                <div class="flex gap-2">
                    {% if slot.status == 'available' %}
                    <button onclick="editSlot({{ slot.id }})"
                        class="flex-1 bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600 transition">
                        <i class="fas fa-edit mr-1"></i>Sửa
                    </button>
                    {% elif slot.status == 'booked' %}
                    <button onclick="cancelBooking({{ slot.id }})"
                        class="flex-1 bg-red-500 text-white py-2 rounded-lg font-bold hover:bg-red-600 transition">
                        <i class="fas fa-times mr-1"></i>Hủy lịch
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- EMPTY STATE -->
    <div class="bg-white rounded-xl shadow-md p-12 text-center">
        <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-700 mb-2">Chưa có khung giờ nào</h3>
        <p class="text-gray-500 mb-6">Hãy tạo khung giờ tư vấn đầu tiên của bạn</p>
        <button onclick="openCreateModal()"
            class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105">
            <i class="fas fa-plus mr-2"></i>Tạo khung giờ mới
        </button>
    </div>
    {% endif %}
</div>

<!-- CREATE/EDIT MODAL -->
<div id="slotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">
                <span id="modalTitle">Tạo khung giờ mới</span>
            </h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <form id="slotForm" method="POST" action="{{ url_for('expert_schedule') }}">
            <input type="hidden" name="slot_id" id="slotId">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ngày *</label>
                    <!-- ĐÃ SỬA Ở ĐÂY: giới hạn ngày nhỏ nhất -->
                    <input type="date" name="date" id="slotDate" required min="{{ min_date }}"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Giờ bắt đầu *</label>
                    <input type="time" name="start_time" id="slotTime" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Thời lượng (phút) *</label>
                    <select name="duration" id="slotDuration" required
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="30">30 phút</option>
                        <option value="45">45 phút</option>
                        <option value="60">60 phút</option>
                        <option value="90">90 phút</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Số người tối đa</label>
                    <input type="number" name="max_participants" id="slotMax" value="1" min="1" max="10"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Ghi chú (tùy chọn)</label>
                    <textarea name="notes" id="slotNotes" rows="3"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="Mô tả ngắn gọn..."></textarea>
                </div>
            </div>

            <div class="flex gap-4 mt-6">
                <button type="submit"
                    class="flex-1 bg-purple-600 text-white py-2 rounded-lg font-bold hover:bg-purple-700">
                    <i class="fas fa-save mr-1"></i>Lưu
                </button>
                <button type="button" onclick="closeModal()"
                    class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-bold hover:bg-gray-300">
                    Hủy
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Các hàm JS giữ nguyên
    function openCreateModal() {
        document.getElementById('slotModal').classList.remove('hidden');
        document.getElementById('modalTitle').textContent = 'Tạo khung giờ mới';
        document.getElementById('slotForm').reset();
        document.getElementById('slotId').value = '';
    }

    function closeModal() {
        document.getElementById('slotModal').classList.add('hidden');
    }

    function editSlot(slotId) {
        alert('Chức năng đang phát triển!');
    }

    async function deleteSlot(slotId) {
        if (!confirm('Bạn có chắc muốn xóa khung giờ này?')) return;

        try {
            const formData = new FormData();
            formData.append('action', 'delete');
            formData.append('slot_id', slotId);

            const response = await fetch('{{ url_for("expert_schedule") }}', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                location.reload();
            } else {
                alert('Có lỗi xảy ra!');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Có lỗi xảy ra!');
        }
    }

    async function cancelBooking(slotId) {
        if (!confirm('Bạn có chắc muốn hủy lịch này? Người dùng sẽ nhận được thông báo.')) return;

        try {
            const response = await fetch(`/expert/time-slot/${slotId}/cancel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                alert('Đã hủy lịch!');
                location.reload();
            } else {
                alert(data.error || 'Có lỗi xảy ra!');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Có lỗi xảy ra!');
        }
    }
</script>
{% endblock %}