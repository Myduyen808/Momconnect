{% extends "base.html" %}
{% block title %}Trang ch·ªß{% endblock %}

{% block content %}
<div class="grid lg:grid-cols-3 gap-8 max-w-7xl mx-auto px-4 py-8">
    <!-- C·ªòT CH√çNH - B√ÄI VI·∫æT -->
    <div class="lg:col-span-2 space-y-8">
        <!-- B·ªò L·ªåC CH·ª¶ ƒê·ªÄ -->
        <div class="flex flex-wrap gap-3">
            {% for cat in categories %}
            <a href="{{ url_for('home', category=cat) }}"
                class="px-6 py-3 rounded-full font-medium transition-all shadow-sm
                    {% if selected_category == cat %}bg-gradient-to-r from-pink-500 to-purple-600 text-white shadow-lg{% else %}bg-white text-gray-700 hover:shadow-md{% endif %}">
                {{ category_names[cat] }}
            </a>
            {% endfor %}
        </div>

        <!-- DANH S√ÅCH B√ÄI VI·∫æT -->
        {% if posts %}
        {% for post in posts %}
        <div class="bg-white rounded-3xl shadow-xl post-card overflow-visible hover:shadow-2xl transition-all">
            <!-- Header b√†i vi·∫øt -->
            <div class="p-6 pb-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <img src="{{ url_for('static', filename=post.author.avatar or 'images/default-avatar.png') }}"
                            class="w-14 h-14 rounded-full object-cover ring-4 ring-pink-200 shadow-lg">
                        <div>
                            <div class="flex items-center gap-3">
                                <h3 class="text-xl font-bold text-gray-900">{{ post.author.name }}</h3>
                                {% if post.author.is_verified_expert %}
                                <span
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                    <i class="fas fa-stethoscope"></i> Chuy√™n gia
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                <i class="far fa-clock"></i>
                                {{ post.created_at | vietnam_time }}
                            </p>
                        </div>
                    </div>

                    <!-- N√öT K·∫æT B·∫†N GI·ªêNG FACEBOOK -->
                    {% if current_user.is_authenticated and post.author.id != current_user.id %}
                    <div id="friend-button-{{ post.author.id }}">
                        {% set friendship_status = current_user.get_friendship_status(post.author.id) %}

                        {% if friendship_status == 'friends' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'unfriend', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                            <i class="fas fa-user-minus mr-2"></i>B·∫°n b√®
                        </button>

                        {% elif friendship_status == 'incoming_request' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'accept_request', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-blue-600 text-white hover:bg-blue-700">
                            <i class="fas fa-user-check mr-2"></i>Ch·∫•p nh·∫≠n
                        </button>

                        {% elif friendship_status == 'outgoing_request' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'cancel_request', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                            <i class="fas fa-clock mr-2"></i>ƒê√£ g·ª≠i
                        </button>

                        {% else %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'add_friend', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- N·ªôi dung b√†i vi·∫øt -->
            <div class="p-6 pt-4">
                <a href="{{ url_for('post_detail', post_id=post.id) }}" class="block">
                    <h2 class="text-2xl font-bold text-gray-900 hover:text-pink-600 transition mb-3">
                        {{ post.title }}
                    </h2>
                    <p class="text-gray-700 leading-relaxed line-clamp-3 mb-4">
                        {{ post.content | truncate(300) }}
                    </p>
                </a>

                <!-- Ch·ªß ƒë·ªÅ + badge -->
                <div class="flex items-center gap-4 mb-4">
                    <span class="px-4 py-2 rounded-full text-sm font-medium
                    {% if post.category == 'health' %}bg-green-100 text-green-700
                    {% elif post.category == 'nutrition' %}bg-yellow-100 text-yellow-700
                    {% elif post.category == 'story' %}bg-purple-100 text-purple-700
                    {% elif post.category == 'tips' %}bg-blue-100 text-blue-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {{ category_names[post.category] }}
                    </span>
                    {% if post.is_expert_post %}
                    <span
                        class="bg-gradient-to-r from-teal-500 to-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold">
                        T∆∞ v·∫•n chuy√™n gia
                    </span>
                    {% endif %}
                </div>

                <!-- Media (·∫£nh + video) -->
                {% if post.get_images_list() or post.video %}
                <div class="mb-6 -mx-6">
                    {% if post.get_images_list() %}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 px-6">
                        {% for img in post.get_images_list()[:6] %}
                        <div class="relative group overflow-hidden rounded-2xl shadow-lg bg-gray-100">
                            <img src="{{ url_for('static', filename='uploads/' ~ img) }}"
                                class="w-full h-64 object-cover hover:scale-110 transition duration-500">
                            {% if loop.index == 6 and post.get_images_list()|length > 6 %}
                            <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center">
                                <span class="text-white text-4xl font-bold">+{{ post.get_images_list()|length - 6
                                    }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if post.video %}
                    <div class="px-6 mt-4">
                        <video controls class="w-full rounded-2xl shadow-2xl">
                            <source src="{{ url_for('static', filename='uploads/' ~ post.video) }}" type="video/mp4">
                        </video>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- T∆∞∆°ng t√°c + Menu 3 ch·∫•m -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div class="flex items-center gap-8">
                        <button onclick="likePost({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-heart text-2xl text-pink-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-pink-700" id="like-count-{{ post.id }}">{{ post.likes }}
                                Th√≠ch</span>
                        </button>
                        <button onclick="toggleComments({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-comment text-2xl text-blue-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-blue-700" id="comment-count-{{ post.id }}">{{
                                post.comments_count }} B√¨nh lu·∫≠n</span>
                        </button>
                        <button onclick="toggleShareMenu({{ post.id }})" class="flex items-center gap-2 group relative">
                            <i class="fas fa-share text-2xl text-green-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-green-700">Chia s·∫ª</span>
                        </button>
                    </div>

                    <div class="relative">
                        <button class="menu-toggle p-3 hover:bg-gray-100 rounded-full transition relative z-50"
                            data-post-id="{{ post.id }}" onclick="toggleMenu({{ post.id }})" style="z-index:1000;">
                            <i class="fas fa-ellipsis-h text-gray-600 text-xl"></i>
                        </button>

                        <!-- MENU BA CH·∫§M -->
                        <div id="menu-{{ post.id }}" class="w-64 bg-white rounded-xl shadow-2xl border overflow-hidden">
                            <button onclick="reportPost({{ post.id }})"
                                class="w-full text-left px-6 py-4 hover:bg-red-50 flex items-center gap-3 text-red-600 transition-all border-b border-gray-100">
                                <i class="fas fa-flag text-lg"></i>
                                <span class="font-semibold">B√°o c√°o b√†i vi·∫øt</span>
                            </button>
                            {% if current_user.is_authenticated
                            and (current_user.id == post.author.id
                            or current_user.role|lower == 'admin') %}
                            <button onclick="deletePost({{ post.id }})" class="w-full text-left px-6 py-4 hover:bg-red-50
           flex items-center gap-3 text-red-600">
                                <i class="fas fa-trash"></i>
                                <span>X√≥a b√†i vi·∫øt</span>
                            </button>
                            {% endif %}

                            {% if current_user.id == post.author.id or current_user.role|lower == 'admin' %}
                            {% else %}
                            <div class="px-6 py-4 text-sm text-gray-400">
                                Kh√¥ng c√≥ h√†nh ƒë·ªông
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ KHUNG B√åNH LU·∫¨N M·ªöI -->
                <div id="comments-section-{{ post.id }}" class="hidden border-t border-gray-100 mt-4 pt-4">
                    <div id="comments-list-{{ post.id }}" class="space-y-4 mb-4">
                        <!-- B√¨nh lu·∫≠n s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                    </div>

                    <div class="mt-6 flex gap-4">
                        <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                            class="w-10 h-10 rounded-full ring-2 ring-pink-200 flex-shrink-0 object-cover">
                        <input type="text" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." id="quick-comment-{{ post.id }}"
                            class="flex-1 px-5 py-3 border border-gray-300 rounded-full focus:ring-4 focus:ring-pink-300 outline-none"
                            onkeypress="if(event.key === 'Enter') quickComment({{ post.id }})">
                        <button onclick="quickComment({{ post.id }})"
                            class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                            <i class="fas fa-paper-plane"></i>
                            G·ª≠i
                        </button>
                    </div>
                </div>

                <!-- Menu chia s·∫ª -->
                <div id="share-menu-{{ post.id }}"
                    class="hidden mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl border-2 border-blue-200">
                    <p class="text-sm font-bold text-gray-700 mb-3">Chia s·∫ª b√†i vi·∫øt ƒë·∫øn:</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareFacebook({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-md">
                            <i class="fab fa-facebook-f text-xl"></i>
                            <span class="font-medium">Facebook</span>
                        </button>
                        <button onclick="shareZalo({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition shadow-md">
                            <i class="fas fa-comment-dots text-xl"></i>
                            <span class="font-medium">Zalo</span>
                        </button>
                        <button onclick="shareTwitter({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fab fa-x-twitter text-xl"></i>
                            <span class="font-medium">Twitter/X</span>
                        </button>
                        <button onclick="shareInstagram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition">
                            <i class="fab fa-instagram text-xl"></i>
                            <span class="font-medium">Instagram</span>
                        </button>
                        <button onclick="shareTelegram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-sky-500 text-white rounded-xl hover:bg-sky-600 transition shadow-md">
                            <i class="fab fa-telegram-plane text-xl"></i>
                            <span class="font-medium">Telegram</span>
                        </button>
                        <button onclick="copyLink({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-700 text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fas fa-link text-xl"></i>
                            <span class="font-medium">Copy link</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-20 bg-white rounded-3xl shadow-xl">
            <i class="fas fa-feather-alt text-8xl text-gray-200 mb-6"></i>
            <p class="text-2xl text-gray-500 font-medium">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
            <a href="{{ url_for('create_post') }}"
                class="mt-6 inline-block px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-xl font-bold rounded-full hover:shadow-2xl transition">
                ƒêƒÉng b√†i ƒë·∫ßu ti√™n
            </a>
        </div>
        {% endif %}
    </div>

    <!-- SIDEBAR PH·∫¢I -->
    <div class="space-y-8">
        <!-- H·ªì s∆° nhanh -->
        <div class="bg-gradient-to-br from-pink-400 to-purple-600 p-8 rounded-3xl text-white shadow-2xl">
            <div class="text-center">
                <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                    class="w-24 h-24 rounded-full mx-auto ring-8 ring-white shadow-2xl mb-4 object-cover">
                <h3 class="text-2xl font-bold">{{ current_user.name }}</h3>
                <p class="mt-2 text-pink-100">{{ current_user.points }} ƒëi·ªÉm t√≠ch l≈©y</p>
                <a href="{{ url_for('profile') }}"
                    class="mt-6 inline-block px-8 py-3 bg-white text-pink-600 rounded-full font-bold hover:shadow-xl transition">
                    C·∫≠p nh·∫≠t h·ªì s∆°
                </a>
            </div>
        </div>

        <!-- B·∫°n b√® -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">B·∫°n b√® ({{ friends|length }})</h3>
            {% if friends %}
            <div class="space-y-3">
                {% for friend in friends %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ url_for('static', filename=friend.avatar or 'images/default-avatar.png') }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <span class="font-medium">{{ friend.name }}</span>
                    </div>
                    <button onclick="openChat({{ friend.id }})" class="text-blue-600 hover:text-blue-700">
                        <i class="fas fa-comment-dots text-xl"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ b·∫°n b√®</p>
            {% endif %}
        </div>

        <!-- G·ª£i √Ω k·∫øt b·∫°n -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">G·ª£i √Ω k·∫øt b·∫°n</h3>
            {% if suggested_users %}
            <div class="space-y-3">
                {% for user in suggested_users %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ url_for('static', filename=user.avatar or 'images/default-avatar.png') }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <span class="font-medium">{{ user.name }}</span>
                    </div>
                    <button onclick="handleFriendAction('{{ user.id }}', 'add_friend', this)"
                        class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full text-sm font-medium hover:shadow-lg transition">
                        K·∫øt b·∫°n
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ g·ª£i √Ω</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast th√¥ng b√°o -->
<div id="toast"
    class="hidden fixed top-20 right-4 bg-white border-l-4 border-green-500 shadow-2xl rounded-lg p-4 z-50 animate-slide-in">
    <div class="flex items-center gap-3">
        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        <span id="toast-message" class="font-medium text-gray-800"></span>
    </div>
</div>

<style>
    @keyframes slide-in {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }

    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* üî• MENU BA CH·∫§M - FIX HO√ÄN CH·ªàNH */
    .post-card {
        position: relative;
        overflow: visible !important;
        /* QUAN TR·ªåNG: B·ªè overflow-hidden */
    }

    [id^="menu-"] {
        position: fixed !important;
        min-width: 240px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(0, 0, 0, 0.08);
        z-index: 99999 !important;

        opacity: 0;
        visibility: hidden;
        transform: scale(0.95);
        transition: all 0.15s ease;
    }

    [id^="menu-"].show {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }

    [id^="menu-"] button {
        display: flex !important;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 16px 20px;
        font-size: 15px;
        font-weight: 500;
        border: none;
        background: none;
        text-align: left;
        transition: background-color 0.15s ease;
        white-space: nowrap;
    }

    [id^="menu-"] button:hover {
        background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%);
    }

    /* ƒê√≥ng t·∫•t c·∫£ menu khi scroll */
    body.menu-open {
        overflow: hidden;
    }
</style>

<script>
    // ‚úÖ H√ÄM M·ªû CHAT - KI·ªÇM TRA B·∫†N B√à TR∆Ø·ªöC
    async function openChat(userId) {
        try {
            // Ki·ªÉm tra tr·∫°ng th√°i b·∫°n b√®
            const response = await fetch(`/friendship_status/${userId}`);
            const data = await response.json();

            if (data.status === 'friends') {
                // N·∫øu l√† b·∫°n b√®, chuy·ªÉn ƒë·∫øn trang chat
                window.location.href = `/chat/${userId}`;
            } else {
                // N·∫øu ch∆∞a l√† b·∫°n b√®, hi·ªÉn th·ªã th√¥ng b√°o
                showToast('B·∫°n c·∫ßn k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y tr∆∞·ªõc khi c√≥ th·ªÉ nh·∫Øn tin!', false);

                // T·ª± ƒë·ªông m·ªü n√∫t k·∫øt b·∫°n
                const button = document.querySelector(`button[onclick*="${userId}"]`);
                if (button && button.textContent.includes('K·∫øt b·∫°n')) {
                    button.click();
                }
            }
        } catch (error) {
            console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i b·∫°n b√®:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• H√ÄM X·ª¨ L√ù K·∫æT B·∫†N - ƒê·ªíNG B·ªò V·ªöI TRANG FRIENDS
    async function handleFriendAction(userId, action, button) {
        try {
            // Th√™m tr·∫°ng th√°i loading ƒë·ªÉ tr√°nh click nhi·ªÅu l·∫ßn
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...';

            let url, method, successMessage;

            switch (action) {
                case 'add_friend':
                    url = `/send_friend_request/${userId}`;
                    method = 'POST';
                    successMessage = 'ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!';
                    break;
                case 'accept_request':
                    // T√¨m request ID tr∆∞·ªõc
                    const response = await fetch(`/friendship_status/${userId}`);
                    const data = await response.json();
                    if (data.pending_request_id) {
                        url = `/accept_friend_request/${data.pending_request_id}`;
                        method = 'POST';
                        successMessage = 'ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n!';
                    }
                    break;
                case 'cancel_request':
                    url = `/cancel_friend_request/${userId}`;
                    method = 'POST';
                    successMessage = 'ƒê√£ h·ªßy l·ªùi m·ªùi k·∫øt b·∫°n!';
                    break;
                case 'unfriend':
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy k·∫øt b·∫°n?')) {
                        url = `/unfriend/${userId}`;
                        method = 'POST';
                        successMessage = 'ƒê√£ h·ªßy k·∫øt b·∫°n!';
                    } else {
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        return;
                    }
                    break;
            }

            if (!url) {
                button.disabled = false;
                button.innerHTML = originalContent;
                return;
            }

            const res = await fetch(url, { method });
            const result = await res.json();

            if (result.success) {
                showToast(result.message || successMessage);

                // C·∫≠p nh·∫≠t UI
                setTimeout(() => {
                    updateFriendButton(userId, button, action);
                }, 500);
            } else {
                showToast(result.error || 'ƒê√£ c√≥ l·ªói x·∫£y ra', false);
                // Kh√¥i ph·ª•c n√∫t n·∫øu l·ªói
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
            // Kh√¥i ph·ª•c n√∫t n·∫øu l·ªói
            button.disabled = false;
            button.innerHTML = originalContent;
        }
    }

    // üî• C·∫¨P NH·∫¨T GIAO DI·ªÜN N√öT K·∫æT B·∫†N - ƒê·ªíNG B·ªò V·ªöI TRANG FRIENDS
    function updateFriendButton(userId, button, currentAction) {
        const container = document.getElementById(`friend-button-${userId}`);
        if (!container) return;

        let newButton, newAction;

        switch (currentAction) {
            case 'add_friend':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'cancel_request', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i class="fas fa-clock mr-2"></i>ƒê√£ g·ª≠i
                    </button>`;
                newAction = 'cancel_request';
                break;
            case 'accept_request':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'unfriend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i class="fas fa-user-minus mr-2"></i>B·∫°n b√®
                    </button>`;
                newAction = 'friends';
                break;
            case 'cancel_request':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'add_friend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                    </button>`;
                newAction = 'add_friend';
                break;
            case 'unfriend':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'add_friend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                    </button>`;
                newAction = 'add_friend';
                break;
        }

        container.innerHTML = newButton;

        // N·∫øu l√† h√†nh ƒë·ªông thay ƒë·ªïi tr·∫°ng th√°i b·∫°n b√®, t·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t sidebar
        if (currentAction === 'accept_request' || currentAction === 'unfriend') {
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }

    // H√†m hi·ªÉn th·ªã toast
    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const icon = toast.querySelector('i');

        toastMessage.textContent = message;

        if (isSuccess) {
            toast.classList.remove('border-red-500');
            toast.classList.add('border-green-500');
            icon.classList.remove('fa-exclamation-circle', 'text-red-500');
            icon.classList.add('fa-check-circle', 'text-green-500');
        } else {
            toast.classList.remove('border-green-500');
            toast.classList.add('border-red-500');
            icon.classList.remove('fa-check-circle', 'text-green-500');
            icon.classList.add('fa-exclamation-circle', 'text-red-500');
        }

        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // ‚úÖ C·∫¨P NH·∫¨T H√ÄM T∆Ø∆†NG T√ÅC
    async function likePost(postId) {
        try {
            const res = await fetch(`/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (res.ok) {
                const data = await res.json();
                const likeCount = document.getElementById(`like-count-${postId}`);
                if (likeCount && data.likes !== undefined) {
                    likeCount.textContent = `${data.likes} Th√≠ch`;
                }
                showToast(data.liked ? 'ƒê√£ th√≠ch b√†i vi·∫øt!' : 'ƒê√£ b·ªè th√≠ch b√†i vi·∫øt!');
            } else {
                showToast('Kh√¥ng th·ªÉ th√≠ch b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    async function quickComment(postId) {
        const input = document.getElementById(`quick-comment-${postId}`);
        const content = input.value.trim();

        if (!content) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', false);
            return;
        }

        try {
            const formData = new FormData();
            formData.append('content', content);

            const res = await fetch(`/comment/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                input.value = '';
                const commentCount = document.getElementById(`comment-count-${postId}`);
                if (commentCount) {
                    const currentCount = parseInt(commentCount.textContent);
                    commentCount.textContent = `${currentCount + 1} B√¨nh lu·∫≠n`;
                }
                showToast('ƒê√£ g·ª≠i b√¨nh lu·∫≠n th√†nh c√¥ng!');
            } else {
                showToast('Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    function addCommentToList(postId, comment) {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        if (!commentsList) return;

        const commentHtml = `
            <div class="flex gap-3 p-3 bg-gray-50 rounded-2xl">
                <img src="{{ url_for('static', filename='') }}${comment.author_avatar}" class="w-10 h-10 rounded-full">
                <div class="flex-1">
                    <h4 class="font-bold text-gray-900">${comment.author_name}</h4>
                    <p class="text-gray-700">${comment.content}</p>
                    <span class="text-sm text-gray-500">${comment.created_at}</span>
                </div>
            </div>
        `;
        commentsList.insertAdjacentHTML('afterbegin', commentHtml);
    }

    function toggleComments(postId) {
        const section = document.getElementById(`comments-section-${postId}`);
        section.classList.toggle('hidden');

        // N·∫øu ƒëang m·ªü v√† ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o, t·∫£i b√¨nh lu·∫≠n
        if (!section.classList.contains('hidden')) {
            loadComments(postId);
        }
    }

    async function loadComments(postId) {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        if (commentsList.children.length > 0) return; // ƒê√£ t·∫£i r·ªìi

        try {
            const res = await fetch(`/comments/${postId}`);
            const comments = await res.json();

            comments.forEach(comment => {
                addCommentToList(postId, {
                    author_name: comment.author.name,
                    author_avatar: comment.author.avatar || 'images/default-avatar.png',
                    content: comment.content,
                    created_at: comment.created_at
                });
            });
        } catch (error) {
            console.error('Error loading comments:', error);
        }
    }

    function focusComment(postId) {
        const input = document.getElementById(`quick-comment-${postId}`);
        if (input) {
            input.focus();
        }
    }

    // üî• H√ÄM TOGGLE MENU M·ªöI - HO√ÄN CH·ªàNH
    function toggleMenu(postId) {
        // ƒë√≥ng menu kh√°c
        document.querySelectorAll('[id^="menu-"]').forEach(m => {
            if (m.id !== `menu-${postId}`) m.classList.remove('show');
        });

        const menu = document.getElementById(`menu-${postId}`);
        const button = document.querySelector(
            `.menu-toggle[data-post-id="${postId}"]`
        );

        if (!menu || !button) return;

        if (menu.classList.contains('show')) {
            menu.classList.remove('show');
            return;
        }

        // üìê L·∫§Y V·ªä TR√ç N√öT 3 CH·∫§M
        const rect = button.getBoundingClientRect();

        const menuWidth = menu.offsetWidth || 240;
        const spacing = 8;

        let top = rect.bottom + spacing;
        let left = rect.right - menuWidth;

        // üß† Kh√¥ng cho tr√†n m√†n h√¨nh
        if (left < 8) left = 8;
        if (top + menu.offsetHeight > window.innerHeight) {
            top = rect.top - menu.offsetHeight - spacing;
        }

        menu.style.top = `${top}px`;
        menu.style.left = `${left}px`;

        menu.classList.add('show');
    }

    function toggleShareMenu(postId) {
        document.querySelectorAll('[id^="menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
            if (menu.id !== 'share-menu-' + postId) menu.classList.add('hidden');
        });
        document.getElementById('share-menu-' + postId).classList.toggle('hidden');
    }

    function shareFacebook(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Facebook ƒë·ªÉ chia s·∫ª...');
    }

    function shareZalo(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://zalo.me/share?url=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Zalo ƒë·ªÉ chia s·∫ª...');
    }

    function shareTwitter(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Twitter/X ƒë·ªÉ chia s·∫ª...');
    }

    function shareInstagram(postId) {
        showToast('Instagram kh√¥ng h·ªó tr·ª£ chia s·∫ª link tr·ª±c ti·∫øp. Vui l√≤ng copy link v√† d√°n v√†o story/bio!', false);
        copyLink(postId);
    }

    function shareTelegram(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Telegram ƒë·ªÉ chia s·∫ª...');
    }

    async function copyLink(postId) {
        const url = window.location.origin + '/post/' + postId;
        try {
            await navigator.clipboard.writeText(url);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        } catch (err) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        }
    }

    async function reportPost(postId) {
        const reason = prompt('L√Ω do b√°o c√°o b√†i vi·∫øt:');
        if (!reason) return;

        try {
            const formData = new FormData();
            formData.append('reason', reason);

            const res = await fetch(`/report/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            showToast(data.success ? 'ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!' : data.error || 'L·ªói khi b√°o c√°o', !!data.success);
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    async function deletePost(postId) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;

        try {
            const res = await fetch(`/post/${postId}/delete`, { method: 'POST' });
            if (res.ok) {
                showToast('ƒê√£ x√≥a b√†i vi·∫øt th√†nh c√¥ng!');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // ƒê√≥ng menu khi click b√™n ngo√†i
    // S·ª¨A CH·ªñ N√ÄY ƒê·ªÇ FIX L·ªñI MENU BA CH·∫§M BI·∫æN M·∫§T
    document.addEventListener('click', function (event) {
        // Ki·ªÉm tra xem click c√≥ ph·∫£i v√†o n√∫t m·ªü menu hay v√†o b√™n trong menu kh√¥ng
        const clickedMenuButton = event.target.closest('button[onclick^="toggleMenu("]');
        const clickedInsideMenu = event.target.closest('[id^="menu-"]');

        const clickedShareButton = event.target.closest('button[onclick^="toggleShareMenu("]');
        const clickedInsideShareMenu = event.target.closest('[id^="share-menu-"]');

        // Ch·ªâ ƒë√≥ng menu n·∫øu click HO√ÄN TO√ÄN B√äN NGO√ÄI
        if (!clickedMenuButton && !clickedInsideMenu) {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        if (!clickedShareButton && !clickedInsideShareMenu) {
            document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    console.log('üéâ Home page with Facebook-style friend system loaded!');
</script>
{% endblock %}