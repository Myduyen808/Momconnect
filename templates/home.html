{% extends "base.html" %}
{% block title %}Trang ch·ªß{% endblock %}

{% block content %}
<div class="grid lg:grid-cols-3 gap-8 max-w-7xl mx-auto px-4 py-8">
    <!-- C·ªòT CH√çNH - B√ÄI VI·∫æT -->
    <div class="lg:col-span-2 space-y-8">
        <!-- B·ªò L·ªåC CH·ª¶ ƒê·ªÄ -->
        <div class="flex flex-wrap gap-3">
            {% for cat in categories %}
            <a href="{{ url_for('home', category=cat) }}"
                class="px-6 py-3 rounded-full font-medium transition-all shadow-sm
                    {% if selected_category == cat %}bg-gradient-to-r from-pink-500 to-purple-600 text-white shadow-lg{% else %}bg-white text-gray-700 hover:shadow-md{% endif %}">
                {{ category_names[cat] }}
            </a>
            {% endfor %}
        </div>

        <!-- DANH S√ÅCH B√ÄI VI·∫æT -->
        {% if posts %}
        {% for post in posts %}
        <div class="bg-white rounded-3xl shadow-xl overflow-hidden hover:shadow-2xl transition-all">
            <!-- Header b√†i vi·∫øt -->
            <div class="p-6 pb-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <img src="{{ post.author.avatar_url or url_for('static', filename='uploads/default.jpg') }}"
                            class="w-14 h-14 rounded-full object-cover ring-4 ring-pink-200 shadow-lg">
                        <div>
                            <div class="flex items-center gap-3">
                                <h3 class="text-xl font-bold text-gray-900">{{ post.author.name }}</h3>
                                {% if post.author.is_verified_expert %}
                                <span
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                    <i class="fas fa-stethoscope"></i> Chuy√™n gia
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                <i class="far fa-clock"></i>
                                {{ post.created_at.strftime('%H:%M ‚Ä¢ %d/%m/%Y') }}
                            </p>
                        </div>
                    </div>

                    <!-- N√∫t theo d√µi (ƒê√É S·ª¨A) -->
                    <!-- N√∫t theo d√µi SA - S·ª¨A L·∫†I -->
                    {% if current_user.is_authenticated and post.author.id != current_user.id %}
                    <button onclick="toggleFollow({{ post.author.id }}, this)"
                        data-following="{% if current_user in post.author.followers %}true{% else %}false{% endif %}"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md follow-btn 
               {% if current_user in post.author.followers %}
               bg-gray-200 text-gray-700 hover:bg-gray-300 
               {% else %}
               bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg 
               {% endif %}">
                        <span class="follow-text">
                            {% if current_user in post.author.followers %}
                            H·ªßy theo d√µi
                            {% else %}
                            Theo d√µi
                            {% endif %}
                        </span>
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- N·ªôi dung b√†i vi·∫øt -->
            <div class="p-6 pt-4">
                <a href="{{ url_for('post_detail', post_id=post.id) }}" class="block">
                    <h2 class="text-2xl font-bold text-gray-900 hover:text-pink-600 transition mb-3">
                        {{ post.title }}
                    </h2>
                    <p class="text-gray-700 leading-relaxed line-clamp-3 mb-4">
                        {{ post.content | truncate(300) }}
                    </p>
                </a>

                <!-- Ch·ªß ƒë·ªÅ + badge -->
                <div class="flex items-center gap-4 mb-4">
                    <span class="px-4 py-2 rounded-full text-sm font-medium
                    {% if post.category == 'health' %}bg-green-100 text-green-700
                    {% elif post.category == 'nutrition' %}bg-yellow-100 text-yellow-700
                    {% elif post.category == 'story' %}bg-purple-100 text-purple-700
                    {% elif post.category == 'tips' %}bg-blue-100 text-blue-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {{ category_names[post.category] }}
                    </span>
                    {% if post.is_expert_post %}
                    <span
                        class="bg-gradient-to-r from-teal-500 to-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold">
                        T∆∞ v·∫•n chuy√™n gia
                    </span>
                    {% endif %}
                </div>

                <!-- Media (·∫£nh + video) -->
                {% if post.get_images_list() or post.video %}
                <div class="mb-6 -mx-6">
                    {% if post.get_images_list() %}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 px-6">
                        {% for img in post.get_images_list()[:6] %}
                        <div class="relative group overflow-hidden rounded-2xl shadow-lg bg-gray-100">
                            <img src="{{ url_for('static', filename='uploads/' ~ img) }}"
                                class="w-full h-64 object-cover hover:scale-110 transition duration-500">
                            {% if loop.index == 6 and post.get_images_list()|length > 6 %}
                            <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center">
                                <span class="text-white text-4xl font-bold">+{{ post.get_images_list()|length - 6
                                    }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if post.video %}
                    <div class="px-6 mt-4">
                        <video controls class="w-full rounded-2xl shadow-2xl">
                            <source src="{{ url_for('static', filename='uploads/' ~ post.video) }}" type="video/mp4">
                        </video>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- T∆∞∆°ng t√°c + Menu 3 ch·∫•m -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div class="flex items-center gap-8">
                        <button onclick="likePost({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-heart text-2xl text-pink-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-pink-700" id="like-count-{{ post.id }}">{{ post.likes }}
                                Th√≠ch</span>
                        </button>
                        <button onclick="focusComment({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-comment text-2xl text-blue-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-blue-700" id="comment-count-{{ post.id }}">{{
                                post.comments_count }} B√¨nh lu·∫≠n</span>
                        </button>
                        <button onclick="toggleShareMenu({{ post.id }})" class="flex items-center gap-2 group relative">
                            <i class="fas fa-share text-2xl text-green-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-green-700">Chia s·∫ª</span>
                        </button>
                    </div>

                    <div class="relative">
                        <button onclick="toggleMenu({{ post.id }})"
                            class="p-3 hover:bg-gray-100 rounded-full transition">
                            <i class="fas fa-ellipsis-h text-gray-600 text-xl"></i>
                        </button>
                        <div id="menu-{{ post.id }}"
                            class="hidden absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-2xl border z-30 overflow-hidden">
                            <button onclick="reportPost({{ post.id }})"
                                class="w-full text-left px-5 py-3 hover:bg-gray-50 flex items-center gap-3 text-red-600">
                                <i class="fas fa-flag"></i> B√°o c√°o b√†i vi·∫øt
                            </button>
                            {% if current_user.id == post.user_id or current_user.role == 'admin' %}
                            <button onclick="deletePost({{ post.id }})"
                                class="w-full text-left px-5 py-3 hover:bg-red-50 flex items-center gap-3 text-red-600">
                                <i class="fas fa-trash"></i> X√≥a b√†i vi·∫øt
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Menu chia s·∫ª (M·ªöI TH√äM) -->
                <div id="share-menu-{{ post.id }}"
                    class="hidden mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl border-2 border-blue-200">
                    <p class="text-sm font-bold text-gray-700 mb-3">Chia s·∫ª b√†i vi·∫øt ƒë·∫øn:</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareFacebook({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-md">
                            <i class="fab fa-facebook-f text-xl"></i>
                            <span class="font-medium">Facebook</span>
                        </button>
                        <button onclick="shareZalo({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition shadow-md">
                            <i class="fas fa-comment-dots text-xl"></i>
                            <span class="font-medium">Zalo</span>
                        </button>
                        <button onclick="shareTwitter({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fab fa-x-twitter text-xl"></i>
                            <span class="font-medium">Twitter/X</span>
                        </button>
                        <button onclick="shareInstagram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition">
                            <i class="fab fa-instagram text-xl"></i>
                            <span class="font-medium">Instagram</span>
                        </button>
                        <button onclick="shareTelegram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-sky-500 text-white rounded-xl hover:bg-sky-600 transition shadow-md">
                            <i class="fab fa-telegram-plane text-xl"></i>
                            <span class="font-medium">Telegram</span>
                        </button>
                        <button onclick="copyLink({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-700 text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fas fa-link text-xl"></i>
                            <span class="font-medium">Copy link</span>
                        </button>
                    </div>
                </div>

                <!-- B√¨nh lu·∫≠n nhanh (ƒê√É S·ª¨A) -->
                <div class="mt-6 flex gap-4">
                    <img src="{{ current_user.avatar_url or url_for('static', filename='uploads/default.jpg') }}"
                        class="w-10 h-10 rounded-full ring-2 ring-pink-200 flex-shrink-0 object-cover">
                    <input type="text" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." id="quick-comment-{{ post.id }}"
                        class="flex-1 px-5 py-3 border border-gray-300 rounded-full focus:ring-4 focus:ring-pink-300 outline-none"
                        onkeypress="if(event.key === 'Enter') quickComment({{ post.id }})">
                    <button onclick="quickComment({{ post.id }})"
                        class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                        <i class="fas fa-paper-plane"></i>
                        G·ª≠i
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-20 bg-white rounded-3xl shadow-xl">
            <i class="fas fa-feather-alt text-8xl text-gray-200 mb-6"></i>
            <p class="text-2xl text-gray-500 font-medium">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
            <a href="{{ url_for('create_post') }}"
                class="mt-6 inline-block px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-xl font-bold rounded-full hover:shadow-2xl transition">
                ƒêƒÉng b√†i ƒë·∫ßu ti√™n
            </a>
        </div>
        {% endif %}
    </div>

    <!-- SIDEBAR PH·∫¢I -->
    <div class="space-y-8">
        <!-- H·ªì s∆° nhanh -->
        <div class="bg-gradient-to-br from-pink-400 to-purple-600 p-8 rounded-3xl text-white shadow-2xl">
            <div class="text-center">
                <img src="{{ current_user.avatar_url or url_for('static', filename='images/default.jpg') }}"
                    class="w-24 h-24 rounded-full mx-auto ring-8 ring-white shadow-2xl mb-4 object-cover">
                <h3 class="text-2xl font-bold">{{ current_user.name }}</h3>
                <p class="mt-2 text-pink-100">{{ current_user.points }} ƒëi·ªÉm t√≠ch l≈©y</p>
                <a href="{{ url_for('profile') }}"
                    class="mt-6 inline-block px-8 py-3 bg-white text-pink-600 rounded-full font-bold hover:shadow-xl transition">
                    C·∫≠p nh·∫≠t h·ªì s∆°
                </a>
            </div>
        </div>

        <!-- B·∫°n b√® -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">B·∫°n b√® ({{ friends|length }})</h3>
            {% if friends %}
            <div class="space-y-3">
                {% for friend in friends %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ friend.avatar_url }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <span class="font-medium">{{ friend.name }}</span>
                    </div>
                    <a href="{{ url_for('chat', user_id=friend.id) }}" class="text-blue-600 hover:text-blue-700">
                        <i class="fas fa-comment-dots text-xl"></i>
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ b·∫°n b√®</p>
            {% endif %}
        </div>

        <!-- G·ª£i √Ω k·∫øt b·∫°n -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">G·ª£i √Ω k·∫øt b·∫°n</h3>
            {% if suggested_users %}
            <div class="space-y-3">
                {% for user in suggested_users %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ user.avatar_url }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <span class="font-medium">{{ user.name }}</span>
                    </div>
                    <form method="POST" action="{{ url_for('send_friend_request', user_id=user.id) }}">
                        <button
                            class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full text-sm font-medium hover:shadow-lg transition">
                            K·∫øt b·∫°n
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ g·ª£i √Ω</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast th√¥ng b√°o (M·ªöI TH√äM) -->
<div id="toast"
    class="hidden fixed top-20 right-4 bg-white border-l-4 border-green-500 shadow-2xl rounded-lg p-4 z-50 animate-slide-in">
    <div class="flex items-center gap-3">
        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        <span id="toast-message" class="font-medium text-gray-800"></span>
    </div>
</div>

<style>
    @keyframes slide-in {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }
</style>

<script>
    // H√†m hi·ªÉn th·ªã toast th√¥ng b√°o
    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const icon = toast.querySelector('i');

        toastMessage.textContent = message;

        if (isSuccess) {
            toast.classList.remove('border-red-500');
            toast.classList.add('border-green-500');
            icon.classList.remove('fa-exclamation-circle', 'text-red-500');
            icon.classList.add('fa-check-circle', 'text-green-500');
        } else {
            toast.classList.remove('border-green-500');
            toast.classList.add('border-red-500');
            icon.classList.remove('fa-check-circle', 'text-green-500');
            icon.classList.add('fa-exclamation-circle', 'text-red-500');
        }

        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Like b√†i vi·∫øt (ƒê√É S·ª¨A)
    async function likePost(postId) {
        try {
            const res = await fetch(`/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (res.ok) {
                const data = await res.json();
                const likeCount = document.getElementById(`like-count-${postId}`);
                if (likeCount && data.likes !== undefined) {
                    likeCount.textContent = `${data.likes} Th√≠ch`;
                }
                showToast(data.liked ? 'ƒê√£ th√≠ch b√†i vi·∫øt!' : 'ƒê√£ b·ªè th√≠ch b√†i vi·∫øt!');
            } else {
                showToast('Kh√¥ng th·ªÉ th√≠ch b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // B√¨nh lu·∫≠n nhanh (ƒê√É S·ª¨A)
    async function quickComment(postId) {
        const input = document.getElementById(`quick-comment-${postId}`);
        const content = input.value.trim();

        if (!content) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', false);
            return;
        }

        try {
            const formData = new FormData();
            formData.append('content', content);

            const res = await fetch(`/comment/${postId}`, {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                input.value = '';
                const commentCount = document.getElementById(`comment-count-${postId}`);
                if (commentCount) {
                    const currentCount = parseInt(commentCount.textContent);
                    commentCount.textContent = `${currentCount + 1} B√¨nh lu·∫≠n`;
                }
                showToast('ƒê√£ g·ª≠i b√¨nh lu·∫≠n th√†nh c√¥ng!');
            } else {
                showToast('Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // Focus v√†o √¥ b√¨nh lu·∫≠n
    function focusComment(postId) {
        const input = document.getElementById(`quick-comment-${postId}`);
        if (input) {
            input.focus();
        }
    }

    // Theo d√µi ng∆∞·ªùi d√πng (ƒê√É S·ª¨A)
    // Theo d√µi ng∆∞·ªùi d√πng SA - S·ª¨A HO√ÄN CH·ªàNH
    async function toggleFollow(userId, btn) {
        try {
            const res = await fetch(`/follow/${userId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: btn.querySelector('.follow-text').textContent.includes('H·ªßy') ? 'unfollow' : 'follow' })
            });

            if (res.ok) {
                const data = await res.json();
                const isFollowing = data.following;
                const followText = btn.querySelector('.follow-text');

                if (isFollowing) {
                    // ƒêANG theo d√µi -> n√∫t x√°m "H·ªßy theo d√µi"
                    btn.classList.remove('bg-gradient-to-r', 'from-pink-500', 'to-purple-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    followText.textContent = 'H·ªßy theo d√µi';
                    showToast('ƒê√£ theo d√µi th√†nh c√¥ng!', true);
                } else {
                    // B·ªé theo d√µi -> n√∫t gradient "Theo d√µi"
                    btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    btn.classList.add('bg-gradient-to-r', 'from-pink-500', 'to-purple-600', 'text-white');
                    followText.textContent = 'Theo d√µi';
                    showToast('ƒê√£ b·ªè theo d√µi!', true);
                }

                btn.setAttribute('data-following', isFollowing);
            } else {
                showToast('Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c!', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi!', false);
        }
    }


    // Toggle menu 3 ch·∫•m
    function toggleMenu(postId) {
        document.querySelectorAll('[id^="menu-"]').forEach(menu => {
            if (menu.id !== 'menu-' + postId) menu.classList.add('hidden');
        });
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
        document.getElementById('menu-' + postId).classList.toggle('hidden');
    }

    // Toggle menu chia s·∫ª (M·ªöI)
    function toggleShareMenu(postId) {
        document.querySelectorAll('[id^="menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
            if (menu.id !== 'share-menu-' + postId) menu.classList.add('hidden');
        });
        document.getElementById('share-menu-' + postId).classList.toggle('hidden');
    }

    // Chia s·∫ª l√™n Facebook
    function shareFacebook(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Facebook ƒë·ªÉ chia s·∫ª...');
    }

    // Chia s·∫ª l√™n Zalo
    function shareZalo(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://zalo.me/share?url=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Zalo ƒë·ªÉ chia s·∫ª...');
    }

    // Chia s·∫ª l√™n Twitter/X (M·ªöI)
    function shareTwitter(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Twitter/X ƒë·ªÉ chia s·∫ª...');
    }

    // Chia s·∫ª l√™n Instagram (M·ªöI - l∆∞u √Ω Instagram kh√¥ng h·ªó tr·ª£ chia s·∫ª link tr·ª±c ti·∫øp)
    function shareInstagram(postId) {
        showToast('Instagram kh√¥ng h·ªó tr·ª£ chia s·∫ª link tr·ª±c ti·∫øp. Vui l√≤ng copy link v√† d√°n v√†o story/bio!', false);
        copyLink(postId);
    }

    // Chia s·∫ª l√™n Telegram (M·ªöI)
    function shareTelegram(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Telegram ƒë·ªÉ chia s·∫ª...');
    }

    // Copy link (M·ªöI)
    async function copyLink(postId) {
        const url = window.location.origin + '/post/' + postId;
        try {
            await navigator.clipboard.writeText(url);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        } catch (err) {
            // Fallback cho tr√¨nh duy·ªát c≈©
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        }
    }

    // B√°o c√°o b√†i vi·∫øt
    async function reportPost(postId) {
        const reason = prompt('L√Ω do b√°o c√°o b√†i vi·∫øt:');
        if (!reason) return;

        try {
            const formData = new FormData();
            formData.append('reason', reason);

            const res = await fetch(`/report/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            showToast(data.success ? 'ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!' : data.error || 'L·ªói khi b√°o c√°o', !!data.success);
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // X√≥a b√†i vi·∫øt
    async function deletePost(postId) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;

        try {
            const res = await fetch(`/post/${postId}/delete`, { method: 'POST' });
            if (res.ok) {
                showToast('ƒê√£ x√≥a b√†i vi·∫øt th√†nh c√¥ng!');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // ƒê√≥ng menu khi click b√™n ngo√†i
    document.addEventListener('click', function (event) {
        const isMenuButton = event.target.closest('[onclick^="toggleMenu"]');
        const isShareButton = event.target.closest('[onclick^="toggleShareMenu"]');
        const isMenu = event.target.closest('[id^="menu-"]');
        const isShareMenu = event.target.closest('[id^="share-menu-"]');

        if (!isMenuButton && !isMenu) {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }

        if (!isShareButton && !isShareMenu) {
            document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // X·ª≠ l√Ω scroll ƒë·ªÉ ·∫©n menu
    let lastScrollTop = 0;
    window.addEventListener('scroll', function () {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (Math.abs(scrollTop - lastScrollTop) > 50) {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
            document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }

        lastScrollTop = scrollTop;
    });

    // Lazy loading cho ·∫£nh
    document.addEventListener('DOMContentLoaded', function () {
        const images = document.querySelectorAll('img[src]');

        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.classList.add('loaded');
                    observer.unobserve(img);
                }
            });
        });

        images.forEach(img => imageObserver.observe(img));
    });

    // X·ª≠ l√Ω video t·ª± ƒë·ªông pause khi kh√¥ng trong viewport
    document.addEventListener('DOMContentLoaded', function () {
        const videos = document.querySelectorAll('video');

        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                if (!entry.isIntersecting) {
                    video.pause();
                }
            });
        }, { threshold: 0.5 });

        videos.forEach(video => videoObserver.observe(video));
    });

    // Debounce function ƒë·ªÉ t·ªëi ∆∞u performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // X·ª≠ l√Ω infinite scroll (t√πy ch·ªçn)
    let isLoading = false;
    let currentPage = 1;

    const handleScroll = debounce(function () {
        const scrollHeight = document.documentElement.scrollHeight;
        const scrollTop = document.documentElement.scrollTop;
        const clientHeight = document.documentElement.clientHeight;

        if (scrollTop + clientHeight >= scrollHeight - 500 && !isLoading) {
            loadMorePosts();
        }
    }, 200);

    async function loadMorePosts() {
        if (isLoading) return;

        isLoading = true;
        currentPage++;

        try {
            const res = await fetch(`/api/posts?page=${currentPage}`);
            if (res.ok) {
                const data = await res.json();
                if (data.posts && data.posts.length > 0) {
                    appendPosts(data.posts);
                } else {
                    // Kh√¥ng c√≤n b√†i vi·∫øt n√†o
                    window.removeEventListener('scroll', handleScroll);
                }
            }
        } catch (error) {
            console.error('Error loading more posts:', error);
        } finally {
            isLoading = false;
        }
    }

    function appendPosts(posts) {
        const postsContainer = document.querySelector('.lg\\:col-span-2');
        // Logic th√™m b√†i vi·∫øt v√†o DOM
        // C·∫ßn implement d·ª±a tr√™n c·∫•u tr√∫c HTML c·ªßa b√†i vi·∫øt
    }

    // Uncomment d√≤ng d∆∞·ªõi ƒë·ªÉ enable infinite scroll
    // window.addEventListener('scroll', handleScroll);

    // Preview ·∫£nh tr∆∞·ªõc khi t·∫£i l√™n (n·∫øu c√≥ form t·∫°o b√†i vi·∫øt)
    function previewImages(input) {
        const preview = document.getElementById('image-preview');
        if (!preview) return;

        preview.innerHTML = '';

        if (input.files) {
            Array.from(input.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();

                    reader.onload = function (e) {
                        const div = document.createElement('div');
                        div.className = 'relative group';
                        div.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-48 object-cover rounded-xl shadow-lg">
                            <button type="button" onclick="removePreviewImage(${index})" 
                                class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        preview.appendChild(div);
                    };

                    reader.readAsDataURL(file);
                }
            });
        }
    }

    // Double-tap to like (mobile friendly)
    let lastTap = 0;
    document.addEventListener('DOMContentLoaded', function () {
        const postCards = document.querySelectorAll('.bg-white.rounded-3xl');

        postCards.forEach(card => {
            card.addEventListener('touchend', function (e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;

                if (tapLength < 300 && tapLength > 0) {
                    // Double tap detected
                    const postId = this.querySelector('[onclick^="likePost"]')?.onclick.toString().match(/\d+/)?.[0];
                    if (postId) {
                        likePost(parseInt(postId));

                        // Hi·ªáu ·ª©ng tim bay l√™n
                        const heart = document.createElement('div');
                        heart.innerHTML = '<i class="fas fa-heart"></i>';
                        heart.className = 'heart-animation';
                        heart.style.cssText = `
                            position: fixed;
                            left: ${e.changedTouches[0].clientX}px;
                            top: ${e.changedTouches[0].clientY}px;
                            font-size: 80px;
                            color: #ec4899;
                            z-index: 9999;
                            pointer-events: none;
                            animation: heartFloat 1s ease-out forwards;
                        `;
                        document.body.appendChild(heart);

                        setTimeout(() => heart.remove(), 1000);
                    }
                }
                lastTap = currentTime;
            });
        });
    });

    // Th√™m CSS animation cho tim bay l√™n
    const style = document.createElement('style');
    style.textContent = `
        @keyframes heartFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0);
            }
            50% {
                opacity: 1;
                transform: translateY(-50px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.2);
            }
        }
        
        img:not(.loaded) {
            filter: blur(10px);
            transition: filter 0.3s;
        }
        
        img.loaded {
            filter: blur(0);
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    `;
    document.head.appendChild(style);

    // T·ª± ƒë·ªông l∆∞u draft b√¨nh lu·∫≠n (localStorage)
    const commentInputs = document.querySelectorAll('[id^="quick-comment-"]');
    commentInputs.forEach(input => {
        const postId = input.id.replace('quick-comment-', '');

        // Load draft t·ª´ localStorage
        const draft = localStorage.getItem(`comment-draft-${postId}`);
        if (draft) {
            input.value = draft;
        }

        // Save draft khi typing
        input.addEventListener('input', debounce(function () {
            if (this.value.trim()) {
                localStorage.setItem(`comment-draft-${postId}`, this.value);
            } else {
                localStorage.removeItem(`comment-draft-${postId}`);
            }
        }, 500));

        // X√≥a draft khi g·ª≠i comment
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                localStorage.removeItem(`comment-draft-${postId}`);
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // ESC ƒë·ªÉ ƒë√≥ng t·∫•t c·∫£ menu
        if (e.key === 'Escape') {
            document.querySelectorAll('[id^="menu-"], [id^="share-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // X·ª≠ l√Ω emoji cho b√¨nh lu·∫≠n (t√πy ch·ªçn)
    function insertEmoji(emoji, postId) {
        const input = document.getElementById(`quick-comment-${postId}`);
        if (input) {
            input.value += emoji;
            input.focus();
        }
    }

    // Loading state cho c√°c button
    function setButtonLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalHtml || button.innerHTML;
        }
    }

    // Confirmation dialog ƒë·∫πp h∆°n
    function confirmDialog(message, callback) {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        dialog.innerHTML = `
            <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl transform transition-all">
                <div class="text-center mb-6">
                    <i class="fas fa-exclamation-circle text-6xl text-yellow-500 mb-4"></i>
                    <p class="text-xl font-bold text-gray-800">${message}</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="this.closest('.fixed').remove()" 
                        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-full font-bold hover:bg-gray-300 transition">
                        H·ªßy
                    </button>
                    <button id="confirm-btn"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-red-500 to-pink-600 text-white rounded-full font-bold hover:shadow-lg transition">
                        X√°c nh·∫≠n
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(dialog);

        dialog.querySelector('#confirm-btn').addEventListener('click', function () {
            callback();
            dialog.remove();
        });

        dialog.addEventListener('click', function (e) {
            if (e.target === dialog) {
                dialog.remove();
            }
        });
    }

    // C·∫≠p nh·∫≠t deletePost ƒë·ªÉ d√πng confirmDialog
    async function deletePostWithDialog(postId) {
        confirmDialog('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?', async function () {
            try {
                const res = await fetch(`/post/${postId}/delete`, { method: 'POST' });
                if (res.ok) {
                    showToast('ƒê√£ x√≥a b√†i vi·∫øt th√†nh c√¥ng!');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt', false);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('L·ªói k·∫øt n·ªëi', false);
            }
        });
    }

    // Analytics tracking (t√πy ch·ªçn)
    function trackEvent(category, action, label) {
        if (typeof gtag !== 'undefined') {
            gtag('event', action, {
                'event_category': category,
                'event_label': label
            });
        }
        console.log('Event tracked:', category, action, label);
    }

    // Track user interactions
    document.addEventListener('click', function (e) {
        if (e.target.closest('[onclick^="likePost"]')) {
            trackEvent('Engagement', 'Like', 'Post');
        } else if (e.target.closest('[onclick^="quickComment"]')) {
            trackEvent('Engagement', 'Comment', 'Post');
        } else if (e.target.closest('[onclick^="shareFacebook"]')) {
            trackEvent('Share', 'Facebook', 'Post');
        } else if (e.target.closest('[onclick^="shareZalo"]')) {
            trackEvent('Share', 'Zalo', 'Post');
        }
    });

    console.log('üéâ Home page scripts loaded successfully!');
</script>
{% endblock %}