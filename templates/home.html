{% extends "base.html" %}
{% block title %}Trang ch·ªß{% endblock %}

{% block content %}
<div class="grid lg:grid-cols-3 gap-8 max-w-7xl mx-auto px-4 py-8">
    <!-- C·ªòT CH√çNH - B√ÄI VI·∫æT -->
    <div class="lg:col-span-2 space-y-8">
        <!-- B·ªò L·ªåC CH·ª¶ ƒê·ªÄ -->
        <div class="flex flex-wrap gap-3">
            {% for cat in categories %}
            <a href="{{ url_for('home', category=cat) }}"
                class="px-6 py-3 rounded-full font-medium transition-all shadow-sm
                    {% if selected_category == cat %}bg-gradient-to-r from-pink-500 to-purple-600 text-white shadow-lg{% else %}bg-white text-gray-700 hover:shadow-md{% endif %}">
                {{ category_names[cat] }}
            </a>
            {% endfor %}
        </div>

        <!-- DANH S√ÅCH B√ÄI VI·∫æT -->
        {% if posts %}
        {% for post in posts %}
        <div class="bg-white rounded-3xl shadow-xl post-card overflow-visible hover:shadow-2xl transition-all">
            <!-- Header b√†i vi·∫øt -->
            <div class="p-6 pb-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <img src="{{ url_for('static', filename=post.author.avatar or 'images/default-avatar.png') }}"
                            class="w-14 h-14 rounded-full object-cover ring-4 ring-pink-200 shadow-lg">
                        <div>
                            <div class="flex items-center gap-3">
                                <div class="flex flex-col">
                                    <!-- T√äN NG∆Ø·ªúI D√ôNG -->
                                    <a href="{{ url_for('user_profile', user_id=post.author.id) }}"
                                        class="text-xl font-bold text-gray-900 hover:text-pink-600 hover:underline transition">
                                        {{ post.author.name }}
                                    </a>

                                    <!-- HUY HI·ªÜU CH·ªà HI·ªÜN N·∫æU KH√îNG PH·∫¢I ADMIN -->
                                    {% if post.author.role != 'admin' %}
                                    <div class="flex items-center gap-2 mt-1">
                                        <i class="fas fa-medal text-sm
                                            {% if '·ª®ng vi√™n Chuy√™n gia' in post.author.badge %}text-purple-600
                                            {% elif 'Th√†nh Vi√™n B·∫°c' in post.author.badge %}text-gray-500
                                            {% elif 'Th√†nh Vi√™n ƒê·ªìng' in post.author.badge %}text-orange-500
                                            {% else %}text-green-600{% endif %}"></i>
                                        <span class="text-sm font-medium
                                            {% if '·ª®ng vi√™n Chuy√™n gia' in post.author.badge %}text-purple-600
                                            {% elif 'Th√†nh Vi√™n B·∫°c' in post.author.badge %}text-gray-600
                                            {% elif 'Th√†nh Vi√™n ƒê·ªìng' in post.author.badge %}text-orange-600
                                            {% else %}text-green-700{% endif %}">
                                            {{ post.author.badge }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if post.author.is_verified_expert %}
                                <span
                                    class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                    <i class="fas fa-stethoscope"></i> Chuy√™n gia
                                </span>
                                {% endif %}
                            </div>
                            <p class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                <i class="far fa-clock"></i>
                                {{ post.created_at | vietnam_time }}
                            </p>
                        </div>
                    </div>

                    <!-- N√öT K·∫æT B·∫†N GI·ªêNG FACEBOOK -->
                    {% if current_user.is_authenticated and post.author.id != current_user.id %}
                    <div id="friend-button-{{ post.author.id }}">
                        {% set friendship_status = current_user.get_friendship_status(post.author.id) %}

                        {% if friendship_status == 'friends' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'unfriend', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                            <i class="fas fa-user-minus mr-2"></i>B·∫°n b√®
                        </button>

                        {% elif friendship_status == 'incoming_request' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'accept_request', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-blue-600 text-white hover:bg-blue-700">
                            <i class="fas fa-user-check mr-2"></i>Ch·∫•p nh·∫≠n
                        </button>

                        {% elif friendship_status == 'outgoing_request' %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'cancel_request', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                            <i class="fas fa-clock mr-2"></i>ƒê√£ g·ª≠i
                        </button>

                        {% else %}
                        <button onclick="handleFriendAction('{{ post.author.id }}', 'add_friend', this)"
                            class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- N·ªôi dung b√†i vi·∫øt -->
            <div class="p-6 pt-4">
                <a href="{{ url_for('post_detail', post_id=post.id) }}" onclick="trackView({{ post.id }})"
                    class="block">
                    <h2 class="text-2xl font-bold text-gray-900 hover:text-pink-600 transition mb-3">
                        {{ post.title }}
                    </h2>
                    <p class="text-gray-700 leading-relaxed line-clamp-3 mb-4">
                        {{ post.content | truncate(300) }}
                    </p>
                </a>

                <!-- Ch·ªß ƒë·ªÅ + badge -->
                <div class="flex items-center gap-4 mb-4">
                    <span class="px-4 py-2 rounded-full text-sm font-medium
                    {% if post.category == 'health' %}bg-green-100 text-green-700
                    {% elif post.category == 'nutrition' %}bg-yellow-100 text-yellow-700
                    {% elif post.category == 'story' %}bg-purple-100 text-purple-700
                    {% elif post.category == 'tips' %}bg-blue-100 text-blue-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                        {{ category_names[post.category] }}
                    </span>
                    {% if post.is_expert_post %}
                    <span
                        class="bg-gradient-to-r from-teal-500 to-blue-600 text-white px-4 py-2 rounded-full text-sm font-bold">
                        T∆∞ v·∫•n chuy√™n gia
                    </span>
                    {% endif %}
                </div>

                <!-- Media (·∫£nh + video) -->
                {% if post.get_images_list() or post.video %}
                <div class="mb-6 -mx-6">
                    {% if post.get_images_list() %}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 px-6">
                        {% for img in post.get_images_list()[:6] %}
                        <div class="relative group overflow-hidden rounded-2xl shadow-lg bg-gray-100">
                            <img src="{{ url_for('static', filename='uploads/' ~ img) }}"
                                class="w-full h-64 object-cover hover:scale-110 transition duration-500">
                            {% if loop.index == 6 and post.get_images_list()|length > 6 %}
                            <div class="absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center">
                                <span class="text-white text-4xl font-bold">+{{ post.get_images_list()|length - 6
                                    }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if post.video %}
                    <div class="px-6 mt-4">
                        <video controls class="w-full rounded-2xl shadow-2xl">
                            <source src="{{ url_for('static', filename='uploads/' ~ post.video) }}" type="video/mp4">
                        </video>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- T∆∞∆°ng t√°c + Menu 3 ch·∫•m -->
                <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                    <div class="flex items-center gap-8">
                        <button onclick="likePost({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-heart text-2xl text-pink-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-pink-700" id="like-count-{{ post.id }}">{{ post.likes }}
                                Th√≠ch</span>
                        </button>
                        <button onclick="toggleComments({{ post.id }})" class="flex items-center gap-2 group">
                            <i class="fas fa-comment text-2xl text-blue-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-blue-700" id="comment-count-{{ post.id }}">{{
                                post.comments_count }} B√¨nh lu·∫≠n</span>
                        </button>
                        <button class="flex items-center gap-2 group">
                            <i class="fas fa-eye text-2xl text-indigo-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-indigo-700 view-count" id="view-count-{{ post.id }}">{{
                                post.views|default(0) }} L∆∞·ª£t xem</span>
                        </button>
                        <button onclick="toggleShareMenu({{ post.id }})" class="flex items-center gap-2 group relative">
                            <i class="fas fa-share text-2xl text-green-600 group-hover:scale-110 transition"></i>
                            <span class="font-bold text-green-700">Chia s·∫ª</span>
                        </button>
                    </div>

                    <div class="relative">
                        <button class="menu-toggle p-3 hover:bg-gray-100 rounded-full transition relative z-50"
                            data-post-id="{{ post.id }}" onclick="toggleMenu({{ post.id }})" style="z-index:1000;">
                            <i class="fas fa-ellipsis-h text-gray-600 text-xl"></i>
                        </button>

                        <!-- MENU BA CH·∫§M -->
                        <div id="menu-{{ post.id }}" class="w-64 bg-white rounded-xl shadow-2xl border overflow-hidden">
                            <button onclick="reportPost({{ post.id }})"
                                class="w-full text-left px-6 py-4 hover:bg-red-50 flex items-center gap-3 text-red-600 transition-all border-b border-gray-100">
                                <i class="fas fa-flag text-lg"></i>
                                <span class="font-semibold">B√°o c√°o b√†i vi·∫øt</span>
                            </button>
                            {% if current_user.is_authenticated
                            and (current_user.id == post.author.id
                            or current_user.role|lower == 'admin') %}
                            <button onclick="deletePost({{ post.id }})" class="w-full text-left px-6 py-4 hover:bg-red-50
           flex items-center gap-3 text-red-600">
                                <i class="fas fa-trash"></i>
                                <span>X√≥a b√†i vi·∫øt</span>
                            </button>
                            {% endif %}

                            {% if current_user.id == post.author.id or current_user.role|lower == 'admin' %}
                            {% else %}
                            <div class="px-6 py-4 text-sm text-gray-400">
                                Kh√¥ng c√≥ h√†nh ƒë·ªông
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- ‚úÖ KHUNG B√åNH LU·∫¨N M·ªöI - FACEBOOK STYLE -->
                <div id="comments-section-{{ post.id }}" class="hidden border-t border-gray-100 mt-4 pt-4">
                    <div id="comments-list-{{ post.id }}" class="space-y-4 mb-4">
                        <!-- B√¨nh lu·∫≠n s·∫Ω ƒë∆∞·ª£c t·∫£i v√†o ƒë√¢y -->
                    </div>

                    <!-- KHUNG VI·∫æT B√åNH LU·∫¨N -->
                    <div class="flex gap-4 p-4 bg-gray-50 rounded-2xl">
                        <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                            class="w-10 h-10 rounded-full ring-2 ring-pink-200 flex-shrink-0 object-cover">
                        <div class="flex-1">
                            <div class="relative">
                                <textarea id="comment-input-{{ post.id }}"
                                    placeholder="Vi·∫øt b√¨nh lu·∫≠n... (h·ªó tr·ª£ @mention, #hashtag)"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-pink-300 outline-none resize-none"
                                    rows="1" onkeydown="handleCommentKeyDown(event, {{ post.id }})"
                                    oninput="autoResizeTextarea(this); handleMentions(this, {{ post.id }})"></textarea>

                                <!-- MENTION SUGGESTIONS -->
                                <div id="mention-suggestions-{{ post.id }}"
                                    class="hidden absolute bg-white rounded-lg shadow-xl border border-gray-200 z-10 max-h-40 overflow-y-auto w-64">
                                    <!-- Suggestions will be added here -->
                                </div>
                            </div>

                            <div class="flex items-center justify-between mt-3">
                                <div class="flex gap-3">
                                    <label class="cursor-pointer text-gray-600 hover:text-pink-600 transition">
                                        <i class="fas fa-image text-xl"></i>
                                        <input type="file" id="comment-file-{{ post.id }}" accept="image/*,video/*"
                                            class="hidden" onchange="previewCommentMedia(this, {{ post.id }})">
                                    </label>
                                    <button onclick="toggleStickerPicker({{ post.id }})"
                                        class="text-gray-600 hover:text-yellow-600">
                                        <i class="fas fa-smile text-xl"></i>
                                    </button>
                                </div>
                                <button onclick="submitComment({{ post.id }})"
                                    class="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full font-bold hover:shadow-lg transition flex items-center gap-2">
                                    <i class="fas fa-paper-plane"></i>
                                    G·ª≠i
                                </button>
                            </div>

                            <!-- MEDIA PREVIEW -->
                            <div id="media-preview-{{ post.id }}" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- STICKER PICKER -->
                <div id="sticker-picker-{{ post.id }}"
                    class="hidden mt-2 p-4 bg-white rounded-2xl shadow-xl border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-gray-800">Ch·ªçn sticker</h4>
                        <button onclick="toggleStickerPicker({{ post.id }})" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-6 gap-2">
                        <!-- Stickers will be loaded here -->
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üòÄ')">üòÄ</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üòÇ')">üòÇ</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', '‚ù§Ô∏è')">‚ù§Ô∏è</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üëç')">üëç</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üéâ')">üéâ</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üò¢')">üò¢</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üò°')">üò°</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üëè')">üëè</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üî•')">üî•</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'üòç')">üòç</div>
                        <div class="sticker-item cursor-pointer hover:scale-110 transition"
                            onclick="insertSticker('{{ post.id }}', 'ü§î')">ü§î</div>
                    </div>
                </div>

                <!-- Menu chia s·∫ª -->
                <div id="share-menu-{{ post.id }}"
                    class="hidden mt-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl border-2 border-blue-200">
                    <p class="text-sm font-bold text-gray-700 mb-3">Chia s·∫ª b√†i vi·∫øt ƒë·∫øn:</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareFacebook({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-md">
                            <i class="fab fa-facebook-f text-xl"></i>
                            <span class="font-medium">Facebook</span>
                        </button>
                        <button onclick="shareZalo({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition shadow-md">
                            <i class="fas fa-comment-dots text-xl"></i>
                            <span class="font-medium">Zalo</span>
                        </button>
                        <button onclick="shareTwitter({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fab fa-x-twitter text-xl"></i>
                            <span class="font-medium">Twitter/X</span>
                        </button>
                        <button onclick="shareInstagram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition">
                            <i class="fab fa-instagram text-xl"></i>
                            <span class="font-medium">Instagram</span>
                        </button>
                        <button onclick="shareTelegram({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-sky-500 text-white rounded-xl hover:bg-sky-600 transition shadow-md">
                            <i class="fab fa-telegram-plane text-xl"></i>
                            <span class="font-medium">Telegram</span>
                        </button>
                        <button onclick="copyLink({{ post.id }})"
                            class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-700 text-white rounded-xl hover:bg-gray-800 transition shadow-md">
                            <i class="fas fa-link text-xl"></i>
                            <span class="font-medium">Copy link</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-20 bg-white rounded-3xl shadow-xl">
            <i class="fas fa-feather-alt text-8xl text-gray-200 mb-6"></i>
            <p class="text-2xl text-gray-500 font-medium">Ch∆∞a c√≥ b√†i vi·∫øt n√†o</p>
            <a href="{{ url_for('create_post') }}"
                class="mt-6 inline-block px-8 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white text-xl font-bold rounded-full hover:shadow-2xl transition">
                ƒêƒÉng b√†i ƒë·∫ßu ti√™n
            </a>
        </div>
        {% endif %}
    </div>

    <!-- SIDEBAR PH·∫¢I -->
    <div class="space-y-8">
        <!-- H·ªì s∆° nhanh -->
        <div class="bg-gradient-to-br from-pink-400 to-purple-600 p-8 rounded-3xl text-white shadow-2xl">
            <div class="text-center">
                <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                    class="w-24 h-24 rounded-full mx-auto ring-8 ring-white shadow-2xl mb-4 object-cover">
                <div class="text-center">
                    <h3 class="text-2xl font-bold text-white">{{ current_user.name }}</h3>

                    <!-- HUY HI·ªÜU CH·ªà HI·ªÜN N·∫æU KH√îNG PH·∫¢I ADMIN -->
                    {% if current_user.role != 'admin' %}
                    <div class="flex items-center justify-center gap-2 mt-2">
                        <i class="fas fa-medal text-lg
                                {% if '·ª®ng vi√™n Chuy√™n gia' in current_user.badge %}text-purple-300
                                {% elif 'Th√†nh Vi√™n B·∫°c' in current_user.badge %}text-gray-300
                                {% elif 'Th√†nh Vi√™n ƒê·ªìng' in current_user.badge %}text-orange-300
                                {% else %}text-green-300{% endif %}"></i>
                        <span class="text-lg font-medium text-pink-100">
                            {{ current_user.badge }}
                        </span>
                    </div>
                    {% endif %}

                    <p class="mt-2 text-pink-100 opacity-90">{{ current_user.points }} ƒëi·ªÉm t√≠ch l≈©y</p>
                </div>

                <a href="{{ url_for('profile') }}"
                    class="mt-6 inline-block px-8 py-3 bg-white text-pink-600 rounded-full font-bold hover:shadow-xl transition">
                    C·∫≠p nh·∫≠t h·ªì s∆°
                </a>
            </div>
        </div>

        <!-- B·∫°n b√® -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">B·∫°n b√® ({{ friends|length }})</h3>
            {% if friends %}
            <div class="space-y-3">
                {% for friend in friends %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ url_for('static', filename=friend.avatar or 'images/default-avatar.png') }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <div>
                            <p class="font-bold">
                                <a href="{{ url_for('user_profile', user_id=friend.id) }}"
                                    class="hover:text-pink-600 hover:underline transition">
                                    {{ friend.name }}
                                </a>
                            </p>
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                                <i class="fas fa-medal text-xs"></i> {{ friend.badge }}
                            </p>
                        </div>
                    </div>
                    <button onclick="openChat({{ friend.id }})" class="text-blue-600 hover:text-blue-700">
                        <i class="fas fa-comment-dots text-xl"></i>
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ b·∫°n b√®</p>
            {% endif %}
        </div>

        <!-- G·ª£i √Ω k·∫øt b·∫°n -->
        <div class="bg-white rounded-3xl shadow-xl p-6">
            <h3 class="text-xl font-bold mb-4">G·ª£i √Ω k·∫øt b·∫°n</h3>
            {% if suggested_users %}
            <div class="space-y-3">
                {% for user in suggested_users %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="{{ url_for('static', filename=user.avatar or 'images/default-avatar.png') }}"
                            class="w-12 h-12 rounded-full ring-2 ring-pink-200 object-cover">
                        <span class="font-medium">
                            <a href="{{ url_for('user_profile', user_id=user.id) }}"
                                class="hover:text-pink-600 hover:underline transition">
                                {{ user.name }}
                            </a>
                        </span>
                    </div>
                    <button onclick="handleFriendAction('{{ user.id }}', 'add_friend', this)"
                        class="px-4 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full text-sm font-medium hover:shadow-lg transition">
                        K·∫øt b·∫°n
                    </button>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Kh√¥ng c√≥ g·ª£i √Ω</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Toast th√¥ng b√°o -->
<div id="toast"
    class="hidden fixed top-20 right-4 bg-white border-l-4 border-green-500 shadow-2xl rounded-lg p-4 z-50 animate-slide-in">
    <div class="flex items-center gap-3">
        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        <span id="toast-message" class="font-medium text-gray-800"></span>
    </div>
</div>

<style>
    @keyframes slide-in {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .animate-slide-in {
        animation: slide-in 0.3s ease-out;
    }

    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* üî• MENU BA CH·∫§M - FIX HO√ÄN CH·ªàNH */
    .post-card {
        position: relative;
        overflow: visible !important;
        /* QUAN TR·ªåNG: B·ªè overflow-hidden */
    }

    [id^="menu-"] {
        position: fixed !important;
        min-width: 240px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(0, 0, 0, 0.08);
        z-index: 99999 !important;

        opacity: 0;
        visibility: hidden;
        transform: scale(0.95);
        transition: all 0.15s ease;
    }

    [id^="menu-"].show {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
    }

    [id^="menu-"] button {
        display: flex !important;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 16px 20px;
        font-size: 15px;
        font-weight: 500;
        border: none;
        background: none;
        text-align: left;
        transition: background-color 0.15s ease;
        white-space: nowrap;
    }

    [id^="menu-"] button:hover {
        background: linear-gradient(90deg, #fee2e2 0%, #fecaca 100%);
    }

    /* ƒê√≥ng t·∫•t c·∫£ menu khi scroll */
    body.menu-open {
        overflow: hidden;
    }

    /* üî• FACEBOOK-STYLE COMMENTS */
    .comment-container {
        position: relative;
    }

    .comment-item {
        border-radius: 18px;
        position: relative;
        transition: all 0.2s ease;
    }

    .comment-item:hover {
        background-color: #f0f2f5;
    }

    .comment-content {
        word-wrap: break-word;
    }

    .comment-actions {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .comment-item:hover .comment-actions {
        opacity: 1;
    }

    .comment-like-button {
        color: #65676b;
        font-weight: 500;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .comment-like-button:hover {
        background-color: #f0f2f5;
    }

    .comment-like-button.liked {
        color: #0b57d0;
    }

    .reply-container {
        margin-left: 40px;
        margin-top: 8px;
        border-left: 2px solid #dddfe2;
        padding-left: 12px;
    }

    .media-preview {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        margin-top: 8px;
        max-width: 200px;
    }

    .media-preview img,
    .media-preview video {
        width: 100%;
        height: auto;
        max-height: 200px;
        object-fit: cover;
    }

    .media-preview .remove-media {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .sticker-item {
        font-size: 24px;
        padding: 8px;
        text-align: center;
        border-radius: 8px;
    }

    .sticker-item:hover {
        background-color: #f0f2f5;
    }

    .mention-suggestion {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .mention-suggestion:hover {
        background-color: #f0f2f5;
    }

    .mention-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        object-fit: cover;
    }

    .edit-comment-textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        resize: none;
        font-family: inherit;
        font-size: 14px;
    }

    /* Hashtag and mention styles */
    .hashtag {
        color: #0b57d0;
        font-weight: 500;
        cursor: pointer;
    }

    .mention {
        color: #0b57d0;
        font-weight: 500;
        cursor: pointer;
    }

    .link {
        color: #0b57d0;
        text-decoration: none;
    }

    .link:hover {
        text-decoration: underline;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .reply-container {
            margin-left: 20px;
            padding-left: 8px;
        }
    }
</style>

<script>
    // ‚úÖ H√ÄM M·ªû CHAT - KI·ªÇM TRA B·∫†N B√à TR∆Ø·ªöC
    async function openChat(userId) {
        try {
            // Ki·ªÉm tra tr·∫°ng th√°i b·∫°n b√®
            const response = await fetch(`/friendship_status/${userId}`);
            const data = await response.json();

            if (data.status === 'friends') {
                // N·∫øu l√† b·∫°n b√®, chuy·ªÉn ƒë·∫øn trang chat
                window.location.href = `/chat/${userId}`;
            } else {
                // N·∫øu ch∆∞a l√† b·∫°n b√®, hi·ªÉn th·ªã th√¥ng b√°o
                showToast('B·∫°n c·∫ßn k·∫øt b·∫°n v·ªõi ng∆∞·ªùi n√†y tr∆∞·ªõc khi c√≥ th·ªÉ nh·∫Øn tin!', false);

                // T·ª± ƒë·ªông m·ªü n√∫t k·∫øt b·∫°n
                const button = document.querySelector(`button[onclick*="${userId}"]`);
                if (button && button.textContent.includes('K·∫øt b·∫°n')) {
                    button.click();
                }
            }
        } catch (error) {
            console.error('L·ªói khi ki·ªÉm tra tr·∫°ng th√°i b·∫°n b√®:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• H√ÄM X·ª¨ L√ù K·∫æT B·∫†N - ƒê·ªíNG B·ªò V·ªöI TRANG FRIENDS
    async function handleFriendAction(userId, action, button) {
        try {
            // Th√™m tr·∫°ng th√°i loading ƒë·ªÉ tr√°nh click nhi·ªÅu l·∫ßn
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang x·ª≠ l√Ω...';

            let url, method, successMessage;

            switch (action) {
                case 'add_friend':
                    url = `/send_friend_request/${userId}`;
                    method = 'POST';
                    successMessage = 'ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!';
                    break;
                case 'accept_request':
                    // T√¨m request ID tr∆∞·ªõc
                    const response = await fetch(`/friendship_status/${userId}`);
                    const data = await response.json();
                    if (data.pending_request_id) {
                        url = `/accept_friend_request/${data.pending_request_id}`;
                        method = 'POST';
                        successMessage = 'ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi k·∫øt b·∫°n!';
                    }
                    break;
                case 'cancel_request':
                    url = `/cancel_friend_request/${userId}`;
                    method = 'POST';
                    successMessage = 'ƒê√£ h·ªßy l·ªùi m·ªùi k·∫øt b·∫°n!';
                    break;
                case 'unfriend':
                    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy k·∫øt b·∫°n?')) {
                        url = `/unfriend/${userId}`;
                        method = 'POST';
                        successMessage = 'ƒê√£ h·ªßy k·∫øt b·∫°n!';
                    } else {
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        return;
                    }
                    break;
            }

            if (!url) {
                button.disabled = false;
                button.innerHTML = originalContent;
                return;
            }

            const res = await fetch(url, { method });
            const result = await res.json();

            if (result.success) {
                showToast(result.message || successMessage);

                // C·∫≠p nh·∫≠t UI
                setTimeout(() => {
                    updateFriendButton(userId, button, action);
                }, 500);
            } else {
                showToast(result.error || 'ƒê√£ c√≥ l·ªói x·∫£y ra', false);
                // Kh√¥i ph·ª•c n√∫t n·∫øu l·ªói
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
            // Kh√¥i ph·ª•c n√∫t n·∫øu l·ªói
            button.disabled = false;
            button.innerHTML = originalContent;
        }
    }

    // üî• C·∫¨P NH·∫¨T GIAO DI·ªÜN N√öT K·∫æT B·∫†N - ƒê·ªíNG B·ªò V·ªöI TRANG FRIENDS
    function updateFriendButton(userId, button, currentAction) {
        const container = document.getElementById(`friend-button-${userId}`);
        if (!container) return;

        let newButton, newAction;

        switch (currentAction) {
            case 'add_friend':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'cancel_request', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i class="fas fa-clock mr-2"></i>ƒê√£ g·ª≠i
                    </button>`;
                newAction = 'cancel_request';
                break;
            case 'accept_request':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'unfriend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                        <i class="fas fa-user-minus mr-2"></i>B·∫°n b√®
                    </button>`;
                newAction = 'friends';
                break;
            case 'cancel_request':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'add_friend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                    </button>`;
                newAction = 'add_friend';
                break;
            case 'unfriend':
                newButton = `
                    <button onclick="handleFriendAction('${userId}', 'add_friend', this)"
                        class="px-5 py-2 rounded-full font-medium transition shadow-md bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>K·∫øt b·∫°n
                    </button>`;
                newAction = 'add_friend';
                break;
        }

        container.innerHTML = newButton;

        // N·∫øu l√† h√†nh ƒë·ªông thay ƒë·ªïi tr·∫°ng th√°i b·∫°n b√®, t·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t sidebar
        if (currentAction === 'accept_request' || currentAction === 'unfriend') {
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }

    // H√†m hi·ªÉn th·ªã toast
    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const icon = toast.querySelector('i');

        toastMessage.textContent = message;

        if (isSuccess) {
            toast.classList.remove('border-red-500');
            toast.classList.add('border-green-500');
            icon.classList.remove('fa-exclamation-circle', 'text-red-500');
            icon.classList.add('fa-check-circle', 'text-green-500');
        } else {
            toast.classList.remove('border-green-500');
            toast.classList.add('border-red-500');
            icon.classList.remove('fa-check-circle', 'text-green-500');
            icon.classList.add('fa-exclamation-circle', 'text-red-500');
        }

        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // ‚úÖ C·∫¨P NH·∫¨T H√ÄM T∆Ø∆†NG T√ÅC
    async function likePost(postId) {
        try {
            const res = await fetch(`/like/${postId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (res.ok) {
                const data = await res.json();
                const likeCount = document.getElementById(`like-count-${postId}`);
                if (likeCount && data.likes !== undefined) {
                    likeCount.textContent = `${data.likes} Th√≠ch`;
                }
                showToast(data.liked ? 'ƒê√£ th√≠ch b√†i vi·∫øt!' : 'ƒê√£ b·ªè th√≠ch b√†i vi·∫øt!');
            } else {
                showToast('Kh√¥ng th·ªÉ th√≠ch b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• FACEBOOK-STYLE COMMENTS SYSTEM
    let commentMedia = {};
    let editingCommentId = null;

    // Toggle comments section
    function toggleComments(postId) {
        const section = document.getElementById(`comments-section-${postId}`);
        section.classList.toggle('hidden');

        // N·∫øu ƒëang m·ªü v√† ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o, t·∫£i b√¨nh lu·∫≠n
        if (!section.classList.contains('hidden')) {
            loadComments(postId);
        }
    }

    // Load comments for a post
    async function loadComments(postId) {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        if (commentsList.children.length > 0) return; // ƒê√£ t·∫£i r·ªìi

        try {
            const res = await fetch(`/comments/${postId}`);
            const comments = await res.json();

            comments.forEach(comment => {
                addCommentToList(postId, comment);
            });
        } catch (error) {
            console.error('Error loading comments:', error);
        }
    }

    // Add comment to the list
    function addCommentToList(postId, comment, isReply = false, parentCommentId = null) {
        const commentsList = document.getElementById(`comments-list-${postId}`);
        if (!commentsList) return;

        const commentHtml = createCommentHtml(comment, isReply, parentCommentId);

        if (isReply && parentCommentId) {
            // Add as reply to parent comment
            const parentComment = document.querySelector(`#comment-${parentCommentId} .replies-container`);
            if (parentComment) {
                parentComment.insertAdjacentHTML('beforeend', commentHtml);
            }
        } else {
            // Add as top-level comment
            commentsList.insertAdjacentHTML('afterbegin', commentHtml);
        }
    }

    // Create HTML for a comment
    function createCommentHtml(comment, isReply = false, parentCommentId = null) {
        const commentId = comment.id || `temp-${Date.now()}`;
        const authorAvatar = comment.author.avatar || 'images/default-avatar.png';
        const authorName = comment.author.name;
        const content = comment.content ? processCommentContent(comment.content) : '';
        const timestamp = comment.created_at || 'V·ª´a xong';
        const likes = comment.likes || 0;
        const isLiked = comment.is_liked || false;
        const canEdit = comment.can_edit || false;
        const canDelete = comment.can_delete || false;

        // Media HTML
        let mediaHtml = '';
        if (comment.image) {
            mediaHtml = `
        <div class="media-preview mt-2">
            <img src="{{ url_for('static', filename='') }}${comment.image}" 
                 alt="Comment image"
                 class="rounded-lg max-w-xs cursor-pointer hover:opacity-90"
                 onclick="openImageModal('{{ url_for('static', filename='') }}${comment.image}')">
        </div>
    `;
        } else if (comment.video) {
            mediaHtml = `
        <div class="media-preview mt-2">
            <video controls class="rounded-lg max-w-xs">
                <source src="{{ url_for('static', filename='') }}${comment.video}" type="video/mp4">
            </video>
        </div>
    `;
        } else if (comment.sticker) {
            mediaHtml = `<div class="text-6xl my-2">${comment.sticker}</div>`;
        }

        // Replies HTML
        const repliesHtml = comment.replies ?
            comment.replies.map(reply => createCommentHtml(reply, true, commentId)).join('') : '';

        return `
    <div id="comment-${commentId}" class="comment-container ${isReply ? 'reply-container' : ''}" data-comment-id="${commentId}">
        <div class="flex gap-3 p-4 bg-gray-50 rounded-2xl comment-item hover:bg-gray-100 transition">
            <img src="{{ url_for('static', filename='') }}${authorAvatar}" 
                 class="w-10 h-10 rounded-full object-cover flex-shrink-0">
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between mb-1">
                    <h4 class="font-bold text-gray-900">${authorName}</h4>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                <div class="comment-content text-gray-800">${content}</div>
                ${mediaHtml}
                
                <!-- Actions -->
                <div class="flex items-center gap-4 mt-2 text-sm">
                    <button onclick="likeComment(${commentId})" 
                            class="comment-like-button ${isLiked ? 'liked text-pink-600' : 'text-gray-600'} hover:text-pink-600 font-medium">
                        <i class="fas fa-heart"></i> ${likes > 0 ? likes : 'Th√≠ch'}
                    </button>
                    <button onclick="showReplyForm(${commentId})" 
                            class="text-gray-600 hover:text-blue-600 font-medium">
                        <i class="fas fa-reply"></i> Tr·∫£ l·ªùi
                    </button>
                    ${canEdit ? `
                        <button onclick="editComment(${commentId})" 
                                class="text-gray-600 hover:text-green-600 font-medium">
                            <i class="fas fa-edit"></i> S·ª≠a
                        </button>
                    ` : ''}
                    ${canDelete ? `
                        <button onclick="deleteComment(${commentId})" 
                                class="text-gray-600 hover:text-red-600 font-medium">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    ` : ''}
                    <button onclick="reportComment(${commentId})" 
                            class="text-gray-600 hover:text-orange-600 font-medium">
                        <i class="fas fa-flag"></i> B√°o c√°o
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Replies container -->
        <div class="replies-container ml-12 mt-2 space-y-2">
            ${repliesHtml}
        </div>
        
        <!-- Reply form -->
        <div id="reply-form-${commentId}" class="hidden ml-12 mt-2"></div>
    </div>
    `;
    }

    // Process comment content to handle hashtags, mentions, and links
    function processCommentContent(content) {
        // Convert URLs to links
        content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="link">$1</a>');

        // Convert hashtags to clickable elements
        content = content.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>');

        // Convert mentions to clickable elements
        content = content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');

        // Convert line breaks to <br>
        content = content.replace(/\n/g, '<br>');

        return content;
    }

    // Create HTML for media in comment
    function createMediaHtml(media, commentId) {
        if (!media || !media.type) return '';

        if (media.type === 'image') {
            return `
                <div class="media-preview">
                    <img src="{{ url_for('static', filename='') }}${media.url}" alt="Comment image">
                    <button onclick="removeCommentMedia('${commentId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else if (media.type === 'video') {
            return `
                <div class="media-preview">
                    <video controls>
                        <source src="{{ url_for('static', filename='') }}${media.url}" type="video/mp4">
                    </video>
                    <button onclick="removeCommentMedia('${commentId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        return '';
    }

    // Handle comment input key down
    function handleCommentKeyDown(event, postId) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            submitComment(postId);
        }
    }

    // Auto-resize textarea
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    // Handle mentions in comment input
    function handleMentions(textarea, postId) {
        const text = textarea.value;
        const cursorPos = textarea.selectionStart;
        const textBeforeCursor = text.substring(0, cursorPos);

        // Check if user is typing a mention
        const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
        if (mentionMatch) {
            const query = mentionMatch[1];
            if (query.length >= 2) {
                // Show mention suggestions
                showMentionSuggestions(postId, query, textarea);
            } else {
                // Hide mention suggestions
                hideMentionSuggestions(postId);
            }
        } else {
            // Hide mention suggestions
            hideMentionSuggestions(postId);
        }
    }

    // Show mention suggestions
    async function showMentionSuggestions(postId, query, textarea) {
        try {
            const res = await fetch(`/api/users/search?q=${query}`);
            const users = await res.json();

            const suggestionsContainer = document.getElementById(`mention-suggestions-${postId}`);
            suggestionsContainer.innerHTML = '';

            if (users.length > 0) {
                users.forEach(user => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'mention-suggestion';
                    suggestion.innerHTML = `
                        <img src="{{ url_for('static', filename='') }}${user.avatar || 'images/default-avatar.png'}" class="mention-avatar">
                        <span>${user.name}</span>
                    `;
                    suggestion.onclick = () => selectMention(user.name, textarea, postId);
                    suggestionsContainer.appendChild(suggestion);
                });

                // Position suggestions below textarea
                const rect = textarea.getBoundingClientRect();
                suggestionsContainer.style.top = (rect.bottom + window.scrollY) + 'px';
                suggestionsContainer.style.left = rect.left + 'px';
                suggestionsContainer.classList.remove('hidden');
            } else {
                hideMentionSuggestions(postId);
            }
        } catch (error) {
            console.error('Error fetching user suggestions:', error);
            hideMentionSuggestions(postId);
        }
    }

    // Hide mention suggestions
    function hideMentionSuggestions(postId) {
        const suggestionsContainer = document.getElementById(`mention-suggestions-${postId}`);
        suggestionsContainer.classList.add('hidden');
    }

    // Select a mention
    function selectMention(username, textarea, postId) {
        const text = textarea.value;
        const cursorPos = textarea.selectionStart;
        const textBeforeCursor = text.substring(0, cursorPos);

        // Replace the @query with @username
        const mentionMatch = textBeforeCursor.match(/@(\w*)$/);
        if (mentionMatch) {
            const newText = text.substring(0, cursorPos - mentionMatch[0].length) + '@' + username + ' ' + text.substring(cursorPos);
            textarea.value = newText;

            // Set cursor position after the mention
            const newCursorPos = cursorPos - mentionMatch[0].length + username.length + 2;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
        }

        hideMentionSuggestions(postId);
    }

    // Preview comment media
    function previewCommentMedia(input, postId) {
        const file = input.files[0];
        if (!file) return;

        const previewContainer = document.getElementById(`media-preview-${postId}`);

        // Create object URL for preview
        const objectUrl = URL.createObjectURL(file);

        // Store file for later upload
        commentMedia[postId] = file;

        // Create preview HTML based on file type
        let previewHtml = '';
        if (file.type.startsWith('image/')) {
            previewHtml = `
                <div class="media-preview">
                    <img src="${objectUrl}" alt="Preview">
                    <button onclick="removeCommentMedia('${postId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else if (file.type.startsWith('video/')) {
            previewHtml = `
                <div class="media-preview">
                    <video controls>
                        <source src="${objectUrl}" type="${file.type}">
                    </video>
                    <button onclick="removeCommentMedia('${postId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        previewContainer.innerHTML = previewHtml;
    }

    // Remove comment media
    function removeCommentMedia(postId) {
        delete commentMedia[postId];
        document.getElementById(`media-preview-${postId}`).innerHTML = '';
    }

    // Toggle sticker picker
    function toggleStickerPicker(postId) {
        const stickerPicker = document.getElementById(`sticker-picker-${postId}`);
        stickerPicker.classList.toggle('hidden');
    }

    // Insert sticker into comment
    function insertSticker(postId, sticker) {
        const textarea = document.getElementById(`comment-input-${postId}`);
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;
        const newText = text.substring(0, cursorPos) + sticker + ' ' + text.substring(cursorPos);

        textarea.value = newText;
        textarea.focus();

        // Set cursor position after the sticker
        const newCursorPos = cursorPos + sticker.length + 1;
        textarea.setSelectionRange(newCursorPos, newCursorPos);

        // Hide sticker picker
        toggleStickerPicker(postId);
    }

    // Submit comment
    async function submitComment(postId, parentCommentId = null) {
        const textarea = document.getElementById(`comment-input-${postId}`);
        const content = textarea.value.trim();

        if (!content && !commentMedia[postId]) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n', false);
            return;
        }

        try {
            const formData = new FormData();
            formData.append('content', content);

            if (commentMedia[postId]) {
                formData.append('media', commentMedia[postId]);
            }

            if (parentCommentId) {
                formData.append('parent_id', parentCommentId);
            }

            const res = await fetch(`/comment/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                // Clear input
                textarea.value = '';
                textarea.style.height = 'auto';
                removeCommentMedia(postId);

                // Update comment count
                const commentCount = document.getElementById(`comment-count-${postId}`);
                if (commentCount) {
                    const currentCount = parseInt(commentCount.textContent);
                    commentCount.textContent = currentCount + 1;
                }

                // Add comment to list
                addCommentToList(postId, data.comment, parentCommentId !== null, parentCommentId);

                // Hide reply form if it's a reply
                if (parentCommentId) {
                    hideReplyForm(parentCommentId);
                }

                showToast('ƒê√£ g·ª≠i b√¨nh lu·∫≠n th√†nh c√¥ng!');
            } else {
                showToast(data.error || 'Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }


    // üî• FIX: Like comment function - Ho·∫°t ƒë·ªông cho c·∫£ 2 trang
    async function likeComment(commentId) {
        console.log('Liking comment:', commentId);
        try {
            const res = await fetch(`/api/comment/${commentId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('Response status:', res.status);

            const data = await res.json();
            console.log('Response data:', data);

            if (data.success) {
                // üî• FIX CH√çNH: T√¨m t·∫•t c·∫£ buttons v·ªõi comment ID n√†y
                const commentElements = document.querySelectorAll(`[data-comment-id="${commentId}"]`);

                commentElements.forEach(commentElement => {
                    // T√¨m button like trong comment element n√†y
                    const buttons = commentElement.querySelectorAll('button');
                    buttons.forEach(button => {
                        // Ki·ªÉm tra xem c√≥ ph·∫£i button like kh√¥ng
                        if (button.onclick && button.onclick.toString().includes(`likeComment(${commentId})`)) {
                            const icon = button.querySelector('i');

                            // C·∫≠p nh·∫≠t m√†u s·∫Øc
                            if (data.liked) {
                                button.classList.add('text-pink-600');
                                if (icon) icon.classList.add('text-pink-600');
                            } else {
                                button.classList.remove('text-pink-600');
                                if (icon) icon.classList.remove('text-pink-600');
                            }

                            // C·∫≠p nh·∫≠t text
                            button.innerHTML = `<i class="fas fa-heart ${data.liked ? 'text-pink-600' : ''}"></i> ${data.likes > 0 ? data.likes : 'Th√≠ch'}`;
                        }
                    });
                });

                showToast(data.liked ? 'ƒê√£ th√≠ch!' : 'ƒê√£ b·ªè th√≠ch!');
            } else {
                console.error('Error:', data.error);
                showToast('Kh√¥ng th·ªÉ th√≠ch b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• BONUS: H√†m debug ƒë·ªÉ ki·ªÉm tra c·∫•u tr√∫c DOM
    function debugCommentStructure(commentId) {
        console.log('=== DEBUG COMMENT STRUCTURE ===');
        console.log('Looking for comment ID:', commentId);

        // T√¨m t·∫•t c·∫£ elements c√≥ data-comment-id
        const elements = document.querySelectorAll(`[data-comment-id="${commentId}"]`);
        console.log('Found elements:', elements.length);

        elements.forEach((el, index) => {
            console.log(`Element ${index + 1}:`, el);
            console.log('All buttons in this element:', el.querySelectorAll('button'));

            // T√¨m button c√≥ onclick ch·ª©a likeComment
            const buttons = el.querySelectorAll('button');
            buttons.forEach((btn, btnIndex) => {
                if (btn.onclick) {
                    console.log(`Button ${btnIndex + 1} onclick:`, btn.onclick.toString());
                }
            });
        });

        console.log('=== END DEBUG ===');
    }

    // üî• ALTERNATIVE FIX: N·∫øu c√°ch tr√™n kh√¥ng work, d√πng c√°ch n√†y
    async function likeCommentAlternative(commentId) {
        try {
            const res = await fetch(`/api/comment/${commentId}/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await res.json();

            if (data.success) {
                // T√¨m comment container
                const commentContainer = document.getElementById(`comment-${commentId}`);
                if (!commentContainer) {
                    console.error('Comment container not found');
                    return;
                }

                // T√¨m button like b·∫±ng class v√† content
                const buttons = commentContainer.querySelectorAll('.comment-like-button');
                buttons.forEach(button => {
                    const icon = button.querySelector('i');

                    if (data.liked) {
                        button.classList.add('text-pink-600', 'liked');
                        if (icon) icon.classList.add('text-pink-600');
                    } else {
                        button.classList.remove('text-pink-600', 'liked');
                        if (icon) icon.classList.remove('text-pink-600');
                    }

                    // Update text
                    const textContent = data.likes > 0 ? data.likes : 'Th√≠ch';
                    button.innerHTML = `<i class="fas fa-heart ${data.liked ? 'text-pink-600' : ''}"></i> ${textContent}`;
                });

                showToast(data.liked ? 'ƒê√£ th√≠ch!' : 'ƒê√£ b·ªè th√≠ch!');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // H√†m ki·ªÉm tra debug
    function debugCommentElements(commentId) {
        console.log('=== DEBUG COMMENT ELEMENTS ===');
        console.log('Comment ID:', commentId);

        const commentElement = document.getElementById(`comment-${commentId}`);
        console.log('Comment element:', commentElement);

        if (commentElement) {
            const button = commentElement.querySelector('button[onclick*="likeComment"]');
            console.log('Like button:', button);

            const allButtons = commentElement.querySelectorAll('button');
            console.log('All buttons in comment:', allButtons);

            const likeButtons = commentElement.querySelectorAll('button[onclick*="likeComment"]');
            console.log('Like buttons found:', likeButtons);
        } else {
            console.log('Comment element NOT FOUND!');
        }
        console.log('=== END DEBUG ===');
    }

    // Show reply form
    function showReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);

        // L·∫•y postId t·ª´ comment container
        const commentContainer = document.getElementById(`comment-${commentId}`);
        const postId = commentContainer.closest('[id^="comments-section-"]')?.id.split('-')[2]
            || document.querySelector('[id^="comment-input-"]')?.id.split('-')[2];

        if (replyForm.innerHTML === '') {
            replyForm.innerHTML = `
            <div class="flex gap-3 mt-2">
                <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                    class="w-8 h-8 rounded-full object-cover">
                <div class="flex-1">
                    <textarea id="reply-input-${commentId}" 
                        placeholder="Vi·∫øt tr·∫£ l·ªùi..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-300 outline-none resize-none"
                        rows="2"
                        data-post-id="${postId}"
                        data-parent-id="${commentId}"
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitReply(${commentId}, ${postId}); }"></textarea>
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="hideReplyForm(${commentId})" 
                            class="px-3 py-1 text-gray-600 hover:text-gray-800">H·ªßy</button>
                        <button onclick="submitReply(${commentId}, ${postId})"
                            class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tr·∫£ l·ªùi</button>
                    </div>
                </div>
            </div>
        `;
        }

        replyForm.classList.toggle('hidden');
        if (!replyForm.classList.contains('hidden')) {
            document.getElementById(`reply-input-${commentId}`).focus();
        }
    }

    // Hide reply form
    function hideReplyForm(commentId) {
        document.getElementById(`reply-form-${commentId}`).classList.add('hidden');
    }

    // Preview reply media
    function previewReplyMedia(input, commentId) {
        const file = input.files[0];
        if (!file) return;

        const previewContainer = document.getElementById(`reply-media-preview-${commentId}`);

        // Create object URL for preview
        const objectUrl = URL.createObjectURL(file);

        // Store file for later upload
        if (!commentMedia[commentId]) {
            commentMedia[commentId] = {};
        }
        commentMedia[commentId].reply = file;

        // Create preview HTML based on file type
        let previewHtml = '';
        if (file.type.startsWith('image/')) {
            previewHtml = `
                <div class="media-preview" style="max-width: 150px;">
                    <img src="${objectUrl}" alt="Preview">
                    <button onclick="removeReplyMedia('${commentId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        } else if (file.type.startsWith('video/')) {
            previewHtml = `
                <div class="media-preview" style="max-width: 150px;">
                    <video controls style="max-height: 150px;">
                        <source src="${objectUrl}" type="${file.type}">
                    </video>
                    <button onclick="removeReplyMedia('${commentId}')" class="remove-media">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }

        previewContainer.innerHTML = previewHtml;
    }

    // Remove reply media
    function removeReplyMedia(commentId) {
        if (commentMedia[commentId]) {
            delete commentMedia[commentId].reply;
        }
        document.getElementById(`reply-media-preview-${commentId}`).innerHTML = '';
    }

    // Toggle reply sticker picker
    function toggleReplyStickerPicker(commentId) {
        const stickerPicker = document.getElementById(`reply-sticker-picker-${commentId}`);
        stickerPicker.classList.toggle('hidden');
    }

    // Insert sticker into reply
    function insertReplySticker(commentId, sticker) {
        const textarea = document.getElementById(`reply-input-${commentId}`);
        const cursorPos = textarea.selectionStart;
        const text = textarea.value;
        const newText = text.substring(0, cursorPos) + sticker + ' ' + text.substring(cursorPos);

        textarea.value = newText;
        textarea.focus();

        // Set cursor position after the sticker
        const newCursorPos = cursorPos + sticker.length + 1;
        textarea.setSelectionRange(newCursorPos, newCursorPos);

        // Hide sticker picker
        toggleReplyStickerPicker(commentId);
    }

    // Submit reply
    async function submitReply(commentId, postId) {
        const textarea = document.getElementById(`reply-input-${commentId}`);
        const content = textarea.value.trim();

        if (!content) {
            showToast('Vui l√≤ng nh·∫≠p n·ªôi dung', false);
            return;
        }

        const formData = new FormData();
        formData.append('content', content);
        formData.append('parent_id', commentId);

        try {
            const res = await fetch(`/comment/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                textarea.value = '';
                hideReplyForm(commentId);
                showToast('ƒê√£ g·ª≠i tr·∫£ l·ªùi!');

                // Reload ƒë·ªÉ hi·ªÉn th·ªã reply m·ªõi
                location.reload();
            } else {
                showToast(data.error || 'L·ªói g·ª≠i reply', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // Edit comment
    function editComment(commentId) {
        const commentContent = document.querySelector(`#comment-${commentId} .comment-content`);
        const currentContent = commentContent.textContent;

        // Create edit form
        const editForm = document.createElement('div');
        editForm.className = 'mt-2';
        editForm.innerHTML = `
            <textarea id="edit-comment-${commentId}" class="edit-comment-textarea">${currentContent}</textarea>
            <div class="flex justify-end gap-2 mt-2">
                <button onclick="cancelEditComment(${commentId})" class="px-3 py-1 text-gray-600 hover:text-gray-800">
                    H·ªßy
                </button>
                <button onclick="saveEditComment(${commentId})" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                    L∆∞u
                </button>
            </div>
        `;

        // Replace content with edit form
        commentContent.innerHTML = '';
        commentContent.appendChild(editForm);

        // Focus on textarea
        document.getElementById(`edit-comment-${commentId}`).focus();

        // Store original content for cancel
        editingCommentId = commentId;
    }

    // Cancel edit comment
    function cancelEditComment(commentId) {
        location.reload(); // Simple reload to restore original comment
    }

    // Save edit comment
    async function saveEditComment(commentId) {
        const textarea = document.getElementById(`edit-comment-${commentId}`);
        const content = textarea.value.trim();

        if (!content) {
            showToast('N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng', false);
            return;
        }

        try {
            const res = await fetch(`/api/comment/${commentId}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content })
            });

            const data = await res.json();

            if (data.success) {
                showToast('ƒê√£ c·∫≠p nh·∫≠t b√¨nh lu·∫≠n!');
                location.reload(); // Simple reload to show updated comment
            } else {
                showToast(data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error editing comment:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // Delete comment
    async function deleteComment(commentId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?')) return;

        try {
            const res = await fetch(`/api/comment/${commentId}/delete`, { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                // Remove comment from DOM
                const commentElement = document.getElementById(`comment-${commentId}`);
                commentElement.remove();

                // Update comment count
                const postId = commentElement.getAttribute('data-post-id');
                const commentCount = document.getElementById(`comment-count-${postId}`);
                if (commentCount) {
                    const currentCount = parseInt(commentCount.textContent);
                    commentCount.textContent = currentCount - 1;
                }

                showToast('ƒê√£ x√≥a b√¨nh lu·∫≠n!');
            } else {
                showToast(data.error || 'Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n', false);
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• H√ÄM TOGGLE MENU M·ªöI - HO√ÄN CH·ªàNH
    function toggleMenu(postId) {
        // ƒë√≥ng menu kh√°c
        document.querySelectorAll('[id^="menu-"]').forEach(m => {
            if (m.id !== `menu-${postId}`) m.classList.remove('show');
        });

        const menu = document.getElementById(`menu-${postId}`);
        const button = document.querySelector(
            `.menu-toggle[data-post-id="${postId}"]`
        );

        if (!menu || !button) return;

        if (menu.classList.contains('show')) {
            menu.classList.remove('show');
            return;
        }

        // üìê L·∫§Y V·ªä TR√ç N√öT 3 CH·∫§M
        const rect = button.getBoundingClientRect();

        const menuWidth = menu.offsetWidth || 240;
        const spacing = 8;

        let top = rect.bottom + spacing;
        let left = rect.right - menuWidth;

        // üß† Kh√¥ng cho tr√†n m√†n h√¨nh
        if (left < 8) left = 8;
        if (top + menu.offsetHeight > window.innerHeight) {
            top = rect.top - menu.offsetHeight - spacing;
        }

        menu.style.top = `${top}px`;
        menu.style.left = `${left}px`;

        menu.classList.add('show');
    }

    function toggleShareMenu(postId) {
        document.querySelectorAll('[id^="menu-"]').forEach(menu => {
            menu.classList.add('hidden');
        });
        document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
            if (menu.id !== 'share-menu-' + postId) menu.classList.add('hidden');
        });
        document.getElementById('share-menu-' + postId).classList.toggle('hidden');
    }

    function shareFacebook(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Facebook ƒë·ªÉ chia s·∫ª...');
    }

    function shareZalo(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://zalo.me/share?url=' + encodeURIComponent(url);
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Zalo ƒë·ªÉ chia s·∫ª...');
    }

    function shareTwitter(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Twitter/X ƒë·ªÉ chia s·∫ª...');
    }

    function shareInstagram(postId) {
        showToast('Instagram kh√¥ng h·ªó tr·ª£ chia s·∫ª link tr·ª±c ti·∫øp. Vui l√≤ng copy link v√† d√°n v√†o story/bio!', false);
        copyLink(postId);
    }

    function shareTelegram(postId) {
        const url = window.location.origin + '/post/' + postId;
        const shareUrl = 'https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent('Xem b√†i vi·∫øt n√†y!');
        window.open(shareUrl, '_blank', 'width=600,height=400');
        showToast('ƒêang m·ªü Telegram ƒë·ªÉ chia s·∫ª...');
    }

    async function copyLink(postId) {
        const url = window.location.origin + '/post/' + postId;
        try {
            await navigator.clipboard.writeText(url);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        } catch (err) {
            const textarea = document.createElement('textarea');
            textarea.value = url;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            showToast('ƒê√£ copy link b√†i vi·∫øt!');
        }
    }

    async function reportPost(postId) {
        const reason = prompt('L√Ω do b√°o c√°o b√†i vi·∫øt:');
        if (!reason) return;

        try {
            const formData = new FormData();
            formData.append('reason', reason);

            const res = await fetch(`/report/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            showToast(data.success ? 'ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!' : data.error || 'L·ªói khi b√°o c√°o', !!data.success);
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    async function deletePost(postId) {
        if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')) return;

        try {
            const res = await fetch(`/post/${postId}/delete`, { method: 'POST' });
            if (res.ok) {
                showToast('ƒê√£ x√≥a b√†i vi·∫øt th√†nh c√¥ng!');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Kh√¥ng th·ªÉ x√≥a b√†i vi·∫øt', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• B√ÅO C√ÅO B√åNH LU·∫¨N
    async function reportComment(commentId) {
        const reason = prompt('L√Ω do b√°o c√°o b√¨nh lu·∫≠n n√†y:');
        if (!reason || !reason.trim()) return;

        try {
            const res = await fetch(`/api/comment/${commentId}/report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason.trim() })
            });

            const data = await res.json();

            if (data.success) {
                showToast('ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng!');
            } else {
                showToast(data.error || 'L·ªói khi b√°o c√°o', false);
            }
        } catch (error) {
            console.error('Error reporting comment:', error);
            showToast('L·ªói k·∫øt n·ªëi', false);
        }
    }

    // üî• FIX CH√çNH: ƒê√≥ng menu ch·ªâ khi click HO√ÄN TO√ÄN b√™n ngo√†i
    document.addEventListener('click', function (event) {
        // Ki·ªÉm tra c√≥ click v√†o n√∫t m·ªü menu kh√¥ng
        const clickedMenuButton = event.target.closest('button[onclick^="toggleMenu("]');
        // Ki·ªÉm tra c√≥ click v√†o b√™n trong menu kh√¥ng
        const clickedInsideMenu = event.target.closest('[id^="menu-"]');

        // Ki·ªÉm tra t∆∞∆°ng t·ª± cho share menu
        const clickedShareButton = event.target.closest('button[onclick^="toggleShareMenu("]');
        const clickedInsideShareMenu = event.target.closest('[id^="share-menu-"]');

        // Ch·ªâ ƒë√≥ng n·∫øu KH√îNG click v√†o n√∫t m·ªü HO·∫∂C b√™n trong menu
        if (!clickedMenuButton && !clickedInsideMenu) {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }

        if (!clickedShareButton && !clickedInsideShareMenu) {
            document.querySelectorAll('[id^="share-menu-"]').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
    });

    // Th√™m v√†o ph·∫ßn script c·ªßa trang home
    function trackView(postId) {
        // G·ª≠i request ƒë·∫øn backend ƒë·ªÉ tƒÉng l∆∞·ª£t xem
        fetch(`/track_view/${postId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem tr√™n giao di·ªán
                    const viewElement = document.getElementById(`view-count-${postId}`);
                    if (viewElement) {
                        viewElement.textContent = `${data.views} L∆∞·ª£t xem`;
                    }
                }
            })
            .catch(error => console.error('Error tracking view:', error));
    }

    // Th√™m v√†o ph·∫ßn script c·ªßa trang home
    document.addEventListener('DOMContentLoaded', function () {
        // G·ª≠i request ƒë·ªÉ tƒÉng l∆∞·ª£t xem cho m·ªói b√†i vi·∫øt tr√™n trang home
        {% for post in posts %}
        fetch('/track_home_view/{{ post.id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£t xem tr√™n giao di·ªán
                    const viewElement = document.getElementById(`view-count-{{ post.id }}`);
                    if (viewElement) {
                        viewElement.textContent = `${data.views} L∆∞·ª£t xem`;
                    }
                }
            })
            .catch(error => console.error('Error tracking home view:', error));
        {% endfor %}
    });

    console.log('üéâ Home page with Facebook-style friend system loaded!');
</script>
{% endblock %}