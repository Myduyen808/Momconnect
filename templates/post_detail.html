{% extends "base.html" %}
{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <!-- Header bài viết -->
        <div class="p-8 border-b border-gray-100">
            <div class="flex items-start justify-between mb-6">
                <div class="flex items-center gap-4">
                    <img src="{{ url_for('static', filename=post.author.avatar or 'images/default-avatar.png') }}"
                        class="w-16 h-16 rounded-full object-cover ring-4 ring-pink-200 shadow-lg">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-900">{{ post.author.name }}</h3>
                        <p class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                            <i class="far fa-clock"></i>
                            {{ post.created_at | vietnam_time }}
                            {% if post.is_expert_post %}
                            <span
                                class="ml-3 bg-gradient-to-r from-purple-500 to-blue-600 text-white px-3 py-1 rounded-full text-xs font-bold">
                                <i class="fas fa-stethoscope mr-1"></i> Tư vấn chuyên gia
                            </span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div class="relative">
                    <button onclick="toggleMenu({{ post.id }})" class="p-3 hover:bg-gray-100 rounded-full transition">
                        <i class="fas fa-ellipsis-h text-gray-600 text-xl"></i>
                    </button>
                    <div id="menu-{{ post.id }}"
                        class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border z-30">
                        <button onclick="reportPost({{ post.id }})"
                            class="w-full text-left px-5 py-3 hover:bg-gray-50 flex items-center gap-3 text-red-600">
                                <i class="fas fa-flag"></i> Báo cáo bài viết
                            </button>
                            {% if current_user.id == post.user_id or current_user.role == 'admin' %}
                            <button onclick="deletePost({{ post.id }})"
                                class="w-full text-left px-5 py-3 hover:bg-red-50 flex items-center gap-3 text-red-600">
                                <i class="fas fa-trash"></i> Xóa bài viết
                            </button>
                            {% endif %}
                        </div>
                </div>
            </div>

            <!-- Tiêu đề -->
            <h1 class="text-4xl font-bold text-gray-900 mb-4">{{ post.title }}</h1>

            <!-- Chủ đề -->
            <div class="flex items-center gap-3 mb-6">
                <span class="px-4 py-2 rounded-full text-sm font-medium
                    {% if post.category == 'health' %}bg-green-100 text-green-700
                    {% elif post.category == 'nutrition' %}bg-yellow-100 text-yellow-700
                    {% elif post.category == 'story' %}bg-purple-100 text-purple-700
                    {% elif post.category == 'tips' %}bg-blue-100 text-blue-700
                    {% else %}bg-gray-100 text-gray-700{% endif %}">
                    {{ {'health': 'Sức khỏe', 'nutrition': 'Dinh dưỡng', 'story': 'Tâm sự', 'tips': 'Mẹo hay', 'other': 'Khác'}[post.category] }}
                </span>
            </div>

            <!-- Nội dung -->
            <div class="prose max-w-none text-gray-700 leading-relaxed text-lg mb-8">
                {{ post.content | replace('\n', '<br>') | safe }}
            </div>

            <!-- Media: Nhiều ảnh + Video -->
            {% if post.get_images_list() or post.video %}
            <div class="mb-8 -mx-8">
                {% if post.get_images_list() %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-8">
                    {% for img in post.get_images_list() %}
                    <div class="relative group overflow-hidden rounded-2xl shadow-lg bg-gray-100">
                        <img src="{{ url_for('static', filename='uploads/' ~ img) }}" alt="Ảnh bài viết"
                            class="w-full h-80 object-cover hover:scale-110 transition duration-500 cursor-pointer">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition"></div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if post.video %}
                <div class="px-8 mt-6">
                    <div class="relative rounded-2xl overflow-hidden shadow-2xl bg-black">
                        <video controls class="w-full h-96 object-cover">
                            <source src="{{ url_for('static', filename='uploads/' ~ post.video) }}" type="video/mp4">
                            Trình duyệt của bạn không hỗ trợ video.
                        </video>
                        <div class="absolute top-4 left-4">
                            <span
                                class="bg-red-600 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-2">
                                <i class="fas fa-play-circle"></i> Video
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- ✅ TÁCH RIÊNG: THÍCH & BÌNH LUẬN -->
            <div class="flex items-center justify-between p-6 border-b border-gray-100">
                <div class="flex items-center gap-8">
                    <button onclick="likePost({{ post.id }})" id="like-btn-{{ post.id }}"
                        class="flex items-center gap-3 px-6 py-3 bg-gradient-to-r from-pink-100 to-purple-100 rounded-full hover:shadow-lg transition group">
                        <i class="fas fa-heart text-2xl text-pink-600 group-hover:scale-110 transition" id="like-icon-{{ post.id }}"></i>
                        <span class="font-bold text-pink-700" id="like-count-{{ post.id }}">Thích • {{ post.likes }}</span>
                    </button>

                    <button onclick="focusCommentInput()"
                        class="flex items-center gap-3 px-6 py-3 bg-gray-100 rounded-full hover:bg-gray-200 transition">
                        <i class="fas fa-comment text-2xl text-blue-600"></i>
                        <span class="font-bold text-gray-700" id="comment-count-{{ post.id }}">Bình luận • {{ post.comments_count }}</span>
                    </button>
                </div>

                <!-- ✅ ĐÁNH GIÁ SAO RIÊNG BIỆT -->
                <div class="flex items-center gap-2">
                    <span class="text-lg font-medium text-gray-700">Đánh giá bài viết:</span>
                    <div class="flex items-center gap-1" id="rating-stars-{{ post.id }}">
                        {% for i in range(1, 6) %}
                        <button onclick="ratePost({{ post.id }}, {{ i }})"
                            class="text-3xl hover:scale-125 transition star-btn" data-star="{{ i }}">
                            ★
                        </button>
                        {% endfor %}
                    </div>
                    <span class="text-sm text-gray-600" id="rating-count-{{ post.id }}">({{ post.rating_count|default(0) }} đánh giá)</span>
                </div>
            </div>
        </div>

        <!-- Form bình luận -->
        <div class="p-6 bg-gray-50">
            <div class="flex gap-4">
                <img src="{{ url_for('static', filename=current_user.avatar or 'images/default-avatar.png') }}"
                    class="w-12 h-12 rounded-full ring-4 ring-white shadow">
                <div class="flex-1">
                    <textarea id="comment-input" rows="3" placeholder="Viết bình luận của bạn..."
                        class="w-full px-5 py-4 border border-gray-300 rounded-2xl focus:ring-4 focus:ring-pink-300 focus:border-pink-500 outline-none resize-none"></textarea>
                    <div class="mt-3 flex justify-end">
                        <button onclick="submitComment({{ post.id }})"
                            class="px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-full hover:shadow-xl transition transform hover:scale-105">
                            <i class="fas fa-paper-plane mr-2"></i> Gửi bình luận
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Danh sách bình luận -->
        <div class="p-6" id="comments-container">
            <h3 class="text-2xl font-bold text-gray-800 mb-6">Bình luận (<span id="total-comments">{{ comments|length }}</span>)</h3>
            <div class="space-y-6" id="comments-list">
                {% for comment in comments %}
                <div class="flex gap-4 p-4 bg-gray-50 rounded-2xl hover:bg-gray-100 transition comment-item" data-comment-id="{{ comment.id }}">
                    <img src="{{ url_for('static', filename=comment.author.avatar or 'images/default-avatar.png') }}"
                        class="w-12 h-12 rounded-full ring-4 ring-white shadow">
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-gray-900">{{ comment.author.name }}</h4>
                            <span class="text-sm text-gray-500">{{ comment.created_at | vietnam_time }}</span>
                        </div>
                        <p class="text-gray-700 leading-relaxed">{{ comment.content | replace('\n', '<br>') | safe }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% if not comments %}
            <div class="text-center py-12 text-gray-400">
                <i class="fas fa-comment-slash text-6xl mb-4"></i>
                <p class="text-lg">Chưa có bình luận nào</p>
                <p class="text-sm mt-2">Hãy là người đầu tiên bình luận nhé!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Nút quay lại -->
    <div class="text-center mt-8">
        <a href="{{ url_for('home') }}"
            class="inline-flex items-center gap-2 text-pink-600 hover:text-pink-700 font-bold text-lg">
            <i class="fas fa-arrow-left"></i> Quay lại trang chủ
        </a>
    </div>
</div>

<!-- Toast thông báo -->
<div id="toast" class="hidden fixed top-20 right-4 bg-white border-l-4 border-green-500 shadow-xl rounded-lg p-4 z-50">
    <div class="flex items-center gap-3">
        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        <span id="toast-message" class="font-medium text-gray-800"></span>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo trạng thái đánh giá sao
        const currentRating = {{ post.rating|default(0) }};
        updateStarDisplay({{ post.id }}, currentRating);
    });

    function toggleMenu(postId) {
        document.getElementById(`menu-${postId}`).classList.toggle('hidden');
    }

    async function likePost(postId) {
        try {
            const res = await fetch(`/like/${postId}`, { method: 'POST' });
            const data = await res.json();
            
            const likeCount = document.getElementById(`like-count-${postId}`);
            const likeIcon = document.getElementById(`like-icon-${postId}`);
            
            if (likeCount && data.likes !== undefined) {
                likeCount.textContent = `Thích • ${data.likes}`;
            }
            if (likeIcon) {
                likeIcon.classList.toggle('fas');
                likeIcon.classList.toggle('far');
            }
            
            showToast(data.liked ? 'Đã thích bài viết!' : 'Đã bỏ thích bài viết!', true);
        } catch (error) {
            console.error('Error:', error);
            showToast('Lỗi kết nối', false);
        }
    }

    function focusCommentInput() {
        document.getElementById('comment-input').focus();
    }

    async function submitComment(postId) {
        const content = document.getElementById('comment-input').value.trim();
        if (!content) {
            showToast('Vui lòng nhập nội dung bình luận!', false);
            return;
        }

        try {
            const formData = new FormData();
            formData.append('content', content);

            const res = await fetch(`/comment/${postId}`, {
                method: 'POST',
                body: formData
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById('comment-input').value = '';
                
                // Cập nhật số lượng bình luận
                const commentCount = document.getElementById(`comment-count-${postId}`);
                const totalComments = document.getElementById('total-comments');
                if(commentCount && totalComments) {
                    const currentCount = parseInt(totalComments.textContent);
                    commentCount.textContent = `Bình luận • ${currentCount + 1}`;
                    totalComments.textContent = currentCount + 1;
                }

                // Thêm bình luận mới vào danh sách
                addCommentToTop({
                    author_name: '{{ current_user.name }}',
                    author_avatar: '{{ current_user.avatar or "images/default-avatar.png" }}',
                    content: content,
                    created_at: 'Vừa xong'
                });

                showToast('Đã gửi bình luận thành công!', true);
            } else {
                showToast(data.error || 'Không thể gửi bình luận', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Lỗi kết nối', false);
        }
    }

    function addCommentToTop(comment) {
        const commentsList = document.getElementById('comments-list');
        if (!commentsList) return;

        const newCommentHtml = `
            <div class="flex gap-4 p-4 bg-gray-50 rounded-2xl hover:bg-gray-100 transition comment-item">
                <img src="{{ url_for('static', filename='') }}${comment.author_avatar}" class="w-12 h-12 rounded-full ring-4 ring-white shadow">
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-bold text-gray-900">${comment.author_name}</h4>
                        <span class="text-sm text-gray-500">${comment.created_at}</span>
                    </div>
                    <p class="text-gray-700 leading-relaxed">${comment.content}</p>
                </div>
            </div>
        `;
        commentsList.insertAdjacentHTML('afterbegin', newCommentHtml);
    }

    async function ratePost(postId, rating) {
        try {
            const res = await fetch(`/rate/${postId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ stars: rating })
            });
            const data = await res.json();
            
            if (data.success) {
                // Cập nhật hiển thị sao
                updateStarDisplay(postId, rating);
                
                // Cập nhật số lượng đánh giá
                const ratingCountEl = document.getElementById(`rating-count-${postId}`);
                if (ratingCountEl) {
                    ratingCountEl.textContent = `(${data.rating_count || 1} đánh giá)`;
                }
                
                showToast('Đã đánh giá bài viết!', true);
            } else {
                showToast(data.error || 'Lỗi khi đánh giá', false);
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Lỗi kết nối', false);
        }
    }

    function updateStarDisplay(postId, userRating) {
        const stars = document.querySelectorAll(`#rating-stars-${postId} .star-btn`);
        stars.forEach(star => {
            const starValue = parseInt(star.dataset.star);
            if (starValue <= userRating) {
                star.classList.add('text-yellow-400');
                star.classList.remove('text-gray-300');
            } else {
                star.classList.add('text-gray-300');
                star.classList.remove('text-yellow-400');
            }
        });
    }

    function reportPost(postId) {
        const reason = prompt('Lý do báo cáo bài viết:');
        if (!reason) return;

        const formData = new FormData();
        formData.append('reason', reason);

        fetch(`/report/${postId}`, { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                showToast(data.success ? 'Đã gửi báo cáo!' : data.error, !!data.success);
            });
    }

    function deletePost(postId) {
        if (!confirm('Bạn chắc chắn muốn xóa bài viết này?')) return;
        fetch(`/post/${postId}/delete`, { method: 'POST' })
            .then(() => location.href = '/');
    }

    function showToast(message, isSuccess = true) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const icon = toast.querySelector('i');

        toastMessage.textContent = message;

        if (isSuccess) {
            toast.classList.remove('border-red-500');
            toast.classList.add('border-green-500');
            icon.classList.remove('fa-exclamation-circle', 'text-red-500');
            icon.classList.add('fa-check-circle', 'text-green-500');
        } else {
            toast.classList.remove('border-green-500');
            toast.classList.add('border-red-500');
            icon.classList.remove('fa-check-circle', 'text-green-500');
            icon.classList.add('fa-exclamation-circle', 'text-red-500');
        }

        toast.classList.remove('hidden');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
</script>
{% endblock %}