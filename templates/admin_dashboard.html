<!-- templates/admin_dashboard.html -->
{% extends "base.html" %}
{% block title %}Admin Dashboard - MomConnect{% endblock %}

<style>
    /* Modal styles */
    .modal-overlay {
        position: fixed !important;
        inset: 0 !important;
        background-color: rgba(0, 0, 0, 0.6) !important;
        z-index: 9999 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        padding: 1rem !important;
    }

    .modal-overlay.hidden {
        display: none !important;
    }

    .modal-content {
        background: white !important;
        border-radius: 1.5rem !important;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
        max-width: 42rem !important;
        width: 100% !important;
        padding: 2rem !important;
        position: relative !important;
    }

    /* Ensure modal is on top */
    #userEditModal {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        z-index: 9999 !important;
    }

    /* Tab styles */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .tab-btn {
        border-bottom: 2px solid transparent;
        color: #6b7280;
    }

    .tab-btn.active {
        border-bottom-color: #ec4899;
        color: #ec4899;
    }
</style>

{% block content %}
<div class="max-w-7xl mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 flex items-center">
            <i class="fas fa-crown mr-3 text-red-600"></i>
            Admin Dashboard
        </h1>
        <p class="text-gray-600">Ch√†o m·ª´ng quay l·∫°i, <strong>{{ current_user.name }}</strong>!</p>
    </div>

    <!-- Tabs -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button onclick="showTab('stats')" class="tab-btn active py-4 px-1 border-b-2 font-medium text-sm"
                    data-tab="stats">
                    <i class="fas fa-chart-pie mr-2"></i> Th·ªëng k√™
                </button>
                <button onclick="showTab('users')" class="tab-btn py-4 px-1 border-b-2 font-medium text-sm"
                    data-tab="users">
                    <i class="fas fa-users mr-2"></i> Ng∆∞·ªùi d√πng
                </button>
                <button onclick="showTab('experts')" class="tab-btn py-4 px-1 border-b-2 font-medium text-sm"
                    data-tab="experts">
                    <i class="fas fa-user-check mr-2"></i> Chuy√™n gia
                </button>
                <button onclick="showTab('posts')" class="tab-btn py-4 px-1 border-b-2 font-medium text-sm"
                    data-tab="posts">
                    <i class="fas fa-newspaper mr-2"></i> B√†i vi·∫øt
                </button>
                <button onclick="showTab('reports')" class="tab-btn py-4 px-1 border-b-2 font-medium text-sm"
                    data-tab="reports">
                    <i class="fas fa-flag mr-2"></i> B√°o c√°o
                </button>
            </nav>
        </div>

        <div class="p-6">
            <!-- TAB: Th·ªëng k√™ -->
            <!-- TAB: Th·ªëng k√™ -->
            <div id="stats" class="tab-content">
                <!-- Th·ªëng k√™ t·ªïng quan -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-gradient-to-br from-pink-400 to-purple-600">
                        <i class="fas fa-users text-4xl text-white opacity-80"></i>
                        <p class="text-4xl font-bold text-white">{{ stats.total_users }}</p>
                        <p class="text-white opacity-90">T·ªïng ng∆∞·ªùi d√πng</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-blue-400 to-cyan-600">
                        <i class="fas fa-newspaper text-4xl text-white opacity-80"></i>
                        <p class="text-4xl font-bold text-white">{{ stats.total_posts }}</p>
                        <p class="text-white opacity-90">T·ªïng b√†i vi·∫øt</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-green-400 to-teal-600">
                        <i class="fas fa-user-md text-4xl text-white opacity-80"></i>
                        <p class="text-4xl font-bold text-white">{{ stats.total_experts }}</p>
                        <p class="text-white opacity-90">Chuy√™n gia</p>
                    </div>

                    <div class="stat-card bg-gradient-to-br from-yellow-400 to-orange-600">
                        <i class="fas fa-coins text-4xl text-white opacity-80"></i>
                        <p class="text-4xl font-bold text-white">{{ stats.total_points }}</p>
                        <p class="text-white opacity-90">T·ªïng ƒëi·ªÉm t√≠ch l≈©y</p>
                    </div>
                </div>

                <!-- Th·ªëng k√™ theo ng∆∞·ªùi d√πng -->
                <!-- Th·ªëng k√™ theo ng∆∞·ªùi d√πng -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Th·ªëng k√™ theo ng∆∞·ªùi d√πng</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ID
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Ng∆∞·ªùi d√πng
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Email
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Vai tr√≤
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        ƒêi·ªÉm
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        B√†i vi·∫øt
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        L∆∞·ª£t xem
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        L∆∞·ª£t th√≠ch
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        B√¨nh lu·∫≠n
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Tr·∫°ng th√°i
                                    </th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        H√†nh ƒë·ªông
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for user_stat in user_stats %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        #{{ user_stat.id }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="flex-shrink-0 h-10 w-10">
                                                <img class="h-10 w-10 rounded-full"
                                                    src="{{ url_for('static', filename=user_stat.avatar or 'images/default-avatar.png') }}"
                                                    alt="">
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900">{{ user_stat.name }}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ user_stat.email }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if user_stat.role == 'admin' %}bg-red-100 text-red-800
                            {% elif user_stat.is_verified_expert %}bg-green-100 text-green-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            {% if user_stat.role == 'admin' %}Admin
                                            {% elif user_stat.is_verified_expert %}Chuy√™n gia
                                            {% else %}Ng∆∞·ªùi d√πng{% endif %}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">
                                        {{ user_stat.points }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ user_stat.post_count }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ user_stat.total_views }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ user_stat.total_likes }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        {{ user_stat.total_comments }}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        {% if user_stat.is_active %}
                                        <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">Ho·∫°t
                                            ƒë·ªông</span>
                                        {% else %}
                                        <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs">B·ªã
                                            kh√≥a</span>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="viewUserStats({{ user_stat.id }})"
                                            class="text-indigo-600 hover:text-indigo-900 mr-3">
                                            Xem chi ti·∫øt
                                        </button>
                                        <button type="button"
                                            onclick="openUserEditModal({{ user_stat.id }}, '{{ user_stat.name|replace("'", "\\'") }}', '{{ user_stat.email }}', '{{ user_stat.role }}', {{ user_stat.points }})"
                                            class="text-blue-600 hover:text-blue-800 mr-3" title="Ch·ªânh s·ª≠a">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        {% if user_stat.id != current_user.id %}
                                        {% if user_stat.is_active %}
                                        <a href="{{ url_for('admin_user_action', user_id=user_stat.id, action='block') }}"
                                            class="text-red-600 hover:text-red-800" title="Kh√≥a t√†i kho·∫£n"
                                            onclick="return confirm('Kh√≥a t√†i kho·∫£n {{ user_stat.name }}?')">
                                            <i class="fas fa-ban"></i>
                                        </a>
                                        {% else %}
                                        <a href="{{ url_for('admin_user_action', user_id=user_stat.id, action='unblock') }}"
                                            class="text-green-600 hover:text-green-800" title="M·ªü kh√≥a"
                                            onclick="return confirm('M·ªü kh√≥a t√†i kho·∫£n {{ user_stat.name }}?')">
                                            <i class="fas fa-unlock"></i>
                                        </a>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-gray-400 text-xs">B·∫°n</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Th·ªëng k√™ theo ch·ªß ƒë·ªÅ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Th·ªëng k√™ theo ch·ªß ƒë·ªÅ</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {% set topics = {'health': 'S·ª©c kh·ªèe', 'nutrition': 'Dinh d∆∞·ª°ng', 'story': 'T√¢m s·ª±', 'tips':
                        'M·∫πo hay', 'other': 'Kh√°c'} %}
                        {% for code, name in topics.items() %}
                        <div class="bg-gray-50 rounded-lg p-4 text-center hover:shadow-md transition">
                            <p class="font-medium text-gray-700">{{ name }}</p>
                            <p class="text-3xl font-bold text-pink-600 mt-2">{{ topic_stats.get(code, 0) }}</p>
                            <p class="text-sm text-gray-500">b√†i vi·∫øt</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- TAB: Ng∆∞·ªùi d√πng -->
            <div id="users" class="tab-content hidden">
                {% include 'admin/partials/users.html' with context %}
            </div>

            <!-- TAB: Chuy√™n gia -->
            <div id="experts" class="tab-content hidden">
                {% include 'admin/partials/experts.html' with context %}
            </div>

            <!-- TAB: B√†i vi·∫øt (M·ªöI) -->
            <div id="posts" class="tab-content hidden">
                {% include 'admin/partials/posts.html' with context %}
            </div>

            <!-- TAB: B√°o c√°o -->
            <div id="reports" class="tab-content hidden">
                {% include 'admin/partials/reports.html' with context %}
            </div>
        </div>
    </div>
</div>

<script>
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('active', 'border-pink-600', 'text-pink-600');
            el.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700');
        });
        document.getElementById(tabName).classList.remove('hidden');
        const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
        btn.classList.add('active', 'border-pink-600', 'text-pink-600');
        btn.classList.remove('border-transparent', 'text-gray-500');
    }

    document.addEventListener('DOMContentLoaded', () => {
        showTab('stats');
    });

    // H√†m m·ªü modal xem chi ti·∫øt b√†i vi·∫øt
    function openPostModal(postId, title, content, author, created_at, is_locked, commentCount) {
        document.getElementById('modal_post_id').value = postId;
        document.getElementById('modal_title').textContent = title;
        document.getElementById('modal_author').textContent = author;
        document.getElementById('modal_date').textContent = created_at;
        document.getElementById('modal_content').innerHTML = content.replace(/\n/g, '<br>');
        document.getElementById('modal_comment_count').textContent = commentCount;
        document.getElementById('lock_status').textContent = is_locked ? 'ƒê√£ kh√≥a' : 'B√¨nh th∆∞·ªùng';
        document.getElementById('lock_status').className = is_locked ? 'text-red-600 font-bold' : 'text-green-600 font-bold';

        // Load b√¨nh lu·∫≠n
        fetch(`/admin/post/${postId}/comments`)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                const list = document.getElementById('comments_list');
                list.innerHTML = '';
                document.getElementById('modal_comment_count').textContent = data.total || 0;

                if (!data.comments || data.comments.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-8">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</p>';
                    return;
                }

                data.comments.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 p-4 rounded-lg';

                    let mediaHtml = '';
                    if (c.image) {
                        mediaHtml = `<img src="/static/${c.image}" class="mt-3 max-w-xs rounded cursor-pointer" onclick="openImageModal('/static/${c.image}')">`;
                    } else if (c.video) {
                        mediaHtml = `<video controls class="mt-3 max-w-xs rounded"><source src="/static/${c.video}"></video>`;
                    } else if (c.sticker) {
                        mediaHtml = `<p class="text-5xl mt-3">${c.sticker}</p>`;
                    }

                    div.innerHTML = `
                <div class="flex justify-between">
                    <div>
                        <strong>${c.author.name}</strong>
                        <span class="text-xs text-gray-500 ml-2">${c.created_at}</span>
                        <p class="mt-2">${c.content.replace(/\n/g, '<br>')}</p>
                        ${mediaHtml}
                    </div>
                    <button onclick="deleteComment(${c.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
                    list.appendChild(div);
                });
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('comments_list').innerHTML = '<p class="text-red-500">L·ªói t·∫£i b√¨nh lu·∫≠n!</p>';
            });

        document.getElementById('postDetailModal').classList.remove('hidden');
    }

    function closePostModal() {
        document.getElementById('postDetailModal').classList.add('hidden');
    }

    function deleteComment(commentId, btn) {
        if (!confirm('X√≥a b√¨nh lu·∫≠n n√†y?')) return;
        fetch(`/admin/comment/${commentId}/delete`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    btn.closest('.flex.justify-between').remove();
                    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√¨nh lu·∫≠n
                    const countEl = document.getElementById('modal_comment_count');
                    const currentCount = parseInt(countEl.textContent);
                    countEl.textContent = currentCount - 1;
                } else {
                    alert('L·ªói: ' + (data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'));
                }
            })
            .catch(error => {
                console.error('Error deleting comment:', error);
                alert('L·ªói k·∫øt n·ªëi khi x√≥a b√¨nh lu·∫≠n!');
            });
    }

    // X√≥a b√†i vi·∫øt
    function deletePost(postId) {
        if (!confirm('X√ìA HO√ÄN TO√ÄN b√†i vi·∫øt n√†y? Kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) return;
        fetch(`/admin/post/${postId}/delete`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('L·ªói: ' + data.error);
                }
            });
    }

    // Kh√≥a/M·ªü kh√≥a b√†i vi·∫øt
    function toggleLock(postId, current) {
        const action = current ? 'unlock' : 'lock';
        fetch(`/admin/post/${postId}/${action}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
    }

    // Th√™m h√†m x·ª≠ l√Ω l·ªói chung
    function safeFetch(url, options = {}) {
        return fetch(url, options)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .catch(error => {
                console.error('Fetch error:', error);
                throw error;
            });
    }

    // H√†m xem chi ti·∫øt th·ªëng k√™ ng∆∞·ªùi d√πng
    function viewUserStats(userId) {
        fetch(`/admin/user/${userId}/stats`)
            .then(response => response.json())
            .then(data => {
                // Hi·ªÉn th·ªã modal v·ªõi th√¥ng tin chi ti·∫øt
                document.getElementById('modal_user_name').textContent = data.user.name;
                document.getElementById('modal_user_email').textContent = data.user.email;
                document.getElementById('modal_user_role').textContent =
                    data.user.role === 'admin' ? 'Admin' :
                        data.user.is_verified_expert ? 'Chuy√™n gia' : 'Ng∆∞·ªùi d√πng';
                document.getElementById('modal_user_points').textContent = data.user.points;

                document.getElementById('modal_total_posts').textContent = data.stats.total_posts;
                document.getElementById('modal_total_views').textContent = data.stats.total_views;
                document.getElementById('modal_total_likes').textContent = data.stats.total_likes;
                document.getElementById('modal_total_comments').textContent = data.stats.total_comments;

                // Hi·ªÉn th·ªã danh s√°ch b√†i vi·∫øt
                const postsList = document.getElementById('modal_posts_list');
                postsList.innerHTML = '';

                data.post_stats.forEach(post => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="/post/${post.id}" class="text-indigo-600 hover:text-indigo-900">
                            ${post.title}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${post.views}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${post.likes}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${post.comments}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${post.created_at}
                    </td>
                `;
                    postsList.appendChild(row);
                });

                // Hi·ªÉn th·ªã modal
                document.getElementById('userStatsModal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('L·ªói khi t·∫£i th√¥ng tin th·ªëng k√™!');
            });
    }

    function closeUserStatsModal() {
        document.getElementById('userStatsModal').classList.add('hidden');
    }

    // H√†m m·ªü modal ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
    function openUserEditModal(userId, name, email, role, points) {
        console.log('Opening modal for user:', userId);

        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
        document.getElementById('edit_user_id').value = userId;
        document.getElementById('edit_name').value = name;
        document.getElementById('edit_email').value = email;
        document.getElementById('edit_role').value = role;
        document.getElementById('edit_points').value = points;

        // Hi·ªÉn th·ªã modal
        const modal = document.getElementById('userEditModal');
        modal.classList.remove('hidden');

        // ƒê·∫£m b·∫£o modal hi·ªÉn th·ªã
        setTimeout(() => {
            modal.style.display = 'flex';
        }, 10);

        console.log('Modal should be visible now');
    }

    // H√†m ƒë√≥ng modal ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
    function closeUserEditModal() {
        const modal = document.getElementById('userEditModal');
        modal.classList.add('hidden');
        document.getElementById('userEditForm').reset();
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    document.addEventListener('click', function (event) {
        const modal = document.getElementById('userEditModal');
        if (event.target === modal) {
            closeUserEditModal();
        }
    });

    // X·ª≠ l√Ω submit form ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
    document.addEventListener('DOMContentLoaded', function () {
        const userEditForm = document.getElementById('userEditForm');
        if (userEditForm) {
            userEditForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('Form submitted');

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ƒêang l∆∞u...';
                submitBtn.disabled = true;

                try {
                    const formData = new FormData(this);
                    console.log('FormData:', formData);

                    const res = await fetch('/admin/user/edit', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response status:', res.status);
                    const data = await res.json();
                    console.log('Response data:', data);

                    if (data.success) {
                        alert('‚úÖ C·∫≠p nh·∫≠t ng∆∞·ªùi d√πng th√†nh c√¥ng!');
                        location.reload();
                    } else {
                        alert('‚ùå L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t'));
                    }
                } catch (err) {
                    console.error('Error:', err);
                    alert('‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn server!');
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
        }
    });
</script>
<!-- Modal hi·ªÉn th·ªã chi ti·∫øt th·ªëng k√™ ng∆∞·ªùi d√πng -->
<div id="userStatsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Th·ªëng k√™ chi ti·∫øt ng∆∞·ªùi d√πng</h3>
                <button onclick="closeUserStatsModal()" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-700 mb-2">Th√¥ng tin ng∆∞·ªùi d√πng</h4>
                    <p class="text-sm text-gray-600">T√™n: <span id="modal_user_name" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">Email: <span id="modal_user_email" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">Vai tr√≤: <span id="modal_user_role" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">ƒêi·ªÉm: <span id="modal_user_points" class="font-medium"></span></p>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-medium text-gray-700 mb-2">Th·ªëng k√™ t·ªïng quan</h4>
                    <p class="text-sm text-gray-600">B√†i vi·∫øt: <span id="modal_total_posts" class="font-medium"></span>
                    </p>
                    <p class="text-sm text-gray-600">L∆∞·ª£t xem: <span id="modal_total_views" class="font-medium"></span>
                    </p>
                    <p class="text-sm text-gray-600">L∆∞·ª£t th√≠ch: <span id="modal_total_likes"
                            class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">B√¨nh lu·∫≠n: <span id="modal_total_comments"
                            class="font-medium"></span></p>
                </div>
            </div>

            <div>
                <h4 class="font-medium text-gray-700 mb-2">Th·ªëng k√™ theo b√†i vi·∫øt</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ti√™u ƒë·ªÅ
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    L∆∞·ª£t xem
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    L∆∞·ª£t th√≠ch
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    B√¨nh lu·∫≠n
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ng√†y ƒëƒÉng
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="modal_posts_list">
                            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal ch·ªânh s·ª≠a ng∆∞·ªùi d√πng -->
<div id="userEditModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-user-edit mr-2"></i>Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
            </h3>
            <button type="button" onclick="closeUserEditModal()" class="text-gray-500 hover:text-gray-700 text-3xl">
                &times;
            </button>
        </div>

        <form id="userEditForm" enctype="multipart/form-data">
            <input type="hidden" name="user_id" id="edit_user_id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1"></i>T√™n
                    </label>
                    <input type="text" name="name" id="edit_name" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-4 focus:ring-pink-300 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-1"></i>Email
                    </label>
                    <input type="email" name="email" id="edit_email" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-4 focus:ring-pink-300 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-shield-alt mr-1"></i>Vai tr√≤
                    </label>
                    <select name="role" id="edit_role"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-4 focus:ring-pink-300 outline-none">
                        <option value="user">Ng∆∞·ªùi d√πng</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-coins mr-1"></i>ƒêi·ªÉm t√≠ch l≈©y
                    </label>
                    <input type="number" name="points" id="edit_points" min="0" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-4 focus:ring-pink-300 outline-none">
                </div>
            </div>

            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-image mr-1"></i>Avatar m·ªõi (t√πy ch·ªçn)
                </label>
                <input type="file" name="avatar" accept="image/*"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                <p class="text-xs text-gray-500 mt-2">ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën thay ƒë·ªïi</p>
            </div>

            <div class="mt-8 flex justify-end gap-4">
                <button type="button" onclick="closeUserEditModal()"
                    class="px-6 py-3 bg-gray-200 text-gray-700 rounded-full font-bold hover:bg-gray-300 transition">
                    <i class="fas fa-times mr-2"></i>H·ªßy
                </button>
                <button type="submit"
                    class="px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full font-bold hover:shadow-xl transition">
                    <i class="fas fa-save mr-2"></i>L∆∞u thay ƒë·ªïi
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

<!-- admin_dashboard.html - TH√äM V√ÄO MODAL XEM CHI TI·∫æT -->
<button onclick="viewOCRInfo({{ req.id }})" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
    <i class="fas fa-robot mr-2"></i>Xem th√¥ng tin t·ª± ƒë·ªông
</button>

<script>
    async function viewOCRInfo(reqId) {
        try {
            const res = await fetch(`/admin/expert-request/${reqId}/ocr-info`);
            const data = await res.json();

            if (data.success) {
                const info = data.parsed_info;
                let html = `
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">ü§ñ Th√¥ng tin t·ª± ƒë·ªông ƒë·ªçc t·ª´ ch·ª©ng ch·ªâ:</h4>
                    <ul class="space-y-2">
                        <li><strong>T√™n:</strong> ${info.name || 'Kh√¥ng ph√°t hi·ªán'}</li>
                        <li><strong>S·ªë ch·ª©ng ch·ªâ:</strong> ${info.cert_number || 'Kh√¥ng ph√°t hi·ªán'}</li>
                        <li><strong>Chuy√™n m√¥n:</strong> ${info.specialty || 'Kh√¥ng ph√°t hi·ªán'}</li>
                        <li><strong>C∆° quan c·∫•p:</strong> ${info.issue_org || 'Kh√¥ng ph√°t hi·ªán'}</li>
                        <li><strong>Ng√†y c·∫•p:</strong> ${info.issue_date || 'Kh√¥ng ph√°t hi·ªán'}</li>
                        <li><strong>Ng√†y h·∫øt h·∫°n:</strong> ${info.expiry_date || 'Kh√¥ng ph√°t hi·ªán'}</li>
                    </ul>
                </div>
                
                <details class="mt-4">
                    <summary class="cursor-pointer font-bold text-gray-700">Xem text g·ªëc</summary>
                    <pre class="mt-2 p-4 bg-gray-100 rounded text-xs overflow-auto max-h-60">${data.raw_text}</pre>
                </details>
            `;

                // Hi·ªÉn th·ªã trong modal ho·∫∑c alert
                showModal('Th√¥ng tin OCR', html);
            } else {
                alert('Kh√¥ng th·ªÉ ƒë·ªçc th√¥ng tin t·ª´ ch·ª©ng ch·ªâ');
            }
        } catch (error) {
            alert('L·ªói k·∫øt n·ªëi!');
        }
    }

    function showModal(title, content) {
        // T·∫°o modal ƒë·ªông
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-t-xl flex justify-between items-center">
                <h3 class="text-xl font-bold">${title}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6">${content}</div>
        </div>
    `;
        document.body.appendChild(modal);
    }
</script>