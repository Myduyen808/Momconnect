{% extends "base.html" %}
{% block title %}Th√¥ng b√°o{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
  <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
    <h2 class="text-2xl font-bold text-pink-600 mb-4 flex items-center gap-2">
      <i class="fas fa-bell"></i> Th√¥ng b√°o c·ªßa b·∫°n
    </h2>

    {% if notifications|length == 0 %}
      <div class="text-center py-12 text-gray-500">
        <i class="fas fa-bell-slash text-6xl text-gray-300 mb-4"></i>
        <p class="text-lg">Ch∆∞a c√≥ th√¥ng b√°o n√†o</p>
      </div>
    {% else %}
      <div class="space-y-3 max-h-[70vh] overflow-y-auto" id="notifications-container">
        {% for notif in notifications %}
        <!-- Th√™m data-notif-id v√† href="#notif-{{ notif.id }}" -->
        <a href="{{ notif.redirect_url or '#notif-' ~ notif.id }}"
           class="notification-item block"
           data-notif-id="{{ notif.id }}"
           onclick="{% if not notif.is_read %}markNotificationAsRead({{ notif.id }});{% endif %}handleNotificationClick({{ notif.id }});">
          
          <div id="notif-{{ notif.id }}"
               class="notification-card flex items-start gap-3 p-4 rounded-xl border transition-all duration-300 group
               {% if not notif.is_read %}
                 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200 shadow-sm
               {% else %}
                 bg-gray-50 border-gray-200 hover:bg-gray-100
               {% endif %}">

            <!-- Avatar -->
            <img src="{{ url_for('static', filename=notif.related_user.avatar if notif.related_user and notif.related_user.avatar else 'images/default-avatar.png') }}"
                 class="w-12 h-12 rounded-full object-cover ring-2 ring-white shadow-md flex-shrink-0
                 {% if notif.related_user.is_verified_expert %}ring-blue-300{% endif %}">

            <!-- N·ªôi dung -->
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between mb-1">
                <p class="font-semibold text-gray-900 text-sm leading-tight group-hover:text-pink-600 transition">
                  {{ notif.title }}
                </p>
                {% if not notif.is_read %}
                <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse ml-2 flex-shrink-0"></div>
                {% endif %}
              </div>
              
              <p class="text-sm text-gray-600 leading-relaxed mb-2">{{ notif.message }}</p>
              
              <p class="text-xs text-gray-400 flex items-center gap-1">
                <i class="fas fa-clock"></i> {{ notif.created_at.strftime('%H:%M %d/%m') }}
              </p>
            </div>

            <!-- Icon lo·∫°i th√¥ng b√°o -->
            <div class="flex flex-col items-end gap-1 flex-shrink-0 ml-2">
              {% if notif.type == 'point' %}
                <i class="fas fa-coins text-yellow-500 text-xl opacity-80"></i>
              {% elif notif.type == 'like' %}
                <i class="fas fa-heart text-red-500 text-xl opacity-80"></i>
              {% elif notif.type == 'comment' %}
                <i class="fas fa-comment text-blue-500 text-xl opacity-80"></i>
              {% elif notif.type == 'follow' %}
                <i class="fas fa-user-plus text-green-500 text-xl opacity-80"></i>
              {% elif notif.type == 'friend_request' %}
                <i class="fas fa-user-check text-purple-500 text-xl opacity-80"></i>
              {% elif notif.type == 'expert_request' or notif.type == 'expert_approved' or notif.type == 'expert_rejected' %}
                <i class="fas fa-user-graduate text-purple-500 text-xl opacity-80"></i>
              {% elif notif.type == 'expert_unlock' %}
                <i class="fas fa-unlock text-green-500 text-xl opacity-80"></i>
              {% elif notif.type == 'level_up' %}
                <i class="fas fa-level-up-alt text-green-500 text-xl opacity-80"></i>
              {% else %}
                <i class="fas fa-bell text-gray-400 text-xl opacity-80"></i>
              {% endif %}
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>

<style>
/* HIGHLIGHT & ANIMATION */
.notification-card.highlight {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
  border-color: #f59e0b !important;
  box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3), 0 0 0 3px rgba(245, 158, 11, 0.2) !important;
  transform: scale(1.02);
  animation: notificationPulse 0.6s ease-out;
}

@keyframes notificationPulse {
  0% { transform: scale(1) rotateX(0deg); }
  50% { transform: scale(1.05) rotateX(2deg); }
  100% { transform: scale(1.02) rotateX(0deg); }
}

.notification-card.read-highlight {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%) !important;
  border-color: #3b82f6 !important;
  box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2) !important;
}

/* Smooth scroll */
#notifications-container {
  scroll-behavior: smooth;
}

/* Hover effect */
.notification-item:hover .notification-card {
  transform: translateX(4px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}
</style>

<script>
let currentHighlightedNotif = null;

// X·ª¨ L√ù CLICK TH√îNG B√ÅO
function handleNotificationClick(notifId) {
  console.log('Clicked notification:', notifId);
  
  // Clear previous highlight
  if (currentHighlightedNotif) {
    const prevCard = document.getElementById(`notif-${currentHighlightedNotif}`);
    if (prevCard) {
      prevCard.classList.remove('highlight', 'read-highlight');
    }
  }
  
  // Highlight notification m·ªõi
  const notifCard = document.getElementById(`notif-${notifId}`);
  if (notifCard) {
    notifCard.classList.add('highlight');
    currentHighlightedNotif = notifId;
    
    // Auto remove highlight sau 3s
    setTimeout(() => {
      notifCard.classList.remove('highlight');
      if (notifCard.querySelector('.bg-gradient-to-r')) {
        notifCard.classList.add('read-highlight');
      }
    }, 3000);
  }
}

// MARK AS READ
async function markNotificationAsRead(id) {
  try {
    const response = await fetch(`/api/notifications/${id}/read`, { 
      method: "POST",
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    
    if (response.ok) {
      const notifCard = document.getElementById(`notif-${id}`);
      if (notifCard) {
        // Update UI ngay l·∫≠p t·ª©c
        notifCard.className = notifCard.className.replace(/bg-(blue|gradient-to-r).*?border-(blue|gradient-to-r)/g, '')
                          .replace(/bg-blue-50.*?border-blue-200/g, 'bg-gray-50 border-gray-200')
                          .replace(/shadow-sm/g, '');
        
        // Remove unread dot
        const dot = notifCard.querySelector('.bg-blue-500');
        if (dot) dot.remove();
      }
    }
  } catch (error) {
    console.error('Error marking notification as read:', error);
  }
}

// AUTO SCROLL KHI TRUY·ªÄN #notif-ID t·ª´ URL
document.addEventListener("DOMContentLoaded", () => {
  // Ki·ªÉm tra URL hash
  function checkHashAndScroll() {
    const hash = location.hash;
    if (hash && hash.startsWith('#notif-')) {
      const notifId = hash.replace('#notif-', '');
      const targetEl = document.getElementById(`notif-${notifId}`);
      
      if (targetEl) {
        // Scroll m∆∞·ª£t m√† v√†o gi·ªØa m√†n h√¨nh
        targetEl.scrollIntoView({ 
          behavior: "smooth", 
          block: "center",
          inline: "nearest"
        });
        
        // Highlight
        targetEl.classList.add('highlight');
        handleNotificationClick(notifId);
        
        // Update URL kh√¥ng reload
        history.replaceState(null, null, `#notif-${notifId}`);
        
        // Auto remove highlight sau 4s
        setTimeout(() => {
          targetEl.classList.remove('highlight');
        }, 4000);
      }
    }
  }
  
  // Ch·∫°y ngay
  checkHashAndScroll();
  
  // Watch hash change (khi click notification kh√°c)
  let lastHash = location.hash;
  setInterval(() => {
    if (location.hash !== lastHash) {
      lastHash = location.hash;
      checkHashAndScroll();
    }
  }, 100);
  
  // Smooth scroll cho container
  const container = document.getElementById('notifications-container');
  if (container) {
    container.addEventListener('scroll', () => {
      // Auto remove highlight khi scroll xa
      if (currentHighlightedNotif) {
        const highlightedEl = document.getElementById(`notif-${currentHighlightedNotif}`);
        const rect = highlightedEl?.getBoundingClientRect();
        if (rect && (rect.top < -100 || rect.bottom > window.innerHeight + 100)) {
          highlightedEl?.classList.remove('highlight');
        }
      }
    });
  }
});

// BACK TO TOP khi scroll xa
window.addEventListener('scroll', () => {
  const container = document.getElementById('notifications-container');
  if (container && container.scrollTop > 300) {
    // C√≥ th·ªÉ th√™m n√∫t back to top ·ªü ƒë√¢y
  }
});

console.log('üéâ Notification system with auto-scroll & highlight loaded!');
</script>
{% endblock %}