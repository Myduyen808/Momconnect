{% extends "base.html" %}
{% block title %}Hồ sơ cá nhân{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-2xl shadow-xl p-8">

        <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">Hồ sơ cá nhân</h1>

        <a href="{{ url_for('home') }}"
            class="text-pink-600 hover:text-pink-700 font-medium mb-6 inline-block">
            ← Quay lại trang chủ
        </a>

        <!-- AVATAR -->
        <div class="text-center mb-8">
            <div class="relative inline-block group">
                <img src="{{ url_for('static', filename=user.avatar or 'images/default-avatar.png') }}"
                    class="w-32 h-32 rounded-full object-cover ring-8 ring-pink-100 shadow-2xl mx-auto">
                <label
                    class="absolute -bottom-2 -right-2 bg-white p-3 rounded-full shadow-lg cursor-pointer hover:shadow-xl transition border-4 border-pink-200 group-hover:border-pink-400">
                    <i class="fas fa-camera text-pink-600 text-xl"></i>
                    <input type="file" name="avatar" accept="image/*" form="profileForm" class="hidden">
                </label>
            </div>
            <p class="mt-4 text-sm text-gray-500">Click biểu tượng máy ảnh để thay avatar</p>
        </div>

        <!-- CẤP BẬC -->
        <div class="text-center mb-10">
            <div class="inline-flex flex-col items-center gap-3 px-10 py-6 rounded-3xl shadow-2xl
                bg-gradient-to-br from-green-400 to-teal-500 text-white">
                <i class="fas fa-medal text-6xl mb-2"></i>
                <p class="text-4xl font-bold">{{ user.badge }}</p>
                <p class="text-xl opacity-80">{{ user.name }}</p>
                <p class="text-lg opacity-90">{{ user.points }} điểm</p>
            </div>
        </div>

        <!-- NỘP ĐƠN CHUYÊN GIA (KHÔNG ĐIỀU KIỆN) -->
        {% if not user.is_verified_expert %}
        <div
            class="bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-300 rounded-2xl p-6 text-center mb-10">
            <i class="fas fa-crown text-4xl text-purple-600 mb-3"></i>
            <h3 class="text-xl font-bold text-purple-800 mb-2">
                Bạn muốn trở thành Chuyên gia?
            </h3>
            <p class="text-gray-700 mb-4">
                Gửi bằng cấp / chứng chỉ để Admin xác thực
            </p>
            <a href="{{ url_for('expert_request') }}"
                class="inline-block bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-3 rounded-full font-bold hover:shadow-xl">
                <i class="fas fa-paper-plane mr-2"></i> Nộp đơn ngay
            </a>
        </div>
        {% endif %}

        <!-- FORM THÔNG TIN CƠ BẢN -->
        <form id="profileForm" method="POST" enctype="multipart/form-data" class="space-y-6">

            <!-- TÊN -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1"></i> Tên hiển thị
                </label>
                <input type="text" name="name" value="{{ user.name }}" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500">
            </div>

            <!-- ✅ EMAIL (CHỈ XEM, KHÔNG ĐỔI Ở ĐÂY) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-envelope mr-1"></i> Email
                </label>
                <div class="relative">
                    <input type="email" value="{{ user.email }}" disabled
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-600 cursor-not-allowed">
                    <button type="button" onclick="openChangeEmailModal()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-pink-600 hover:text-pink-800 font-medium">
                        <i class="fas fa-edit mr-1"></i> Đổi
                    </button>
                </div>
            </div>

            <!-- ✅ MẬT KHẨU (CHỈ HIỆN NÚT ĐỔI) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-lock mr-1"></i> Mật khẩu
                </label>
                <div class="relative">
                    <input type="password" value="********" disabled
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100 text-gray-600 cursor-not-allowed">
                    <button type="button" onclick="openChangePasswordModal()"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-pink-600 hover:text-pink-800 font-medium">
                        <i class="fas fa-edit mr-1"></i> Đổi
                    </button>
                </div>
            </div>

            <!-- SỐ CON + ĐỘ TUỔI -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-child mr-1"></i> Số con
                    </label>
                    <input type="number" name="children_count"
                        value="{{ user.children_count or 0 }}"
                        min="0" max="10"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-birthday-cake mr-1"></i> Độ tuổi con
                    </label>
                    <input type="text" name="children_ages"
                        value="{{ user.children_ages or '' }}"
                        placeholder="VD: 3 tuổi, 5 tuổi"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500">
                </div>
            </div>

            <!-- BIO -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-pen mr-1"></i> Giới thiệu bản thân
                </label>
                <textarea name="bio" rows="5"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500 resize-none"
                    placeholder="Chia sẻ hành trình làm mẹ, kinh nghiệm nuôi con, sở thích...">{{ user.bio or '' }}</textarea>
                <p class="text-xs text-gray-500 mt-1">
                    Miêu tả ngắn giúp bạn bè hiểu thêm về bạn
                </p>
            </div>

            <!-- SAVE -->
            <button type="submit"
                class="w-full py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-xl text-xl hover:shadow-2xl transition">
                <i class="fas fa-save mr-2"></i> Lưu thay đổi
            </button>

        </form>
    </div>
</div>

<!-- ✅ MODAL ĐỔI EMAIL -->
<div id="changeEmailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Đổi Email</h3>
        <form id="changeEmailForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email mới</label>
                <input type="email" name="new_email" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                    placeholder="Nhập email mới">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu hiện tại (xác nhận)</label>
                <input type="password" name="current_password" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                    placeholder="Nhập mật khẩu để xác nhận">
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeChangeEmailModal()"
                    class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">
                    Hủy
                </button>
                <button type="submit"
                    class="flex-1 py-3 bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition">
                    Đổi Email
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ✅ MODAL ĐỔI MẬT KHẨU -->
<div id="changePasswordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Đổi mật khẩu</h3>
        <form id="changePasswordForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu hiện tại</label>
                <input type="password" name="current_password" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                    placeholder="Nhập mật khẩu hiện tại">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mật khẩu mới</label>
                <input type="password" name="new_password" required minlength="6"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                    placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Xác nhận mật khẩu mới</label>
                <input type="password" name="confirm_password" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-pink-500"
                    placeholder="Nhập lại mật khẩu mới">
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeChangePasswordModal()"
                    class="flex-1 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition">
                    Hủy
                </button>
                <button type="submit"
                    class="flex-1 py-3 bg-pink-600 text-white rounded-xl hover:bg-pink-700 transition">
                    Đổi mật khẩu
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
// ===== CHỐNG CACHE AVATAR =====
document.getElementById('profileForm').addEventListener('submit', function () {
    setTimeout(() => {
        const imgs = document.querySelectorAll('img');
        imgs.forEach(img => {
            if (img.src.includes('avatar') || img.src.includes('default-avatar')) {
                img.src = img.src.split('?')[0] + '?t=' + new Date().getTime();
            }
        });
        setTimeout(() => location.reload(), 1200);
    }, 800);
});

// ===== MODAL ĐỔI EMAIL =====
function openChangeEmailModal() {
    document.getElementById('changeEmailModal').classList.remove('hidden');
}
function closeChangeEmailModal() {
    document.getElementById('changeEmailModal').classList.add('hidden');
}

// ===== MODAL ĐỔI MẬT KHẨU =====
function openChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('hidden');
}
function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('hidden');
}

// ===== XỬ LÝ ĐỔI EMAIL =====
document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/profile/change-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                new_email: formData.get('new_email'),
                current_password: formData.get('current_password')
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Đổi email thành công!');
            closeChangeEmailModal();
            location.reload();
        } else {
            alert('❌ Lỗi: ' + data.error);
        }
    } catch (error) {
        alert('❌ Có lỗi xảy ra: ' + error);
    }
});

// ===== XỬ LÝ ĐỔI MẬT KHẨU =====
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    if (newPassword !== confirmPassword) {
        alert('❌ Mật khẩu xác nhận không khớp!');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('❌ Mật khẩu phải có ít nhất 6 ký tự!');
        return;
    }
    
    try {
        const response = await fetch('/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                current_password: formData.get('current_password'),
                new_password: newPassword
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('✅ Đổi mật khẩu thành công!');
            closeChangePasswordModal();
            this.reset();
        } else {
            alert('❌ Lỗi: ' + data.error);
        }
    } catch (error) {
        alert('❌ Có lỗi xảy ra: ' + error);
    }
});
</script>
{% endblock %}