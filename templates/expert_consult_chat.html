{% extends "base.html" %}

{% block title %}Chat tư vấn với {{ expert.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header -->
    <div
        class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 rounded-t-2xl shadow-lg flex items-center gap-4">
        <img src="{{ url_for('static', filename=expert.avatar or 'images/default-avatar.png') }}"
            alt="{{ expert.name }}" class="w-16 h-16 rounded-full border-4 border-white object-cover">
        <div>
            <h1 class="text-2xl font-bold">{{ expert.name }}</h1>
            <p class="text-purple-100">{{ expert.expert_category or 'Chuyên gia tư vấn' }}</p>
            <p class="text-sm mt-1">
                <i
                    class="fas fa-circle {{ 'text-green-400' if expert.availability == 'available' else 'text-red-400' }} mr-1"></i>
                {{ 'Đang online' if expert.availability == 'available' else 'Đang bận' }}
            </p>
        </div>
    </div>

    <!-- Chat Box -->
    <div id="chatBox" class="bg-white rounded-b-2xl shadow-lg p-6 h-96 overflow-y-auto flex flex-col gap-4">
        {% for msg in messages %}
        <div class="flex {{ 'justify-end' if msg.sender_id == current_user.id else 'justify-start' }}">
            <div
                class="max-w-xs px-4 py-3 rounded-2xl {{ 'bg-purple-600 text-white' if msg.sender_id == current_user.id else 'bg-gray-200 text-gray-800' }}">
                <p>{{ msg.content }}</p>
                <span class="text-xs opacity-70 block mt-1 text-right">
                    {{ msg.timestamp.strftime('%H:%M %d/%m') }}
                </span>
            </div>
        </div>
        <!-- Typing indicator -->
        <div id="typingIndicator" class="hidden flex items-center gap-2 text-gray-500 italic">
            <div class="flex gap-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
            <span>Đang gõ...</span>
        </div>
        {% endfor %}
    </div>

    <!-- Input Box -->
    <div class="mt-4 flex gap-3 items-center">
        <input id="messageInput" type="text"
            class="flex-1 px-5 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Nhập tin nhắn tư vấn...">

        <!-- Nút gửi ảnh -->
        <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 p-3 rounded-full transition">
            <i class="fas fa-image text-purple-600 text-xl"></i>
            <input type="file" id="imageInput" accept="image/*" class="hidden">
        </label>

        <button id="sendBtn"
            class="bg-purple-600 text-white px-6 py-3 rounded-full font-bold hover:bg-purple-700 transition">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<!-- SOCKET.IO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
<script>
    const socket = io();

    // Đăng ký user_id khi connect
    socket.on('connect', () => {
        socket.emit('register_user', { user_id: {{ current_user.id }} });
    });

    // Gửi tin nhắn
    document.getElementById('sendBtn').onclick = () => {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (content) {
            socket.emit('send_consult_message', {
                sender_id: {{ current_user.id }},
        receiver_id: { { expert.id } },
        content: content
    });
    input.value = '';
        }
    };

    // Nhận tin nhắn realtime
    socket.on('receive_consult_message', (data) => {
        const chatBox = document.getElementById('chatBox');
        const isMe = data.sender_id === {{ current_user.id }
    };

    const msgDiv = document.createElement('div');
    msgDiv.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;

    let contentHtml = '';
    if (data.type === 'image') {
        contentHtml = `<img src="${data.content}" class="max-w-full rounded-lg shadow" alt="Ảnh chat">`;
    } else {
        contentHtml = `<p>${data.content}</p>`;
    }

    msgDiv.innerHTML = `
        <div class="max-w-xs px-4 py-3 rounded-2xl ${isMe ? 'bg-purple-600 text-white' : 'bg-gray-200 text-gray-800'}">
            ${contentHtml}
            <span class="text-xs opacity-70 block mt-1 text-right">
                ${new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' })}
            </span>
        </div>
    `;

    chatBox.appendChild(msgDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
});
    // Typing indicator
    let typingTimeout;
    document.getElementById('messageInput').addEventListener('input', () => {
        socket.emit('typing', {
            sender_id: {{ current_user.id }},
        receiver_id: {{ expert.id }}
        });

    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => {
        socket.emit('stop_typing', {
            sender_id: {{ current_user.id }},
        receiver_id: {{ expert.id }}
            });
        }, 2000);
    });

    // Nhận typing từ người kia
    socket.on('user_typing', (data) => {
        if (data.sender_id === {{ expert.id }
    }) {
        document.getElementById('typingIndicator').classList.remove('hidden');
    }
    });

    socket.on('user_stop_typing', (data) => {
        if (data.sender_id === {{ expert.id }
    }) {
        document.getElementById('typingIndicator').classList.add('hidden');
    }
    });
    document.getElementById('sendBtn').onclick = () => sendMessage();
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();

        if (content) {
            socket.emit('send_consult_message', {
                sender_id: {{ current_user.id }},
        receiver_id: { { expert.id } },
        content: content,
            type: 'text'
    });
    input.value = '';
    }
}

    // Xử lý gửi ảnh
    document.getElementById('imageInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
            const res = await fetch('/upload_chat_image', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.success) {
                socket.emit('send_consult_message', {
                    sender_id: {{ current_user.id }},
            receiver_id: { { expert.id } },
            content: data.image_url,
                type: 'image'
        });
        } else {
        alert('Lỗi upload ảnh');
    }
    } catch (err) {
        alert('Lỗi kết nối');
    }
});
</script>
{% endblock %}